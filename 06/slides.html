<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Veljko Petrović">
  <title>Operativni Sistemi - Simulator operativnog sistema 2</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4//dist/reset.css">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4//dist/reveal.css">
  <style>
    .reveal .sourceCode {  /* see #7635 */
      overflow: visible;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4//dist/theme/night.css" id="theme">
  <link rel="stylesheet" href="slides.css"/>
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section id="title-slide">
  <h1 class="title">Operativni Sistemi - Simulator operativnog sistema
2</h1>
  <p class="author">Veljko Petrović</p>
  <p class="date">April, 2024</p>
</section>

<section>
<section id="virtuelna-mašina-simulatora"
class="title-slide slide level1">
<h1>Virtuelna Mašina Simulatora</h1>

</section>
<section id="upozorenje" class="slide level2">
<h2>Upozorenje</h2>
<ul>
<li>Termin ‘virtuelna mašina’ se koristi u više značenja u računarskim
naukama</li>
<li>Značenje kako ga koristimo ovde nije nijedno od onih na koje ste vi
navikli</li>
<li>Znači, u ovom slučaju, više <em>simulator</em> hardvera.</li>
</ul>
</section>
<section id="vm" class="slide level2">
<h2>VM</h2>
<ul>
<li>Razvojna verzija konkurentne biblioteke CppTss sadrži virtuelnu
mašinu koja za potrebe ostatka ove biblioteke:
<ul>
<li>emulira kontrolere tastature, ekrana i diska</li>
<li>emulira mehanizam prekida</li>
<li>podržava okončanje izvršavanja konkurentnog programa</li>
<li>podržava rukovanje pojedinim bitima memorijskih lokacija</li>
<li>podržava rukovanje numeričkim koprocesorom (Numeric Processor
Extension – NPX)</li>
<li>podržava rukovanje stekom</li>
</ul></li>
</ul>
</section>
<section id="neophodna-zaglavlja" class="slide level2">
<h2>Neophodna zaglavlja</h2>
<div class="sourceCode" id="cb1" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1"></a>    <span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>    <span class="pp">#include </span><span class="im">&lt;strings.h&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>    <span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>    <span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>    <span class="pp">#include </span><span class="im">&lt;termios.h&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    <span class="pp">#include </span><span class="im">&lt;signal.h&gt;</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>    <span class="pp">#include </span><span class="im">&lt;sys/time.h&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>    <span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>    <span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span></code></pre></div>
</section>
<section id="emulacija-mehanizma-prekida" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Emulacija mehanizma prekida se zasniva na:
<ul>
<li>uvođenju (emulirane) tabele prekida</li>
<li>uvođenju (emuliranog) bita prekida<br />
</li>
<li>obezbeđenju nezavisnosti (asinhronosti) između prekida i izvršavanja
konkurentnog programa</li>
</ul></li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-1" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Potrebe CppTss biblioteke su uzrokovale da (emulirana) tabela
prekida sadrži pet elemenata.</li>
<li>Prvi od njih je namenjen za vektor obrađivača hardverskog izuzetka
(<code>FLOATING POINT EXCEPTION</code>), a drugi je rezervisan za vektor
obrađivača prekida sata.</li>
<li>Preostala tri su predviđena za vektore obrađivača prekida tastature,
ekrana i diska.</li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-2" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<div class="sourceCode" id="cb2" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1"></a><span class="at">static</span> <span class="at">const</span> <span class="dt">unsigned</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>INTERRUPT_TABLE_VECTOR_COUNT <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">enum</span> Vector_numbers <span class="op">{</span> FP_EXCEPTION<span class="op">,</span> TIMER<span class="op">,</span> KEYBOARD<span class="op">,</span> DISPLAY<span class="op">,</span> DISK <span class="op">};</span></span></code></pre></div>
</section>
<section id="emulacija-mehanizma-prekida-3" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Svrha (emuliranog) bita prekida je da označi da li je ili nije
omogućena obrada prekida. Ovakav bit zaista postoji u <code>FLAGS</code>
registru, recimo, x86 procesora i kontroliše se sa <code>sti</code> i
<code>cli</code> instrukcijama.</li>
<li>Emulacija bita prekida je ostvarena pomoću promenljive
<code>interrupts_enabled</code> i funkcija
<code>ad__disable_interrupt()</code> i
<code>ad__restore_interrupts()</code>.</li>
<li>Promenljiva <code>interrupts_enabled</code> sadrži (emulirani) bit
prekida. Njena vrednost određuje da li su (emulirani) prekidi omogućeni
(konstanta true) ili ne.</li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-4" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Prva od njih, izmenom (emuliranog) bita prekida, onemogućuje
(emulirane) prekide, a druga poništava efekte prve, vraćajući
(emulirani) bit prekida u prethodno stanje.</li>
<li>Kada operacija <code>ad__restore_interrupts()</code> utvrdi da je
došlo do odlaganja obrade (emuliranih) prekida
(<code>Interrupt::pending</code>), ona pokreće prethodno odloženu
emulaciju kontrolera pozivom operacije
<code>controller_emulator()</code> klase <code>Interrupt</code>.</li>
<li>Nakon toga se registruje da nema više odloženih obrada (emuliranih)
prekida.</li>
</ul>
</section>
<section id="emulacija-prekida" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb3" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1"></a><span class="dt">bool</span> interrupts_enabled <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">inline</span> <span class="at">static</span> <span class="dt">bool</span> ad__disable_interrupts<span class="op">(){</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="dt">bool</span> saved_interrupts_enabled <span class="op">=</span> interrupts_enabled<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    interrupts_enabled <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>    <span class="cf">return</span> saved_interrupts_enabled<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-1" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb4" data-startFrom="7"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 6;"><span id="cb4-7"><a href="#cb4-7"></a><span class="kw">inline</span> <span class="dt">void</span> ad__restore_interrupts<span class="op">(</span><span class="dt">bool</span> saved_interrupts_enabled<span class="op">){</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>    <span class="cf">if</span><span class="op">(</span>saved_interrupts_enabled <span class="op">&amp;&amp;</span> interrupt<span class="op">.</span>pending<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>        interrupt<span class="op">.</span>controller_emulator<span class="op">();</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>        interrupt<span class="op">.</span>pending <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    <span class="op">}</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>    interrupts_enabled <span class="op">=</span> saved_interrupts_enabled<span class="op">;</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="emulacija-mehanizma-prekida-5" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Nezavisnost (emuliranih) prekida od izvršavanja konkurentnog
programa se ostvaruje pomoću mehanizma signala Linux-a.</li>
<li>Ovaj mehanizam omogućuje da se na pojavu signala reaguje
izvršavanjem odabrane funkcije (user level exception handling).</li>
<li>Ova funkcija se naziva obrađivač signala.</li>
<li>Signali su unapred definisani, a svaki od njih je pridružen jednoj
vrsti događaja, kao što je isticanje zadanog vremenskog intervala
(SIGVTALRM) ili pojava hardverskog izuzetka (SIGFPE).</li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-6" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Kada se takav događaj desi mehanizam signala zaustavi izvršavanje
programa (u toku koga se desio dotični događaj), radi pokretanja
izvršavanja odgovarajućeg obrađivača signala.</li>
<li>Nakon obrade dotičnog signala moguć je nastavak zaustavljenog
izvršavanja programa.</li>
<li>Obrađivač signala je funkcija koja opisuje korisničku reakciju na
pojavu odabranog signala.</li>
<li>Funkcija postaje obrađivač signala kada se poveže sa odgovarajućim
signalom.</li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-7" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Pojava signala SIGVTALRM nije zavisna od izvršavanja konkurentnog
programa.</li>
<li>Zadatak obrađivača signala SIGVTALRM je da pozove operaciju
kontrolera i tako izazove obradu nekog od (emuliranih) prekida, a
zadatak obrađivača signala SIGFPE je da izazove obradu izuzetka.</li>
<li>Za razliku od obrade izuzetaka, koja se uvek obavlja bez odlaganja,
obrada (emuliranih) prekida se obavezno odlaže ako su (emulirani)
prekidi onemogućeni.</li>
<li>Do obrade prethodno onemogućenog (emuliranog) prekida dolazi tek
nakon omogućenja (emuliranih) prekida.</li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-8" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>U slučaju konkurentnog programa, pojava signala podstakne mehanizam
signala da zaustavi zatečenu aktivnost niti i pokrene odgovarajućeg
obrađivača signala.</li>
<li>Ako u sklopu obrade (emuliranog) prekida, koju izazove ovaj
obrađivač signala, dođe do preključivanja na drugu nit, započeta obrada
signala će biti završena tek nakon ponovnog preključivanja na prethodno
zaustavljenu nit.</li>
<li>Da bi se u međuvremenu mogli obraditi novi signali, neophodno je da
se razna izvršavanja obrađivača signala mogu preklapati.</li>
<li>Za takve obrađivače signala se kaže da su višeulazni
(reentrant).</li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-9" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Klasa <code>Linux_signals</code> opisuje reakciju na Linux
signale.</li>
<li>Njen konstruktor koristi njeno polje sa i sistemski poziv
<code>sigaction()</code> da saopšti da njena operacija
<code>signal_handler()</code> ima ulogu obrađivača signala
<code>SIGVTALRM</code> i <code>SIGFPE</code>.</li>
<li>Ovaj konstruktor koristi konstantu <code>SA_NODEFER</code> (koju
upisuje u polje <code>sa.sa_flags</code>) da saopšti da nema odlaganja
obrada signala (da je obrađivač signala višeulazni).</li>
<li>Destruktor klase <code>Linux_signals</code> poništava akcije njenog
konstruktora.</li>
<li>Obrađivač signala <code>Linux_signals::signal_handler()</code> u
slučaju signala SIGVTALRM pozove emulaciju prekida
(<code>Interrupt::emulation()</code>), a u slučaju signala SIGFPE pozove
obrađivača izuzetka (<code>Interrupt::handler()</code>) koji opslužuje
hardverski izuzetak.</li>
</ul>
</section>
<section id="emulacija-prekida-2" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb5" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">class</span> Linux_signals <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="kw">struct</span> sigaction sa<span class="op">;</span> <span class="co">// struktura za definisanje signala</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="at">static</span> <span class="dt">void</span> signal_handler<span class="op">(</span><span class="dt">int</span> signal<span class="op">);</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>  Linux_signals<span class="op">(</span><span class="at">const</span> Linux_signals <span class="op">&amp;);</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>  Linux_signals <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Linux_signals <span class="op">&amp;);</span></span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="kw">public</span><span class="op">:</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-3" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb6" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb6-8"><a href="#cb6-8"></a>  Linux_signals<span class="op">();</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>  <span class="op">~</span>Linux_signals<span class="op">();</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="op">};</span></span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="dt">void</span> Linux_signals<span class="op">::</span>signal_handler<span class="op">(</span><span class="dt">int</span> signal<span class="op">)</span> <span class="co">// override signala</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="op">{</span></span>
<span id="cb6-14"><a href="#cb6-14"></a>  <span class="cf">switch</span> <span class="op">(</span>signal<span class="op">)</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-4" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb7" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb7-15"><a href="#cb7-15"></a>  <span class="cf">case</span> SIGVTALRM<span class="op">:</span></span>
<span id="cb7-16"><a href="#cb7-16"></a>    interrupt<span class="op">.</span>emulation<span class="op">();</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb7-18"><a href="#cb7-18"></a>  <span class="cf">case</span> SIGFPE<span class="op">:</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>    interrupt<span class="op">.</span>handler<span class="op">(</span>FP_EXCEPTION<span class="op">);</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb7-21"><a href="#cb7-21"></a>  <span class="op">}</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-5" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb8" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb8-22"><a href="#cb8-22"></a><span class="op">}</span></span>
<span id="cb8-23"><a href="#cb8-23"></a></span>
<span id="cb8-24"><a href="#cb8-24"></a>Linux_signals<span class="op">::</span>Linux_signals<span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>  sa<span class="op">.</span>sa_handler <span class="op">=</span> signal_handler<span class="op">;</span></span>
<span id="cb8-26"><a href="#cb8-26"></a>  sigemptyset<span class="op">(&amp;(</span>sa<span class="op">.</span>sa_mask<span class="op">));</span>   <span class="co">// Ne blokiramo nijedan signal</span></span>
<span id="cb8-27"><a href="#cb8-27"></a>  sa<span class="op">.</span>sa_flags <span class="op">=</span> SA_NODEFER<span class="op">;</span>     <span class="co">// obrada bez odlaganja</span></span>
<span id="cb8-28"><a href="#cb8-28"></a>  sigaction<span class="op">(</span>SIGVTALRM<span class="op">,</span> <span class="op">&amp;</span>sa<span class="op">,</span> <span class="dv">0</span><span class="op">);</span> <span class="co">// promena signala za</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-6" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb9" data-startFrom="29"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 28;"><span id="cb9-29"><a href="#cb9-29"></a>  sigaction<span class="op">(</span>SIGFPE<span class="op">,</span> <span class="op">&amp;</span>sa<span class="op">,</span> <span class="dv">0</span><span class="op">);</span>    <span class="co">// SIGVTALRM i SIGFPE</span></span>
<span id="cb9-30"><a href="#cb9-30"></a><span class="op">}</span></span>
<span id="cb9-31"><a href="#cb9-31"></a></span>
<span id="cb9-32"><a href="#cb9-32"></a>Linux_signals<span class="op">::~</span>Linux_signals<span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-33"><a href="#cb9-33"></a>  sa<span class="op">.</span>sa_handler <span class="op">=</span> SIG_DFL<span class="op">;</span> <span class="co">// vracanje na default</span></span>
<span id="cb9-34"><a href="#cb9-34"></a>  sigaction<span class="op">(</span>SIGVTALRM<span class="op">,</span> <span class="op">&amp;</span>sa<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb9-35"><a href="#cb9-35"></a>  sigaction<span class="op">(</span>SIGFPE<span class="op">,</span> <span class="op">&amp;</span>sa<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-7" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb10" data-startFrom="36"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 35;"><span id="cb10-36"><a href="#cb10-36"></a><span class="op">}</span></span>
<span id="cb10-37"><a href="#cb10-37"></a></span>
<span id="cb10-38"><a href="#cb10-38"></a>Linux_signals linux_signals<span class="op">;</span></span>
<span id="cb10-39"><a href="#cb10-39"></a></span>
<span id="cb10-40"><a href="#cb10-40"></a><span class="at">const</span> <span class="dt">int</span> LINUX_TIMER_INTERVAL <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb10-41"><a href="#cb10-41"></a></span>
<span id="cb10-42"><a href="#cb10-42"></a><span class="kw">class</span> Linux_timer <span class="op">{</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-8" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb11" data-startFrom="43"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 42;"><span id="cb11-43"><a href="#cb11-43"></a>  <span class="kw">struct</span> itimerval itimer<span class="op">;</span></span>
<span id="cb11-44"><a href="#cb11-44"></a>  Linux_timer<span class="op">(</span><span class="at">const</span> Linux_timer <span class="op">&amp;);</span></span>
<span id="cb11-45"><a href="#cb11-45"></a>  Linux_timer <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Linux_timer <span class="op">&amp;);</span></span>
<span id="cb11-46"><a href="#cb11-46"></a></span>
<span id="cb11-47"><a href="#cb11-47"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb11-48"><a href="#cb11-48"></a>  Linux_timer<span class="op">();</span></span>
<span id="cb11-49"><a href="#cb11-49"></a>  <span class="op">~</span>Linux_timer<span class="op">();</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-9" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb12" data-startFrom="50"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 49;"><span id="cb12-50"><a href="#cb12-50"></a><span class="op">};</span></span>
<span id="cb12-51"><a href="#cb12-51"></a></span>
<span id="cb12-52"><a href="#cb12-52"></a>Linux_timer<span class="op">::</span>Linux_timer<span class="op">()</span> <span class="co">// usec vreme se meri u mikrosekundama</span></span>
<span id="cb12-53"><a href="#cb12-53"></a><span class="op">{</span></span>
<span id="cb12-54"><a href="#cb12-54"></a>  itimer<span class="op">.</span>it_interval<span class="op">.</span>tv_sec <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// tekuća vrednost</span></span>
<span id="cb12-55"><a href="#cb12-55"></a>  itimer<span class="op">.</span>it_interval<span class="op">.</span>tv_usec <span class="op">=</span> LINUX_TIMER_INTERVAL <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb12-56"><a href="#cb12-56"></a>  itimer<span class="op">.</span>it_value<span class="op">.</span>tv_sec <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// vrednost kojom se resetuje</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-10" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb13" data-startFrom="57"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 56;"><span id="cb13-57"><a href="#cb13-57"></a>  itimer<span class="op">.</span>it_value<span class="op">.</span>tv_usec <span class="op">=</span> LINUX_TIMER_INTERVAL <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb13-58"><a href="#cb13-58"></a>  setitimer<span class="op">(</span>ITIMER_VIRTUAL<span class="op">,</span> <span class="op">&amp;</span>itimer<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb13-59"><a href="#cb13-59"></a><span class="op">}</span></span>
<span id="cb13-60"><a href="#cb13-60"></a></span>
<span id="cb13-61"><a href="#cb13-61"></a>Linux_timer<span class="op">::~</span>Linux_timer<span class="op">()</span> <span class="op">{</span></span>
<span id="cb13-62"><a href="#cb13-62"></a>  itimer<span class="op">.</span>it_value<span class="op">.</span>tv_sec <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-63"><a href="#cb13-63"></a>  itimer<span class="op">.</span>it_value<span class="op">.</span>tv_usec <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-11" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb14" data-startFrom="64"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 63;"><span id="cb14-64"><a href="#cb14-64"></a>  setitimer<span class="op">(</span>ITIMER_VIRTUAL<span class="op">,</span> <span class="op">&amp;</span>itimer<span class="op">,</span> <span class="dv">0</span><span class="op">);</span> <span class="co">// user mode timer</span></span>
<span id="cb14-65"><a href="#cb14-65"></a><span class="op">}</span></span>
<span id="cb14-66"><a href="#cb14-66"></a></span>
<span id="cb14-67"><a href="#cb14-67"></a><span class="at">static</span> Linux_timer linux_timer<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-mehanizma-prekida-10" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Klasa <code>Interrupt</code>:
<ul>
<li>uvodi (emuliranu) tabelu prekida (sadržanu u nizu vector)</li>
<li>omogućuje registrovanje odlaganja obrade (emuliranog) prekida (polje
pending)</li>
<li>reguliše redosled pozivanja obrađivača pojedinih (emuliranih)
prekida (polja controller_turn i timer_turn)</li>
</ul></li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-11" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>(Emulirana) tabela prekida se inicijalizuje tako da njeni elementi
sadrže vektor podrazumevajućeg obrađivača prekida:
default_interrupt_handler().</li>
<li>Operacija handler() klase Interrupt posreduje u pozivu obrađivača
(emuliranog) prekida.</li>
<li>Operacija emulation() registruje odlaganje obrade prekida ili
pokreće emulaciju kontrolera pozivom operacije
controller_emulator().</li>
<li>U svakoj parnoj emulaciji kontrolera poziva se obrađivač
(emuliranog) prekida sata (sa brojem vektora TIMER).</li>
<li>U svakoj neparnoj emulaciji kontrolera obavlja se, u kružnom
redosladu, emulacija samo jednog od kontrolera
(display_controller.output(), keyboard_controller.input() ili
disk_controller.transfer()).</li>
<li>Operacija ad_set_vector() omogućuje izmenu vektora prekida.</li>
</ul>
</section>
<section id="emulacija-prekida-12" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb15" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">class</span> Interrupt <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="at">static</span> <span class="dt">void</span> <span class="op">(*</span>vector<span class="op">[</span>INTERRUPT_TABLE_VECTOR_COUNT<span class="op">])();</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="dt">bool</span> pending<span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="dt">int</span> controller_turn<span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>  <span class="dt">bool</span> timer_turn<span class="op">;</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>  Interrupt<span class="op">(</span><span class="at">const</span> Interrupt <span class="op">&amp;);</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>  Interrupt <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Interrupt <span class="op">&amp;);</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-13" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb16" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb16-8"><a href="#cb16-8"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb16-9"><a href="#cb16-9"></a>  Interrupt<span class="op">();</span></span>
<span id="cb16-10"><a href="#cb16-10"></a>  <span class="kw">inline</span> <span class="dt">void</span> handler<span class="op">(</span><span class="dt">unsigned</span> index<span class="op">);</span></span>
<span id="cb16-11"><a href="#cb16-11"></a>  <span class="kw">inline</span> <span class="dt">void</span> emulation<span class="op">();</span></span>
<span id="cb16-12"><a href="#cb16-12"></a>  <span class="kw">inline</span> <span class="dt">void</span> controller_emulator<span class="op">();</span></span>
<span id="cb16-13"><a href="#cb16-13"></a>  <span class="kw">friend</span> <span class="kw">inline</span> <span class="dt">void</span> ad__restore_interrupts<span class="op">(</span><span class="dt">bool</span> new_interrupt_status<span class="op">);</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-14" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb17" data-startFrom="14"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 13;"><span id="cb17-14"><a href="#cb17-14"></a>  <span class="kw">friend</span> <span class="kw">inline</span> <span class="dt">void</span> ad__set_vector<span class="op">(</span><span class="dt">int</span> index<span class="op">,</span> <span class="dt">void</span> <span class="op">(*</span>handler<span class="op">)());</span></span>
<span id="cb17-15"><a href="#cb17-15"></a><span class="op">};</span></span>
<span id="cb17-16"><a href="#cb17-16"></a></span>
<span id="cb17-17"><a href="#cb17-17"></a><span class="dt">void</span> default_interrupt_handler<span class="op">()</span> <span class="op">{}</span></span>
<span id="cb17-18"><a href="#cb17-18"></a></span>
<span id="cb17-19"><a href="#cb17-19"></a><span class="dt">void</span> <span class="op">(*</span>Interrupt<span class="op">::</span>vector<span class="op">[</span>INTERRUPT_TABLE_VECTOR_COUNT<span class="op">])()</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb17-20"><a href="#cb17-20"></a>    default_interrupt_handler<span class="op">};</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-15" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb18" data-startFrom="21"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 20;"><span id="cb18-21"><a href="#cb18-21"></a>Interrupt<span class="op">::</span>Interrupt<span class="op">()</span> <span class="op">:</span> pending<span class="op">(</span><span class="kw">false</span><span class="op">),</span> controller_turn<span class="op">(</span><span class="dv">0</span><span class="op">),</span> timer_turn<span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb18-22"><a href="#cb18-22"></a></span>
<span id="cb18-23"><a href="#cb18-23"></a><span class="dt">void</span> Interrupt<span class="op">::</span>handler<span class="op">(</span><span class="dt">unsigned</span> index<span class="op">)</span> <span class="op">{</span> <span class="op">(</span>vector<span class="op">[</span>index<span class="op">])();</span> <span class="op">}</span></span>
<span id="cb18-24"><a href="#cb18-24"></a></span>
<span id="cb18-25"><a href="#cb18-25"></a><span class="dt">void</span> Interrupt<span class="op">::</span>emulation<span class="op">()</span> <span class="op">{</span></span>
<span id="cb18-26"><a href="#cb18-26"></a>  <span class="cf">if</span> <span class="op">(!</span>interrupts_enabled<span class="op">)</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-16" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb19" data-startFrom="27"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 26;"><span id="cb19-27"><a href="#cb19-27"></a>    interrupt<span class="op">.</span>pending <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb19-28"><a href="#cb19-28"></a>  <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb19-29"><a href="#cb19-29"></a>    interrupts_enabled <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb19-30"><a href="#cb19-30"></a>    controller_emulator<span class="op">();</span></span>
<span id="cb19-31"><a href="#cb19-31"></a>    interrupts_enabled <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb19-32"><a href="#cb19-32"></a>  <span class="op">}</span></span>
<span id="cb19-33"><a href="#cb19-33"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-17" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb20" data-startFrom="34"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 33;"><span id="cb20-34"><a href="#cb20-34"></a><span class="dt">void</span> Interrupt<span class="op">::</span>controller_emulator<span class="op">()</span> <span class="op">{</span></span>
<span id="cb20-35"><a href="#cb20-35"></a>  <span class="dt">bool</span> interrupt_emulated<span class="op">;</span></span>
<span id="cb20-36"><a href="#cb20-36"></a>  <span class="dt">int</span> counter <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb20-37"><a href="#cb20-37"></a>  <span class="cf">if</span> <span class="op">(</span>timer_turn<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-38"><a href="#cb20-38"></a>    timer_turn <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb20-39"><a href="#cb20-39"></a>    handler<span class="op">(</span>TIMER<span class="op">);</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-18" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb21" data-startFrom="40"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 39;"><span id="cb21-40"><a href="#cb21-40"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb21-41"><a href="#cb21-41"></a>    timer_turn <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb21-42"><a href="#cb21-42"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb21-43"><a href="#cb21-43"></a>      <span class="cf">switch</span> <span class="op">(</span>controller_turn<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-44"><a href="#cb21-44"></a>      <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span></span>
<span id="cb21-45"><a href="#cb21-45"></a>        interrupt_emulated <span class="op">=</span> display_controller<span class="op">.</span>output<span class="op">();</span></span>
<span id="cb21-46"><a href="#cb21-46"></a>        controller_turn <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-19" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb22" data-startFrom="47"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 46;"><span id="cb22-47"><a href="#cb22-47"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb22-48"><a href="#cb22-48"></a>      <span class="cf">case</span> <span class="dv">1</span><span class="op">:</span></span>
<span id="cb22-49"><a href="#cb22-49"></a>        interrupt_emulated <span class="op">=</span> keyboard_controller<span class="op">.</span>input<span class="op">();</span></span>
<span id="cb22-50"><a href="#cb22-50"></a>        controller_turn <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb22-51"><a href="#cb22-51"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb22-52"><a href="#cb22-52"></a>      <span class="cf">case</span> <span class="dv">2</span><span class="op">:</span></span>
<span id="cb22-53"><a href="#cb22-53"></a>        interrupt_emulated <span class="op">=</span> disk_controller<span class="op">.</span>transfer<span class="op">();</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-20" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb23" data-startFrom="54"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 53;"><span id="cb23-54"><a href="#cb23-54"></a>        controller_turn <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb23-55"><a href="#cb23-55"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb23-56"><a href="#cb23-56"></a>      <span class="op">}</span></span>
<span id="cb23-57"><a href="#cb23-57"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(!</span>interrupt_emulated <span class="op">&amp;&amp;</span> <span class="op">++</span>counter <span class="op">&lt;</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb23-58"><a href="#cb23-58"></a>  <span class="op">}</span></span>
<span id="cb23-59"><a href="#cb23-59"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-21" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb24" data-startFrom="60"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 59;"><span id="cb24-60"><a href="#cb24-60"></a><span class="kw">inline</span> <span class="dt">void</span> ad__set_vector<span class="op">(</span><span class="dt">int</span> index<span class="op">,</span> <span class="dt">void</span> <span class="op">(*</span>handler<span class="op">)())</span> <span class="op">{</span></span>
<span id="cb24-61"><a href="#cb24-61"></a>  Interrupt<span class="op">::</span>vector<span class="op">[</span>index<span class="op">]</span> <span class="op">=</span> handler<span class="op">;</span></span>
<span id="cb24-62"><a href="#cb24-62"></a><span class="op">}</span></span>
<span id="cb24-63"><a href="#cb24-63"></a></span>
<span id="cb24-64"><a href="#cb24-64"></a>Interrupt interrupt<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-tastature" class="slide level2">
<h2>Emulacija kontrolera tastature</h2>
<ul>
<li>Klasa <code>Keyboard_controller</code> opisuje kontroler
tastature.</li>
<li>Njeno polje <code>data_reg</code> predstavlja registar podataka
kontrolera, a njena operacija <code>input()</code> opisuje ponašanje
kontrolera tastature.</li>
<li>Ako postoji znak za preuzimanje, on se preuzima u okviru operacije
<code>input()</code> posredstvom odgovarajućeg Linux sistemskog
poziva.</li>
<li>Ujedno se poziva obrađivač prekida tastature posredstvom operacije
<code>handler()</code>:</li>
<li><code>interrupt.handler(KEYBOARD)</code></li>
<li>klase <code>Interrupt</code> koja emulira tabelu prekida.</li>
<li>Operacija <code>input()</code> se periodično poziva u toku emulacije
kontrolera.</li>
</ul>
</section>
<section id="emulacija-kontrolera-tastature-1" class="slide level2">
<h2>Emulacija kontrolera tastature</h2>
<div class="sourceCode" id="cb25" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1"></a><span class="kw">class</span> Keyboard_controller <span class="op">{</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="dt">char</span> data_reg<span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="dt">bool</span> input<span class="op">();</span></span>
<span id="cb25-4"><a href="#cb25-4"></a>  Keyboard_controller<span class="op">(</span><span class="at">const</span> Keyboard_controller <span class="op">&amp;);</span></span>
<span id="cb25-5"><a href="#cb25-5"></a>  Keyboard_controller <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Keyboard_controller <span class="op">&amp;);</span></span>
<span id="cb25-6"><a href="#cb25-6"></a></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="kw">public</span><span class="op">:</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-tastature-2" class="slide level2">
<h2>Emulacija kontrolera tastature</h2>
<div class="sourceCode" id="cb26" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb26-8"><a href="#cb26-8"></a>  Keyboard_controller<span class="op">(){};</span></span>
<span id="cb26-9"><a href="#cb26-9"></a>  <span class="kw">friend</span> <span class="kw">class</span> Interrupt<span class="op">;</span></span>
<span id="cb26-10"><a href="#cb26-10"></a>  <span class="kw">friend</span> <span class="kw">class</span> Keyboard_driver<span class="op">;</span></span>
<span id="cb26-11"><a href="#cb26-11"></a><span class="op">};</span></span>
<span id="cb26-12"><a href="#cb26-12"></a></span>
<span id="cb26-13"><a href="#cb26-13"></a><span class="dt">bool</span> Keyboard_controller<span class="op">::</span>input<span class="op">()</span> <span class="op">{</span></span>
<span id="cb26-14"><a href="#cb26-14"></a>  <span class="dt">bool</span> interrupt_emulated <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-tastature-3" class="slide level2">
<h2>Emulacija kontrolera tastature</h2>
<div class="sourceCode" id="cb27" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb27-15"><a href="#cb27-15"></a>  <span class="dt">unsigned</span> read_count<span class="op">;</span></span>
<span id="cb27-16"><a href="#cb27-16"></a>  <span class="dt">char</span> c<span class="op">;</span></span>
<span id="cb27-17"><a href="#cb27-17"></a>  read_count <span class="op">=</span> read<span class="op">(</span>STDIN_FILENO<span class="op">,</span> <span class="op">&amp;</span>c<span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="co">// sys call</span></span>
<span id="cb27-18"><a href="#cb27-18"></a>  <span class="cf">if</span> <span class="op">(</span>read_count <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-19"><a href="#cb27-19"></a>    data_reg <span class="op">=</span> c<span class="op">;</span></span>
<span id="cb27-20"><a href="#cb27-20"></a>    interrupt<span class="op">.</span>handler<span class="op">(</span>KEYBOARD<span class="op">);</span></span>
<span id="cb27-21"><a href="#cb27-21"></a>    interrupt_emulated <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-tastature-4" class="slide level2">
<h2>Emulacija kontrolera tastature</h2>
<div class="sourceCode" id="cb28" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb28-22"><a href="#cb28-22"></a>  <span class="op">}</span></span>
<span id="cb28-23"><a href="#cb28-23"></a>  <span class="cf">return</span> interrupt_emulated<span class="op">;</span></span>
<span id="cb28-24"><a href="#cb28-24"></a><span class="op">}</span></span>
<span id="cb28-25"><a href="#cb28-25"></a></span>
<span id="cb28-26"><a href="#cb28-26"></a>Keyboard_controller keyboard_controller<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-ekrana" class="slide level2">
<h2>Emulacija kontrolera ekrana</h2>
<ul>
<li>Klasa <code>Display_controller</code> opisuje kontroler ekrana.</li>
<li>Njena polja <code>data_reg</code> i <code>status_reg</code>
predstavljaju registre podataka i stanja kontrolera, a njena operacija
<code>output()</code> opisuje ponašanje kontrolera ekrana.</li>
<li>Ako postoji znak za prikazivanje, on se prikazuje u okviru operacije
<code>output()</code> posredstvom odgovarajućeg Linux sistemskog
poziva.</li>
<li>Ujedno se poziva obrađivač prekida ekrana posredstvom operacije
<code>handler()</code> <code>interrupt.handler(DISPLAY)</code> klase
<code>Interrupt</code> koja emulira tabelu prekida.</li>
<li>Operacija <code>output()</code> se periodično poziva u toku
emulacije kontrolera.</li>
</ul>
</section>
<section id="emulacija-kontrolera-ekrana-1" class="slide level2">
<h2>Emulacija kontrolera ekrana</h2>
<div class="sourceCode" id="cb29" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb29-1"><a href="#cb29-1"></a><span class="kw">enum</span> Display_status <span class="op">{</span> DISPLAY_READY<span class="op">,</span> DISPLAY_BUSY <span class="op">};</span></span>
<span id="cb29-2"><a href="#cb29-2"></a></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="kw">class</span> Display_controller <span class="op">{</span></span>
<span id="cb29-4"><a href="#cb29-4"></a>  <span class="dt">char</span> data_reg<span class="op">;</span></span>
<span id="cb29-5"><a href="#cb29-5"></a>  Display_status status_reg<span class="op">;</span></span>
<span id="cb29-6"><a href="#cb29-6"></a>  <span class="dt">bool</span> output<span class="op">();</span></span>
<span id="cb29-7"><a href="#cb29-7"></a>  Display_controller<span class="op">(</span><span class="at">const</span> Display_controller <span class="op">&amp;);</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-ekrana-2" class="slide level2">
<h2>Emulacija kontrolera ekrana</h2>
<div class="sourceCode" id="cb30" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb30-8"><a href="#cb30-8"></a>  Display_controller <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Display_controller <span class="op">&amp;);</span></span>
<span id="cb30-9"><a href="#cb30-9"></a></span>
<span id="cb30-10"><a href="#cb30-10"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb30-11"><a href="#cb30-11"></a>  Display_controller<span class="op">()</span> <span class="op">:</span> status_reg<span class="op">(</span>DISPLAY_READY<span class="op">){};</span></span>
<span id="cb30-12"><a href="#cb30-12"></a>  <span class="kw">friend</span> <span class="kw">class</span> Interrupt<span class="op">;</span></span>
<span id="cb30-13"><a href="#cb30-13"></a>  <span class="kw">friend</span> <span class="kw">class</span> Display_driver<span class="op">;</span></span>
<span id="cb30-14"><a href="#cb30-14"></a><span class="op">};</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-ekrana-3" class="slide level2">
<h2>Emulacija kontrolera ekrana</h2>
<div class="sourceCode" id="cb31" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb31-15"><a href="#cb31-15"></a><span class="dt">bool</span> Display_controller<span class="op">::</span>output<span class="op">()</span> <span class="op">{</span></span>
<span id="cb31-16"><a href="#cb31-16"></a>  <span class="dt">bool</span> interrupt_emulated <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb31-17"><a href="#cb31-17"></a>  <span class="cf">if</span> <span class="op">(</span>status_reg <span class="op">==</span> DISPLAY_BUSY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-18"><a href="#cb31-18"></a>    write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> <span class="op">&amp;</span>data_reg<span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="co">// sys call</span></span>
<span id="cb31-19"><a href="#cb31-19"></a>    status_reg <span class="op">=</span> DISPLAY_READY<span class="op">;</span></span>
<span id="cb31-20"><a href="#cb31-20"></a>    interrupt<span class="op">.</span>handler<span class="op">(</span>DISPLAY<span class="op">);</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-ekrana-4" class="slide level2">
<h2>Emulacija kontrolera ekrana</h2>
<div class="sourceCode" id="cb32" data-startFrom="21"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 20;"><span id="cb32-21"><a href="#cb32-21"></a>    interrupt_emulated <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb32-22"><a href="#cb32-22"></a>  <span class="op">}</span></span>
<span id="cb32-23"><a href="#cb32-23"></a>  <span class="cf">return</span> interrupt_emulated<span class="op">;</span></span>
<span id="cb32-24"><a href="#cb32-24"></a><span class="op">}</span></span>
<span id="cb32-25"><a href="#cb32-25"></a></span>
<span id="cb32-26"><a href="#cb32-26"></a>Display_controller display_controller<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-tastature-i-ekrana"
class="slide level2">
<h2>Emulacija kontrolera tastature i ekrana</h2>
<ul>
<li>Prethodne dve klase koriste tastaturu i ekran Linux terminala.</li>
<li>Za potrebe emulacije neophodno je isključiti eho (echo) Linux
terminala, prevesti Linux terminal u režim rada bez linijskog editiranja
(raw mode) i obezbediti da poziv čitanja znaka sa terminala bude
neblokirajući.</li>
</ul>
</section>
<section id="emulacija-kontrolera-tastature-i-ekrana-1"
class="slide level2">
<h2>Emulacija kontrolera tastature i ekrana</h2>
<ul>
<li>Sve prethodno obezbeđuje klasa <code>Linux_terminal</code> koji
koristi polje <code>ots</code> ove klase da sačuva zatečeni režim rada
Linux terminala, a <code>ts</code> polje da zada njegov novi režim
rada.</li>
<li>Prethodno zatečeni režim rada Linux terminala ponovo uspostavlja
destruktor klase <code>Linux_terminal</code>.</li>
<li>Ovaj destruktor se poziva na kraju aktivnosti procesa i radi provere
da li postoje niti za koje nije regularno da kraj njihove aktivnosti
nastupi kao posledica kraja aktivnosti procesa kome one pripadaju i radi
obaveštenja o prevremenom završetku ovakvih niti.</li>
</ul>
</section>
<section id="rukovanje-terminalom" class="slide level2">
<h2>Rukovanje terminalom</h2>
<div class="sourceCode" id="cb33" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb33-1"><a href="#cb33-1"></a><span class="kw">class</span> Linux_terminal <span class="op">{</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>  <span class="kw">struct</span> termios ts<span class="op">;</span></span>
<span id="cb33-3"><a href="#cb33-3"></a>  <span class="kw">struct</span> termios ots<span class="op">;</span></span>
<span id="cb33-4"><a href="#cb33-4"></a>  Linux_terminal<span class="op">(</span><span class="at">const</span> Linux_terminal <span class="op">&amp;);</span></span>
<span id="cb33-5"><a href="#cb33-5"></a>  Linux_terminal <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Linux_terminal <span class="op">&amp;);</span></span>
<span id="cb33-6"><a href="#cb33-6"></a></span>
<span id="cb33-7"><a href="#cb33-7"></a><span class="kw">public</span><span class="op">:</span></span></code></pre></div>
</section>
<section id="rukovanje-terminalom-1" class="slide level2">
<h2>Rukovanje terminalom</h2>
<div class="sourceCode" id="cb34" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb34-8"><a href="#cb34-8"></a>  Linux_terminal<span class="op">();</span></span>
<span id="cb34-9"><a href="#cb34-9"></a>  <span class="op">~</span>Linux_terminal<span class="op">();</span></span>
<span id="cb34-10"><a href="#cb34-10"></a><span class="op">};</span></span>
<span id="cb34-11"><a href="#cb34-11"></a></span>
<span id="cb34-12"><a href="#cb34-12"></a>Linux_terminal<span class="op">::</span>Linux_terminal<span class="op">()</span> <span class="op">{</span></span>
<span id="cb34-13"><a href="#cb34-13"></a>  tcgetattr<span class="op">(</span>STDIN_FILENO<span class="op">,</span> <span class="op">&amp;</span>ts<span class="op">);</span> <span class="co">// preuzmi parametre terminala</span></span>
<span id="cb34-14"><a href="#cb34-14"></a>  ots <span class="op">=</span> ts<span class="op">;</span></span></code></pre></div>
</section>
<section id="rukovanje-terminalom-2" class="slide level2">
<h2>Rukovanje terminalom</h2>
<div class="sourceCode" id="cb35" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb35-15"><a href="#cb35-15"></a>  ts<span class="op">.</span>c_lflag <span class="op">&amp;=</span> <span class="op">~</span>ECHO<span class="op">;</span>   <span class="co">// zabrana eha na ekran</span></span>
<span id="cb35-16"><a href="#cb35-16"></a>  ts<span class="op">.</span>c_lflag <span class="op">&amp;=</span> <span class="op">~</span>ICANON<span class="op">;</span> <span class="co">// flag nekanonskog moda</span></span>
<span id="cb35-17"><a href="#cb35-17"></a>  ts<span class="op">.</span>c_cc<span class="op">[</span>VTIME<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>    <span class="co">// timeout u decisekunda za nekanonski read</span></span>
<span id="cb35-18"><a href="#cb35-18"></a>  ts<span class="op">.</span>c_cc<span class="op">[</span>VMIN<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>     <span class="co">// minimalni broj karaktera za nekanonski read</span></span>
<span id="cb35-19"><a href="#cb35-19"></a>  tcsetattr<span class="op">(</span>STDIN_FILENO<span class="op">,</span> TCSANOW<span class="op">,</span> <span class="op">&amp;</span>ts<span class="op">);</span> <span class="co">// postavi parametre term</span></span>
<span id="cb35-20"><a href="#cb35-20"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="rukovanje-terminalom-3" class="slide level2">
<h2>Rukovanje terminalom</h2>
<div class="sourceCode" id="cb36" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb36-22"><a href="#cb36-22"></a>Linux_terminal<span class="op">::~</span>Linux_terminal<span class="op">()</span> <span class="op">{</span></span>
<span id="cb36-23"><a href="#cb36-23"></a>  <span class="cf">if</span> <span class="op">(</span>undetached_threads<span class="op">())</span></span>
<span id="cb36-24"><a href="#cb36-24"></a>                write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> <span class="op">&amp;</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">ERROR: DESTROYING UNDETACHED</span></span>
<span id="cb36-25"><a href="#cb36-25"></a>               THREADS<span class="op">!</span>\n<span class="st">&quot;, 40);</span></span>
<span id="cb36-26"><a href="#cb36-26"></a>    <span class="cf">else</span></span>
<span id="cb36-27"><a href="#cb36-27"></a>        write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> <span class="op">&amp;</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb36-28"><a href="#cb36-28"></a>    tcsetattr<span class="op">(</span>STDIN_FILENO<span class="op">,</span> TCSANOW<span class="op">,</span> <span class="op">&amp;</span>ots<span class="op">);</span> <span class="co">//povrati parametre</span></span></code></pre></div>
</section>
<section id="rukovanje-terminalom-4" class="slide level2">
<h2>Rukovanje terminalom</h2>
<div class="sourceCode" id="cb37" data-startFrom="29"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 28;"><span id="cb37-29"><a href="#cb37-29"></a><span class="op">}</span></span>
<span id="cb37-30"><a href="#cb37-30"></a></span>
<span id="cb37-31"><a href="#cb37-31"></a><span class="at">static</span> Linux_terminal linux_terminal<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-diska" class="slide level2">
<h2>Emulacija kontrolera diska</h2>
<ul>
<li>Klasa <code>Disk_controller</code> opisuje ponašanje kontrolera
diska.</li>
<li>Njena polja <code>operation_reg</code>, <code>buffer_reg</code>,
<code>block_reg</code> i <code>status_reg</code> odgovaraju registrima
smera prenosa, bafera, bloka i stanja kontrolera, a njena operacija
<code>transfer()</code> opisuje ponašanje kontrolera diska.</li>
<li>Konstruktor klase <code>Disk_controller</code> koristi sistemski
poziv <code>calloc()</code> radi zauzimanja radne memorije, u kojoj se
čuvaju blokovi emuliranog diska.</li>
</ul>
</section>
<section id="emulacija-kontrolera-diska-1" class="slide level2">
<h2>Emulacija kontrolera diska</h2>
<ul>
<li>Inercija diska se emulira brojanjem poziva operacije
<code>transfer()</code>.</li>
<li>Kada broj poziva ove operacije postane jednak procenjenom broju
vremenskih jedinica, potrebnom za prenos bloka, tada se obavi prenos
bloka u okviru ove operacije i ujedno se pozove obrađivač prekida diska
posredstvom operacije <code>handler()</code>
<code>interrupt.handler(DISK)</code> klase Interrupt koja emulira tabelu
prekida.</li>
<li>Operacija transfer() se periodično poziva u toku emulacije
kontrolera.</li>
</ul>
</section>
<section id="emulacija-diska" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb38" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb38-1"><a href="#cb38-1"></a><span class="kw">enum</span> Disk_operations <span class="op">{</span> DISK_READ<span class="op">,</span> DISK_WRITE <span class="op">};</span></span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="kw">enum</span> Disk_status <span class="op">{</span> DISK_STARTED<span class="op">,</span> DISK_ACTIVE<span class="op">,</span> DISK_STOPPED <span class="op">};</span></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="at">const</span> <span class="dt">unsigned</span> BLOCK_SIZE <span class="op">=</span> <span class="dv">512</span><span class="op">;</span></span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="at">const</span> <span class="dt">unsigned</span> DISK_BLOCKS <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="kw">typedef</span> <span class="dt">char</span> Disk_block<span class="op">[</span>BLOCK_SIZE<span class="op">];</span></span>
<span id="cb38-6"><a href="#cb38-6"></a></span>
<span id="cb38-7"><a href="#cb38-7"></a><span class="kw">class</span> Disk_controller <span class="op">{</span></span></code></pre></div>
</section>
<section id="emulacija-diska-1" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb39" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb39-8"><a href="#cb39-8"></a>  Disk_block <span class="op">*</span>disk_space<span class="op">;</span></span>
<span id="cb39-9"><a href="#cb39-9"></a>  <span class="dt">unsigned</span> accessed_last<span class="op">;</span></span>
<span id="cb39-10"><a href="#cb39-10"></a>  <span class="dt">unsigned</span> transfer_time<span class="op">;</span></span>
<span id="cb39-11"><a href="#cb39-11"></a>  Disk_operations operation_reg<span class="op">;</span></span>
<span id="cb39-12"><a href="#cb39-12"></a>  <span class="dt">char</span> <span class="op">*</span>buffer_reg<span class="op">;</span></span>
<span id="cb39-13"><a href="#cb39-13"></a>  <span class="dt">unsigned</span> block_reg<span class="op">;</span></span>
<span id="cb39-14"><a href="#cb39-14"></a>  Disk_status status_reg<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-diska-2" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb40" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb40-15"><a href="#cb40-15"></a>  <span class="dt">bool</span> transfer<span class="op">();</span></span>
<span id="cb40-16"><a href="#cb40-16"></a>  Disk_controller<span class="op">(</span><span class="at">const</span> Disk_controller <span class="op">&amp;);</span></span>
<span id="cb40-17"><a href="#cb40-17"></a>  Disk_controller <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Disk_controller <span class="op">&amp;);</span></span>
<span id="cb40-18"><a href="#cb40-18"></a></span>
<span id="cb40-19"><a href="#cb40-19"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb40-20"><a href="#cb40-20"></a>  Disk_controller<span class="op">();</span></span>
<span id="cb40-21"><a href="#cb40-21"></a>  <span class="op">~</span>Disk_controller<span class="op">();</span></span></code></pre></div>
</section>
<section id="emulacija-diska-3" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb41" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb41-22"><a href="#cb41-22"></a>  <span class="kw">friend</span> <span class="kw">class</span> Interrupt<span class="op">;</span></span>
<span id="cb41-23"><a href="#cb41-23"></a>  <span class="kw">friend</span> <span class="kw">class</span> Disk_driver<span class="op">;</span></span>
<span id="cb41-24"><a href="#cb41-24"></a><span class="op">};</span></span>
<span id="cb41-25"><a href="#cb41-25"></a></span>
<span id="cb41-26"><a href="#cb41-26"></a>Disk_controller<span class="op">::</span>Disk_controller<span class="op">()</span></span>
<span id="cb41-27"><a href="#cb41-27"></a>    <span class="op">:</span> accessed_last<span class="op">(</span><span class="dv">0</span><span class="op">),</span> transfer_time<span class="op">(</span><span class="dv">0</span><span class="op">),</span> status_reg<span class="op">(</span>DISK_STOPPED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-28"><a href="#cb41-28"></a>  disk_space <span class="op">=</span> <span class="op">(</span>Disk_block <span class="op">*)</span>calloc<span class="op">(</span>DISK_BLOCKS<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Disk_block<span class="op">));</span></span></code></pre></div>
</section>
<section id="emulacija-diska-4" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb42" data-startFrom="29"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 28;"><span id="cb42-29"><a href="#cb42-29"></a><span class="op">}</span></span>
<span id="cb42-30"><a href="#cb42-30"></a></span>
<span id="cb42-31"><a href="#cb42-31"></a>Disk_controller<span class="op">::~</span>Disk_controller<span class="op">()</span> <span class="op">{</span> free<span class="op">(</span>disk_space<span class="op">);</span> <span class="op">}</span></span>
<span id="cb42-32"><a href="#cb42-32"></a></span>
<span id="cb42-33"><a href="#cb42-33"></a><span class="at">const</span> <span class="dt">int</span> SECTORS_PER_TRACK <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb42-34"><a href="#cb42-34"></a><span class="at">const</span> <span class="dt">int</span> TRANSFER_TIME_AND_ROTATIONAL_DELAY <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-diska-5" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb43" data-startFrom="36"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 35;"><span id="cb43-36"><a href="#cb43-36"></a><span class="dt">bool</span> Disk_controller<span class="op">::</span>transfer<span class="op">()</span> <span class="op">{</span></span>
<span id="cb43-37"><a href="#cb43-37"></a>  <span class="dt">bool</span> interrupt_emulated <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb43-38"><a href="#cb43-38"></a>  Disk_block <span class="op">*</span>block_pointer<span class="op">;</span></span>
<span id="cb43-39"><a href="#cb43-39"></a>  <span class="dt">int</span> block_distance<span class="op">;</span></span>
<span id="cb43-40"><a href="#cb43-40"></a>  <span class="cf">if</span> <span class="op">(</span>status_reg <span class="op">==</span> DISK_STARTED<span class="op">)</span> <span class="op">{</span> <span class="co">// deo simulacije inercije rotacije diska</span></span>
<span id="cb43-41"><a href="#cb43-41"></a>    status_reg <span class="op">=</span> DISK_ACTIVE<span class="op">;</span></span>
<span id="cb43-42"><a href="#cb43-42"></a>    block_distance <span class="op">=</span> accessed_last <span class="op">-</span> block_reg<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-diska-6" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb44" data-startFrom="43"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 42;"><span id="cb44-43"><a href="#cb44-43"></a>    <span class="cf">if</span> <span class="op">(</span>block_distance <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb44-44"><a href="#cb44-44"></a>      block_distance <span class="op">=</span> <span class="op">-</span>block_distance<span class="op">;</span></span>
<span id="cb44-45"><a href="#cb44-45"></a>    transfer_time <span class="op">=</span> TRANSFER_TIME_AND_ROTATIONAL_DELAY<span class="op">;</span></span>
<span id="cb44-46"><a href="#cb44-46"></a>    transfer_time <span class="op">+=</span> block_distance <span class="op">/</span> SECTORS_PER_TRACK<span class="op">;</span> <span class="co">// vreme rotacije</span></span>
<span id="cb44-47"><a href="#cb44-47"></a>    accessed_last <span class="op">=</span> block_reg<span class="op">;</span></span>
<span id="cb44-48"><a href="#cb44-48"></a>  <span class="op">}</span></span>
<span id="cb44-49"><a href="#cb44-49"></a>  <span class="cf">if</span> <span class="op">((</span>status_reg <span class="op">==</span> DISK_ACTIVE<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(--</span>transfer_time <span class="op">==</span> <span class="dv">0</span><span class="op">))</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="emulacija-diska-7" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb45" data-startFrom="50"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 49;"><span id="cb45-50"><a href="#cb45-50"></a>    block_pointer <span class="op">=</span> disk_space <span class="op">+</span> block_reg<span class="op">;</span></span>
<span id="cb45-51"><a href="#cb45-51"></a>    <span class="cf">if</span> <span class="op">(</span>operation_reg <span class="op">==</span> DISK_WRITE<span class="op">)</span></span>
<span id="cb45-52"><a href="#cb45-52"></a>      bcopy<span class="op">(</span>buffer_reg<span class="op">,</span> block_pointer<span class="op">,</span> BLOCK_SIZE<span class="op">);</span> <span class="co">// kopiraj bajte</span></span>
<span id="cb45-53"><a href="#cb45-53"></a>    <span class="cf">else</span></span>
<span id="cb45-54"><a href="#cb45-54"></a>      bcopy<span class="op">(</span>block_pointer<span class="op">,</span> buffer_reg<span class="op">,</span> BLOCK_SIZE<span class="op">);</span> <span class="co">// kopiraj bajte</span></span>
<span id="cb45-55"><a href="#cb45-55"></a>    status_reg <span class="op">=</span> DISK_STOPPED<span class="op">;</span></span>
<span id="cb45-56"><a href="#cb45-56"></a>    interrupt<span class="op">.</span>handler<span class="op">(</span>DISK<span class="op">);</span></span></code></pre></div>
</section>
<section id="emulacija-diska-8" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb46" data-startFrom="57"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 56;"><span id="cb46-57"><a href="#cb46-57"></a>    interrupt_emulated <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb46-58"><a href="#cb46-58"></a>  <span class="op">}</span></span>
<span id="cb46-59"><a href="#cb46-59"></a>  <span class="cf">return</span> interrupt_emulated<span class="op">;</span></span>
<span id="cb46-60"><a href="#cb46-60"></a><span class="op">}</span></span>
<span id="cb46-61"><a href="#cb46-61"></a></span>
<span id="cb46-62"><a href="#cb46-62"></a>Disk_controller disk_controller<span class="op">;</span></span></code></pre></div>
</section>
<section id="okončanje-izvršavanja-konkurentnog-programa"
class="slide level2">
<h2>Okončanje izvršavanja konkurentnog programa</h2>
<ul>
<li>Izvršavanje konkurentnog programa se okončava sistemskim pozivom
<code>exit()</code>. To omogućuje funkcija
<code>ad__report_and_finish()</code></li>
</ul>
</section>
<section id="okončanje-izvršavanja-konkurentnog-programa-1"
class="slide level2">
<h2>Okončanje izvršavanja konkurentnog programa</h2>
<div class="sourceCode" id="cb47" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb47-1"><a href="#cb47-1"></a><span class="kw">inline</span> <span class="dt">void</span> ad__report_and_finish<span class="op">(</span><span class="at">const</span> <span class="dt">char</span><span class="op">*</span> message_string<span class="op">){</span></span>
<span id="cb47-2"><a href="#cb47-2"></a>    <span class="dt">int</span> length <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb47-3"><a href="#cb47-3"></a>    <span class="cf">while</span><span class="op">(</span>message_string<span class="op">[</span>length<span class="op">]</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb47-4"><a href="#cb47-4"></a>        length<span class="op">++;</span></span>
<span id="cb47-5"><a href="#cb47-5"></a>    write<span class="op">(</span>STDERR_FILENO<span class="op">,</span> message_string<span class="op">,</span> length<span class="op">);</span></span>
<span id="cb47-6"><a href="#cb47-6"></a>    write<span class="op">(</span>STDERR_FILENO<span class="op">,</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb47-7"><a href="#cb47-7"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb47-8"><a href="#cb47-8"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="asm-direktiva" class="slide level2">
<h2>ASM direktiva</h2>
<ul>
<li>C/C++ standard podrazumeva postojanje ASM direktive koja omogućava
da se u C/C++ kod umetne asemblerski kod date platforme.</li>
<li>Standard ne definiše u detalje kako tačno ova funkcija treba da
radi.</li>
<li>Mi radimo sa GCC kompajlerom, te stoga koristimo sintaksu koju uvodi
GCC.</li>
</ul>
</section>
<section id="vrste-gcc-asm-direktive" class="slide level2">
<h2>Vrste GCC ASM direktive</h2>
<ul>
<li>U okviru GCC-a, postoje dve varijante ASM direktive:
<ul>
<li>Osnovna (basic) i</li>
<li>Proširena (extended)</li>
</ul></li>
<li>Osnovna služi da se samo navedu ASM komande, jedna za drugom, i
ništa preko toga.</li>
<li>Proširena, omogućava integraciju između ASM koda i C koda kroz
ulazno/izlazne parametre.</li>
</ul>
</section>
<section id="osnovna-asm-direktiva" class="slide level2">
<h2>Osnovna ASM direktiva</h2>
<p><code>asm asm-qualifiers ( AssemblerInstructions )</code></p>
</section>
<section id="osnovna-asm-direktiva-1" class="slide level2">
<h2>Osnovna ASM direktiva</h2>
<ul>
<li>Gde <code>asm-qualifiers</code> može biti:
<ul>
<li><code>volatile</code> — kaže kompajleru da ne optimizuje,
podrazumevano za osnovni ASM kod</li>
<li><code>inline</code> — kaže kompajleru da minimizuje procenjenu
veličinu ASM koda</li>
</ul></li>
</ul>
</section>
<section id="assemblerinstructions" class="slide level2">
<h2>AssemblerInstructions</h2>
<ul>
<li>Sastoje se od više linija od kojih je svaka u navodima i svaka se
završava sa <code>\n\t</code></li>
</ul>
<pre><code>asm (&quot;movl %eax, %ebx\n\t&quot;
     &quot;movl $56, %esi\n\t&quot;
     &quot;movl %ecx, $label(%edx,%ebx,$4)\n\t&quot;
     &quot;movb %ah, (%ebx)&quot;);</code></pre>
</section>
<section id="ansi-standardan-c" class="slide level2">
<h2>ANSI standardan C</h2>
<ul>
<li>Ponekad, ako se želi držati strogog ANSI standarda, uzimajući u
obzir nešto neobičnih osobina ASM direktive u GCC-u, može se mesto ‘asm’
koristiti ‘<strong>asm</strong>.’ Nama to može trebati ako želimo da
koristimo -std opciju zbog C++11 opcija</li>
<li>GCC tretira obe stvari apsolutno identično.</li>
</ul>
</section>
<section id="proširen-asm" class="slide level2">
<h2>Proširen ASM</h2>
<ul>
<li>Osnovni ASM nema jednostavan način da radi sa C kodom. Recimo, ako
želite da u njemu modifikujete neku promenljivu iz C koda, to je
nemoguće.</li>
<li>Stoga postoji proširen ASM koji to dozvoljava i čija se upotreba
preporučuje.</li>
<li>Ograničenje u upotrebi ovakve ASM direktive jeste da se to mora
činiti iz nekakve funkcije/metode.</li>
</ul>
</section>
<section id="sintaksa-proširenog-asm-a-bez-naredbe-skoka"
class="slide level2">
<h2>Sintaksa proširenog ASM-a bez naredbe skoka</h2>
<pre><code>asm asm-qualifiers (
        AssemblerTemplate
        : OutputOperands
        : InputOperands
        : Clobbers
    )</code></pre>
</section>
<section id="sintaksa-proširenog-asm-a-sa-naredbama-skoka"
class="slide level2">
<h2>Sintaksa proširenog ASM-a sa naredbama skoka</h2>
<pre><code>asm asm-qualifiers (
        AssemblerTemplate
        :
        : InputOperands
        : Clobbers
        : GotoLabels
    )</code></pre>
</section>
<section id="asm-qualifiers" class="slide level2">
<h2><code>asm-qualifiers</code></h2>
<ul>
<li><code>volatile</code> — isključuje stanovite optmizacije što je
neophodno ako naš kod ima pobočne efekte, tj. ako radi nešto preko
manipulacije ulaznih u izlazne vrednosti.</li>
<li><code>inline</code> — kao ranije</li>
<li><code>goto</code> — informišemo kompajler da asm kod može skočiti na
neku od labela koje smo specificirali u ‘GotoLabels’ parametru. Ako je
to ikako moguće, ovo valja izbeći.</li>
</ul>
</section>
<section id="assemblertemplate" class="slide level2">
<h2>AssemblerTemplate</h2>
<ul>
<li>Ponaša se kao instrukcije kod osnovne ASM direktive uz dve ključne
razlike:
<ul>
<li>Kada označavamo registre, umesto da kažemo <code>%eax</code>,
recimo, moramo reći <code>%%eax</code>.</li>
<li>Možemo da mesto parametara asemblerskih instrukcija da stavimo
<code>%n</code> gde <code>n</code> nekakav broj i asm će umesto te
oznake umetnuti vrednost koju pod tim brojem prosleđujemo iz C koda kroz
specifikacije koje se nalaze u <code>OutputOperands</code> i
<code>InputOperands</code></li>
</ul></li>
</ul>
</section>
<section id="outputoperandsinputoperands" class="slide level2">
<h2>OutputOperands/InputOperands</h2>
<ul>
<li>U oba slučaja su zarezima razdvojene liste koje smeju biti
prazne.</li>
<li>U oba slučaja, takođe, elementi liste su oblika
<code>"ograničenje" (izraz)</code></li>
<li>Gde je ograničenje string sa raznim simbolima koji definišu kako
koristimo dati operand, dok je izraz nekakav C izraz (gotovo uvek
promenljiva) koju umećemo u naš ASM kod.</li>
</ul>
</section>
<section id="ograničenja" class="slide level2">
<h2>Ograničenja</h2>
<p><img data-src="img/2023-03-28-05-27-25.png" /></p>
</section>
<section id="ograničenja-1" class="slide level2">
<h2>Ograničenja</h2>
<p><img data-src="img/2023-03-28-05-27-47.png" /></p>
</section>
<section id="clobbers" class="slide level2">
<h2>Clobbers</h2>
<ul>
<li>Ovo je lista stringova u duplim navodnicima razdvojenih zarezima,
koja sadrži sve registre koji se menjaju kao pobočni efekat operacija
koje izvršavamo.</li>
<li>To govori kompajleru da ne očekuje da te vrednosti ostanu iste što
utiče na optimizaciju.</li>
<li>Osim što možemo staviti, npr, “eax” ili “ecx” ovde, može se navesti
i “memory” što znači da se modifikuje sadržaj memorije na koji se ne
referencira u output sekciji. Kod koji stavlja memory u clobber listu
mora biti volatile.</li>
</ul>
</section>
<section id="rukovanje-pojedinim-bitima-memorijskih-lokacija"
class="slide level2">
<h2>Rukovanje pojedinim bitima memorijskih lokacija</h2>
<ul>
<li>Emulacija hardvera je namenjena za platforme zasnovane na i386 (i
novijim) procesorima koji podržavaju asemblerske naredbe za:
<ul>
<li>dobijanje indeksa najznačajnijeg postavljenog bita u reči
<code>bsr</code></li>
<li>postavljanje datog bita reči <code>bts</code></li>
<li>za njegovo čišćenje <code>btr</code></li>
</ul></li>
<li>Funkcije <code>ad__get_index_of_most_signifcant_set_bit()</code>,
<code>ad__set_bit()</code> i <code>ad__clear_bit()</code> posreduju u
korišćenju ovih asemblerskih naredbi.</li>
</ul>
</section>
<section id="bitwise-asembler" class="slide level2">
<h2>Bitwise asembler</h2>
<div class="sourceCode" id="cb51" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb51-1"><a href="#cb51-1"></a><span class="kw">inline</span> <span class="at">static</span> <span class="dt">int</span></span>
<span id="cb51-2"><a href="#cb51-2"></a>ad__get_index_of_most_significant_set_bit<span class="op">(</span><span class="dt">unsigned</span> priority_bits<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-3"><a href="#cb51-3"></a>  <span class="dt">int</span> index<span class="op">;</span>               <span class="co">// poziv asm bit scan reverse</span></span>
<span id="cb51-4"><a href="#cb51-4"></a>  <span class="kw">asm</span><span class="op">(</span><span class="st">&quot;bsr %1, %0&quot;</span>         <span class="co">//%1 indeks msb, %0 ulazni biti</span></span>
<span id="cb51-5"><a href="#cb51-5"></a>      <span class="op">:</span> <span class="st">&quot;=r&quot;</span><span class="op">(</span>index<span class="op">)</span>        <span class="co">// uvek ide prvo izlazni operand</span></span>
<span id="cb51-6"><a href="#cb51-6"></a>      <span class="op">:</span> <span class="st">&quot;r&quot;</span><span class="op">(</span>priority_bits<span class="op">)</span> <span class="co">// pa ulazni operand</span></span>
<span id="cb51-7"><a href="#cb51-7"></a>  <span class="op">);</span></span></code></pre></div>
</section>
<section id="bitwise-asembler-1" class="slide level2">
<h2>Bitwise asembler</h2>
<div class="sourceCode" id="cb52" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb52-8"><a href="#cb52-8"></a>  <span class="cf">return</span> index<span class="op">;</span></span>
<span id="cb52-9"><a href="#cb52-9"></a><span class="op">}</span></span>
<span id="cb52-10"><a href="#cb52-10"></a></span>
<span id="cb52-11"><a href="#cb52-11"></a><span class="kw">inline</span> <span class="at">static</span> <span class="dt">unsigned</span> ad__set_bit<span class="op">(</span><span class="dt">unsigned</span> priority_bits<span class="op">,</span></span>
<span id="cb52-12"><a href="#cb52-12"></a>                                   <span class="dt">int</span> index<span class="op">)</span> <span class="op">{</span> <span class="co">// poziva asm bit test and set</span></span>
<span id="cb52-13"><a href="#cb52-13"></a>  <span class="kw">asm</span><span class="op">(</span><span class="st">&quot;bts %1, %0&quot;</span>                              <span class="co">//%1 indeks bita, %ulazni biti</span></span>
<span id="cb52-14"><a href="#cb52-14"></a>      <span class="op">:</span> <span class="st">&quot;=r&quot;</span><span class="op">(</span>priority_bits<span class="op">)</span>                     <span class="co">// ulazno izlazni operand pb</span></span></code></pre></div>
</section>
<section id="bitwise-asembler-2" class="slide level2">
<h2>Bitwise asembler</h2>
<div class="sourceCode" id="cb53" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb53-15"><a href="#cb53-15"></a>      <span class="op">:</span> <span class="st">&quot;r&quot;</span><span class="op">(</span>index<span class="op">),</span> <span class="st">&quot;0&quot;</span><span class="op">(</span>priority_bits<span class="op">)</span>          <span class="co">// ulazni operand indeks i</span></span>
<span id="cb53-16"><a href="#cb53-16"></a>  <span class="op">);</span>                                            <span class="co">// izlazni operand pb</span></span>
<span id="cb53-17"><a href="#cb53-17"></a>  <span class="cf">return</span> priority_bits<span class="op">;</span></span>
<span id="cb53-18"><a href="#cb53-18"></a><span class="op">}</span></span>
<span id="cb53-19"><a href="#cb53-19"></a></span>
<span id="cb53-20"><a href="#cb53-20"></a><span class="kw">inline</span> <span class="at">static</span> <span class="dt">int</span> ad__clear_bit<span class="op">(</span><span class="dt">unsigned</span> priority_bits<span class="op">,</span></span>
<span id="cb53-21"><a href="#cb53-21"></a>                                <span class="dt">int</span> index<span class="op">)</span> <span class="op">{</span> <span class="co">// poziva asm bit test and reset</span></span></code></pre></div>
</section>
<section id="bitwise-asembler-3" class="slide level2">
<h2>Bitwise asembler</h2>
<div class="sourceCode" id="cb54" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb54-22"><a href="#cb54-22"></a>  <span class="kw">asm</span><span class="op">(</span><span class="st">&quot;btr %1, %0&quot;</span> <span class="op">:</span> <span class="st">&quot;=r&quot;</span><span class="op">(</span>priority_bits<span class="op">)</span> <span class="op">:</span> <span class="st">&quot;r&quot;</span><span class="op">(</span>index<span class="op">),</span> <span class="st">&quot;0&quot;</span><span class="op">(</span>priority_bits<span class="op">));</span></span>
<span id="cb54-23"><a href="#cb54-23"></a>  <span class="cf">return</span> priority_bits<span class="op">;</span></span>
<span id="cb54-24"><a href="#cb54-24"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="rukovanje-numeričkim-koprocesorom" class="slide level2">
<h2>Rukovanje numeričkim koprocesorom</h2>
<ul>
<li>Preključivanje procesora sa jedne niti na drugu podrazumeva da se
sačuva kontekst (sadržaj registara) prve niti i uspostavi kontekst druge
niti.</li>
<li>Kontekst se čuva na steku niti i obuhvata i registre numeričkog
koprocesora.</li>
<li>Klasa <code>I387_npx</code> omogućuje pripremu i preuzimanje
inicijalnog sadržaja registara numeričkog koprocesora.</li>
<li>Konstruktor klase <code>I387_npx</code> inicijalizuje registre
numeričkog koprocesora i smešta njihov inicijalni sadržaj u polje
<code>initial_context</code> ove klase pomoću asemblerskih naredbi
<code>fninit</code> i <code>fnsave</code>.</li>
<li>Operacija <code>initial_context_get()</code> klase
<code>I387_npx</code> omogućuje preuzimanje inicijalnog sadržaja
registara numeričkog koprocesora.</li>
</ul>
</section>
<section id="rukovanje-fpu-mehanizmom" class="slide level2">
<h2>Rukovanje FPU mehanizmom</h2>
<div class="sourceCode" id="cb55" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb55-1"><a href="#cb55-1"></a><span class="at">const</span> <span class="dt">unsigned</span> i387_SAVE_REGION_SIZE <span class="op">=</span> <span class="bn">0x6c</span><span class="op">;</span> <span class="co">// velicina FPU steka</span></span>
<span id="cb55-2"><a href="#cb55-2"></a></span>
<span id="cb55-3"><a href="#cb55-3"></a><span class="kw">class</span> I387_npx <span class="op">{</span></span>
<span id="cb55-4"><a href="#cb55-4"></a>  <span class="at">static</span> <span class="dt">char</span> initial_context<span class="op">[</span>i387_SAVE_REGION_SIZE<span class="op">];</span></span>
<span id="cb55-5"><a href="#cb55-5"></a>  I387_npx<span class="op">(</span><span class="at">const</span> I387_npx <span class="op">&amp;);</span></span>
<span id="cb55-6"><a href="#cb55-6"></a>  I387_npx <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> I387_npx <span class="op">&amp;);</span></span></code></pre></div>
</section>
<section id="rukovanje-fpu-mehanizmom-1" class="slide level2">
<h2>Rukovanje FPU mehanizmom</h2>
<div class="sourceCode" id="cb56" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb56-8"><a href="#cb56-8"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb56-9"><a href="#cb56-9"></a>  I387_npx<span class="op">();</span></span>
<span id="cb56-10"><a href="#cb56-10"></a>  <span class="kw">inline</span> <span class="dt">void</span> initial_context_get<span class="op">(</span>Stack_item <span class="op">*</span>stack_top<span class="op">);</span></span>
<span id="cb56-11"><a href="#cb56-11"></a><span class="op">};</span></span>
<span id="cb56-12"><a href="#cb56-12"></a></span>
<span id="cb56-13"><a href="#cb56-13"></a><span class="dt">char</span> I387_npx<span class="op">::</span>initial_context<span class="op">[</span>i387_SAVE_REGION_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span></code></pre></div>
</section>
<section id="rukovanje-fpu-mehanizmom-2" class="slide level2">
<h2>Rukovanje FPU mehanizmom</h2>
<div class="sourceCode" id="cb57" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb57-15"><a href="#cb57-15"></a>I387_npx<span class="op">::</span>I387_npx<span class="op">()</span> <span class="op">{</span></span>
<span id="cb57-16"><a href="#cb57-16"></a>  <span class="kw">asm</span> <span class="at">volatile</span><span class="op">(</span>         <span class="co">// volatile indikacija kompajleru da ne optimizuje</span></span>
<span id="cb57-17"><a href="#cb57-17"></a>      <span class="st">&quot;fninit </span><span class="sc">\n\t</span><span class="st">&quot;</span>     <span class="co">// inicijalizacija FPU, status, tag, IP, DP</span></span>
<span id="cb57-18"><a href="#cb57-18"></a>      <span class="st">&quot;fnsavel %0 </span><span class="sc">\n\t</span><span class="st">&quot;</span> <span class="co">// sacuvaj FPU state u initial_context</span></span>
<span id="cb57-19"><a href="#cb57-19"></a>      <span class="op">:</span></span>
<span id="cb57-20"><a href="#cb57-20"></a>      <span class="op">:</span> <span class="st">&quot;m&quot;</span><span class="op">(*</span>initial_context<span class="op">));</span></span>
<span id="cb57-21"><a href="#cb57-21"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="rukovanje-fpu-mehanizmom-3" class="slide level2">
<h2>Rukovanje FPU mehanizmom</h2>
<div class="sourceCode" id="cb58" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb58-22"><a href="#cb58-22"></a></span>
<span id="cb58-23"><a href="#cb58-23"></a><span class="dt">void</span> I387_npx<span class="op">::</span>initial_context_get<span class="op">(</span>Stack_item <span class="op">*</span>stack_top<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-24"><a href="#cb58-24"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> i387_SAVE_REGION_SIZE<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb58-25"><a href="#cb58-25"></a>    <span class="op">((</span><span class="dt">char</span> <span class="op">*)</span>stack_top<span class="op">)[</span>i<span class="op">]</span> <span class="op">=</span> initial_context<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb58-26"><a href="#cb58-26"></a><span class="op">}</span></span>
<span id="cb58-27"><a href="#cb58-27"></a></span>
<span id="cb58-28"><a href="#cb58-28"></a><span class="at">static</span> I387_npx i387_npx<span class="op">;</span></span></code></pre></div>
</section>
<section id="rukovanje-stekom" class="slide level2">
<h2>Rukovanje stekom</h2>
<ul>
<li>Za uspeh preključivanja je neophodno da funkcija preključivanja na
steku druge niti zatekne ispravan frejm (ako je nit već bila aktivna)
ili ako ima spremljen inicijalni kontekst.</li>
<li>To je obezbeđeno kada se procesor preključuje na nit koja je već
bila aktivna. Ali, ako se procesor prvi put preključuje na neku nit, on
na njenom steku mora zateći frejm sa ranije pripremljenim njenim
inicijalnim kontekstom.</li>
</ul>
</section>
<section id="rukovanje-stekom-1" class="slide level2">
<h2>Rukovanje stekom</h2>
<ul>
<li>Podrazumeva se da prvo preključivanje na neku nit dovodi do početka
izvršavanja funkcije koja opisuje dotičnu nit.</li>
<li>Da bi izvršavanje ove funkcije bilo moguće, neophodno je na steku
niti pripremiti frejm njenog poziva sa odgovarajućom povratnom
adresom.</li>
<li>Kao povratna adresa služi adresa funkcije
<code>destroy()</code>.</li>
<li>Do izvršavanja funkcije koja opisuje nit dolazi nakon povratka iz
funkcije preključivanja, ako se na steku niti pripremi i frejm poziva
funkcije preključivanja u kome se kao povratna adresa koristi adresa
funkcije koja opisuje nit.</li>
<li>Pomenuta dva frejma (frejm poziva funkcije koja opisuje nit i frejm
poziva funkcije preključivanja) na steku stvarane niti pripremi funkcija
<code>ad__stack_init</code></li>
</ul>
</section>
<section id="inicijalizacija-steka" class="slide level2">
<h2>Inicijalizacija steka</h2>
<div class="sourceCode" id="cb59" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb59-1"><a href="#cb59-1"></a><span class="at">const</span> <span class="dt">int</span> INITIAL_FLAGS <span class="op">=</span> <span class="bn">0x0200</span><span class="op">;</span></span>
<span id="cb59-2"><a href="#cb59-2"></a></span>
<span id="cb59-3"><a href="#cb59-3"></a><span class="at">static</span> <span class="kw">inline</span> <span class="dt">void</span> ad__stack_init<span class="op">(</span>Stack_item <span class="op">**</span>stack_top<span class="op">,</span></span>
<span id="cb59-4"><a href="#cb59-4"></a>                                  <span class="dt">unsigned</span> thread_function<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-5"><a href="#cb59-5"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span>destroy<span class="op">;</span></span>
<span id="cb59-6"><a href="#cb59-6"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span>thread_function<span class="op">;</span></span>
<span id="cb59-7"><a href="#cb59-7"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="inicijalizacija-steka-1" class="slide level2">
<h2>Inicijalizacija steka</h2>
<div class="sourceCode" id="cb60" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb60-8"><a href="#cb60-8"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb60-9"><a href="#cb60-9"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span>INITIAL_FLAGS<span class="op">;</span></span>
<span id="cb60-10"><a href="#cb60-10"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb60-11"><a href="#cb60-11"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb60-12"><a href="#cb60-12"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb60-13"><a href="#cb60-13"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb60-14"><a href="#cb60-14"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="inicijalizacija-steka-2" class="slide level2">
<h2>Inicijalizacija steka</h2>
<div class="sourceCode" id="cb61" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb61-15"><a href="#cb61-15"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb61-16"><a href="#cb61-16"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb61-17"><a href="#cb61-17"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb61-18"><a href="#cb61-18"></a>  <span class="op">*</span>stack_top <span class="op">=</span> <span class="op">(</span>Stack_item <span class="op">*)(((</span><span class="dt">size_t</span><span class="op">)(*</span>stack_top<span class="op">))</span> <span class="op">-</span> i387_SAVE_REGION_SIZE<span class="op">);</span></span>
<span id="cb61-19"><a href="#cb61-19"></a>  i387_npx<span class="op">.</span>initial_context_get<span class="op">(*</span>stack_top<span class="op">);</span></span>
<span id="cb61-20"><a href="#cb61-20"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="inicijalizacija-steka-3" class="slide level2">
<h2>Inicijalizacija steka</h2>
<div class="sourceCode" id="cb62" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb62-22"><a href="#cb62-22"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> <span class="dt">void</span> ad__stack_swap<span class="op">(</span>Stack_item <span class="op">**</span><span class="at">const</span> old_stack<span class="op">,</span></span>
<span id="cb62-23"><a href="#cb62-23"></a>                               <span class="at">const</span> Stack_item <span class="op">*</span>new_stack<span class="op">);</span></span></code></pre></div>
</section>
<section id="šematski-prikaz-steka" class="slide level2">
<h2>Šematski prikaz steka</h2>
<p><img data-src="img/2023-03-28-06-11-43.png" /></p>
</section>
<section id="rukovanje-stekom-2" class="slide level2">
<h2>Rukovanje stekom</h2>
<ul>
<li>Funkcija <code>ad__stack_init</code> na stek smesti:
<ul>
<li>Adresu funkcije destroy() kao povratnu adresu funkcije koja opisuje
stvaranu nit</li>
<li>Adresu funkcije thread_function() kao povratnu adresu funkcije
preključivanja</li>
<li>Kontekst niti na koju se procesor prvi put preključuje:</li>
<li>Pokazivač prethodnog frejma (0) – nema prethodnog frejma</li>
<li>Početno stanje emuliranog bita prekida (true)</li>
<li>Početno stanje status (flag) registra – INITIAL_FLAGS</li>
<li>Početni sadržaj registara procesora (za registre opšte namene 0, za
sadržaj koprocesora rezultat poziva operacije initial_context_get()
klase i387_npx</li>
</ul></li>
</ul>
</section>
<section id="swap" class="slide level2">
<h2>Swap</h2>
<ul>
<li>Funkcija ad__stack_swap() ima ulogu funkcije preključivanja. Pošto
je ona napisana asemblerskim jezikom, radi provere ispravnosti njenih
poziva uvedena je njena C deklaracija.</li>
</ul>
</section>
<section id="swap-1" class="slide level2">
<h2>Swap</h2>
<div class="sourceCode" id="cb63" data-startFrom="1"><pre
class="sourceCode numberSource gnuassembler numberLines"><code class="sourceCode gnuassembler"><span id="cb63-1"><a href="#cb63-1"></a><span class="kw">.text</span></span>
<span id="cb63-2"><a href="#cb63-2"></a><span class="kw">.align</span> <span class="dv">2</span></span>
<span id="cb63-3"><a href="#cb63-3"></a><span class="kw">.globl</span> ad__stack_swap</span>
<span id="cb63-4"><a href="#cb63-4"></a></span>
<span id="cb63-5"><a href="#cb63-5"></a><span class="fu">ad__stack_swap:</span></span>
<span id="cb63-6"><a href="#cb63-6"></a>    <span class="kw">pushl</span> <span class="op">%</span><span class="kw">ebp</span>  <span class="op">//</span>cuvanje zatecenog pokazivaca stek frejma</span>
<span id="cb63-7"><a href="#cb63-7"></a>    <span class="kw">movl</span> <span class="op">%</span><span class="kw">esp</span><span class="op">,%</span><span class="kw">ebp</span>  <span class="op">//</span>postavljanje novog pokazivaca frejma</span></code></pre></div>
</section>
<section id="swap-2" class="slide level2">
<h2>Swap</h2>
<div class="sourceCode" id="cb64" data-startFrom="8"><pre
class="sourceCode numberSource gnuassembler numberLines"><code class="sourceCode gnuassembler" style="counter-reset: source-line 7;"><span id="cb64-8"><a href="#cb64-8"></a>    <span class="kw">movl</span> <span class="dv">8</span><span class="op">(%</span><span class="kw">ebp</span><span class="op">),%</span><span class="kw">edx</span><span class="op">//</span>adresa vrha steka iz deskriptora niti sa</span>
<span id="cb64-9"><a href="#cb64-9"></a>             <span class="op">//</span> koje se procesor prekljucuje</span>
<span id="cb64-10"><a href="#cb64-10"></a></span>
<span id="cb64-11"><a href="#cb64-11"></a>    mov interrupts_enabled<span class="op">,%</span><span class="kw">eax</span>  <span class="op">//</span>na stek aktivne niti se smesta</span>
<span id="cb64-12"><a href="#cb64-12"></a>    <span class="kw">push</span> <span class="op">%</span><span class="kw">eax</span>       <span class="op">//</span>zateceno stanje bita prekida</span>
<span id="cb64-13"><a href="#cb64-13"></a>    <span class="kw">pushf</span>           <span class="op">//</span>smestanje flags registra na stek</span>
<span id="cb64-14"><a href="#cb64-14"></a>    <span class="kw">pusha</span>           <span class="op">//</span>smestanje svih registara opste namene na stek</span></code></pre></div>
</section>
<section id="swap-3" class="slide level2">
<h2>Swap</h2>
<div class="sourceCode" id="cb65" data-startFrom="15"><pre
class="sourceCode numberSource gnuassembler numberLines"><code class="sourceCode gnuassembler" style="counter-reset: source-line 14;"><span id="cb65-15"><a href="#cb65-15"></a>    <span class="kw">sub</span> i387_SAVE_REGION_SIZE<span class="op">,%</span><span class="kw">esp</span></span>
<span id="cb65-16"><a href="#cb65-16"></a>    fnsavel <span class="op">(%</span><span class="kw">esp</span><span class="op">)</span>  <span class="op">//</span>smestanje sadrzaja reg koprocesora na stek</span>
<span id="cb65-17"><a href="#cb65-17"></a></span>
<span id="cb65-18"><a href="#cb65-18"></a>        mov <span class="op">%</span><span class="kw">esp</span><span class="op">,(%</span><span class="kw">edx</span><span class="op">)//</span>adresa vrha steka se smesti u deskriptor</span>
<span id="cb65-19"><a href="#cb65-19"></a>            <span class="op">//</span>do tada aktivne niti <span class="op">(</span>lokacija u <span class="op">%</span><span class="kw">edx</span><span class="op">)</span></span>
<span id="cb65-20"><a href="#cb65-20"></a>    mov <span class="dv">12</span><span class="op">(%</span><span class="kw">ebp</span><span class="op">),%</span><span class="kw">esp</span><span class="op">//</span>u pokazivac steka se prebaci adresa vrha</span>
<span id="cb65-21"><a href="#cb65-21"></a>            <span class="op">//</span>steka iz deskriptora novoaktivirane niti</span></code></pre></div>
</section>
<section id="swap-4" class="slide level2">
<h2>Swap</h2>
<div class="sourceCode" id="cb66" data-startFrom="22"><pre
class="sourceCode numberSource gnuassembler numberLines"><code class="sourceCode gnuassembler" style="counter-reset: source-line 21;"><span id="cb66-22"><a href="#cb66-22"></a>    frstorl <span class="op">(%</span><span class="kw">esp</span><span class="op">)</span>  <span class="op">//</span>sa novog steka se preuzmu novi sadrzaji</span>
<span id="cb66-23"><a href="#cb66-23"></a>                <span class="op">//</span>registara numerickog koprocesora</span>
<span id="cb66-24"><a href="#cb66-24"></a>    add i387_SAVE_REGION_SIZE<span class="op">,%</span><span class="kw">esp</span></span>
<span id="cb66-25"><a href="#cb66-25"></a>    <span class="kw">popa</span>        <span class="op">//</span>sa novog steka se preuzima sadrzaj</span>
<span id="cb66-26"><a href="#cb66-26"></a>            <span class="op">//</span>registara opste namene</span>
<span id="cb66-27"><a href="#cb66-27"></a>    <span class="kw">popf</span>        <span class="op">//</span>sa novog steka se preuzima sadrzaj</span>
<span id="cb66-28"><a href="#cb66-28"></a>            <span class="op">//</span>status registara flags</span></code></pre></div>
</section>
<section id="swap-5" class="slide level2">
<h2>Swap</h2>
<div class="sourceCode" id="cb67" data-startFrom="29"><pre
class="sourceCode numberSource gnuassembler numberLines"><code class="sourceCode gnuassembler" style="counter-reset: source-line 28;"><span id="cb67-29"><a href="#cb67-29"></a>    <span class="kw">pop</span> <span class="op">%</span><span class="kw">eax</span></span>
<span id="cb67-30"><a href="#cb67-30"></a>    mov <span class="op">%</span><span class="kw">eax</span><span class="op">,</span>interrupts_enabled <span class="op">//</span>sa novog steka se preuzme</span>
<span id="cb67-31"><a href="#cb67-31"></a>                    <span class="op">//</span>sadrzaj bita prekida i frejm</span>
<span id="cb67-32"><a href="#cb67-32"></a>                    <span class="op">//</span>pointera</span>
<span id="cb67-33"><a href="#cb67-33"></a>    <span class="kw">popl</span> <span class="op">%</span><span class="kw">ebp</span></span>
<span id="cb67-34"><a href="#cb67-34"></a>    <span class="kw">ret</span></span></code></pre></div>
</section></section>
<section>
<section id="izvršilac-simulatora" class="title-slide slide level1">
<h1>Izvršilac simulatora</h1>

</section>
<section id="delovi-cpptss-izvršioca" class="slide level2">
<h2>Delovi CppTss izvršioca</h2>
<ul>
<li>Deo CppTss-a koji ima ulogu jezgra operativnog sistema se naziva
izvršilac.</li>
<li>Funkcionalna sličnost CppTss izvršioca sa operativnim sistemom ima
za posledicu sličnost njihovih izvedbi.</li>
<li>Struktura CppTss izvršioca se može predstaviti pomoću istih slojeva
kao i struktura operativnog sistema.</li>
<li>Ključna razlika je da CppTss izvršilac ne sadrži modul za rukovanje
datotekama, jer CppTss ne podržava pojam datoteke.</li>
</ul>
</section>
<section id="delovi-cpptss-izvršioca-1" class="slide level2">
<h2>Delovi CppTss izvršioca</h2>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="header">
<th>Modul</th>
<th>Elementi u kodu</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>sistemske niti</td>
<td>thread_wake_up_deamon() thread_destroyer_deamon() thread_zero()
klasa Delta</td>
</tr>
<tr class="even">
<td>modul za rukovanje procesima</td>
<td>klasa thread klasa Thread_image</td>
</tr>
<tr class="odd">
<td>modul za rukovanje datotekama</td>
<td>-</td>
</tr>
<tr class="even">
<td>modul za rukovanje random memorijom</td>
<td>klasa Memory_fragment</td>
</tr>
</tbody>
</table>
</section>
<section id="delovi-cpptss-izvršioca-2" class="slide level2">
<h2>Delovi CppTss izvršioca</h2>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="header">
<th>Modul</th>
<th>Elementi u kodu</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>modul za rukovanje kontrolerima</td>
<td>klasa Timer_driver klasa Exception_driver klasa Driver</td>
</tr>
<tr class="even">
<td>modul za rukovanje procesorom</td>
<td>klasa condition_variable klasa unique_lock klasa mutex klasa Kernel
klasa Atomic_region klasa Ready_list klasa Descriptor klasa Permit klasa
List_link klasa Failure</td>
</tr>
</tbody>
</table>
</section>
<section id="klasa-failure" class="slide level2">
<h2>Klasa Failure</h2>
<div class="sourceCode" id="cb68" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb68-1"><a href="#cb68-1"></a><span class="kw">enum</span> Failure_codes <span class="op">{</span> MEMORY_SHORTAGE<span class="op">,</span> NOTIFY_OUTSIDE_EXCLUSIVE_REGION <span class="op">};</span></span>
<span id="cb68-2"><a href="#cb68-2"></a><span class="kw">class</span> Failure <span class="op">{</span></span>
<span id="cb68-3"><a href="#cb68-3"></a><span class="kw">protected</span><span class="op">:</span></span>
<span id="cb68-4"><a href="#cb68-4"></a>  <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span>f_name<span class="op">;</span></span>
<span id="cb68-5"><a href="#cb68-5"></a>  Failure_codes f_code<span class="op">;</span></span>
<span id="cb68-6"><a href="#cb68-6"></a></span>
<span id="cb68-7"><a href="#cb68-7"></a><span class="kw">public</span><span class="op">:</span></span></code></pre></div>
</section>
<section id="klasa-failure-1" class="slide level2">
<h2>Klasa Failure</h2>
<div class="sourceCode" id="cb69" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb69-8"><a href="#cb69-8"></a>  Failure<span class="op">(</span><span class="at">const</span> <span class="dt">char</span> <span class="op">*</span>fname<span class="op">,</span> <span class="at">const</span> Failure_codes fcode<span class="op">)</span></span>
<span id="cb69-9"><a href="#cb69-9"></a>      <span class="op">:</span> f_name<span class="op">(</span>fname<span class="op">),</span> f_code<span class="op">(</span>fcode<span class="op">){};</span></span>
<span id="cb69-10"><a href="#cb69-10"></a>  <span class="kw">inline</span> <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">()</span> <span class="at">const</span> <span class="op">{</span> <span class="cf">return</span> f_name<span class="op">;</span> <span class="op">};</span></span>
<span id="cb69-11"><a href="#cb69-11"></a>  <span class="kw">inline</span> Failure_codes code<span class="op">()</span> <span class="at">const</span> <span class="op">{</span> <span class="cf">return</span> f_code<span class="op">;</span> <span class="op">};</span></span>
<span id="cb69-12"><a href="#cb69-12"></a><span class="op">};</span></span>
<span id="cb69-13"><a href="#cb69-13"></a>Failure failure_memory_shortage<span class="op">(</span><span class="st">&quot;MEMORY SHORTAGE!&quot;</span><span class="op">,</span> MEMORY_SHORTAGE<span class="op">);</span></span>
<span id="cb69-14"><a href="#cb69-14"></a>Failure</span></code></pre></div>
</section>
<section id="klasa-failure-2" class="slide level2">
<h2>Klasa Failure</h2>
<div class="sourceCode" id="cb70" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb70-15"><a href="#cb70-15"></a>    failure_notify_outside_exclusive_region<span class="op">(</span><span class="st">&quot;NOTIFY OUTSIDE EXCLUSIVE REGION!&quot;</span><span class="op">,</span></span>
<span id="cb70-16"><a href="#cb70-16"></a>                                            NOTIFY_OUTSIDE_EXCLUSIVE_REGION<span class="op">);</span></span></code></pre></div>
</section>
<section id="klasa-list_link" class="slide level2">
<h2>Klasa List_link</h2>
<div class="sourceCode" id="cb71" data-startFrom="17"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 16;"><span id="cb71-17"><a href="#cb71-17"></a><span class="kw">class</span> List_link <span class="op">{</span></span>
<span id="cb71-18"><a href="#cb71-18"></a>  List_link <span class="op">*</span>left<span class="op">;</span></span>
<span id="cb71-19"><a href="#cb71-19"></a>  List_link <span class="op">*</span>right<span class="op">;</span></span>
<span id="cb71-20"><a href="#cb71-20"></a>  List_link<span class="op">(</span><span class="at">const</span> List_link <span class="op">&amp;);</span></span>
<span id="cb71-21"><a href="#cb71-21"></a>  List_link <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> List_link <span class="op">&amp;);</span></span>
<span id="cb71-22"><a href="#cb71-22"></a></span>
<span id="cb71-23"><a href="#cb71-23"></a><span class="kw">public</span><span class="op">:</span></span></code></pre></div>
</section>
<section id="klasa-list_link-1" class="slide level2">
<h2>Klasa List_link</h2>
<div class="sourceCode" id="cb72" data-startFrom="24"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 23;"><span id="cb72-24"><a href="#cb72-24"></a>  List_link<span class="op">()</span> <span class="op">{</span></span>
<span id="cb72-25"><a href="#cb72-25"></a>    right <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb72-26"><a href="#cb72-26"></a>    left <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb72-27"><a href="#cb72-27"></a>  <span class="op">};</span></span>
<span id="cb72-28"><a href="#cb72-28"></a>  List_link <span class="op">*</span>left_get<span class="op">()</span> <span class="at">const</span> <span class="op">{</span> <span class="cf">return</span> left<span class="op">;</span> <span class="op">};</span></span>
<span id="cb72-29"><a href="#cb72-29"></a>  List_link <span class="op">*</span>right_get<span class="op">()</span> <span class="at">const</span> <span class="op">{</span> <span class="cf">return</span> right<span class="op">;</span> <span class="op">};</span></span>
<span id="cb72-30"><a href="#cb72-30"></a>  <span class="dt">void</span> insert<span class="op">(</span>List_link <span class="op">*</span><span class="at">const</span> link<span class="op">);</span></span></code></pre></div>
</section>
<section id="klasa-list_link-2" class="slide level2">
<h2>Klasa List_link</h2>
<div class="sourceCode" id="cb73" data-startFrom="31"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 30;"><span id="cb73-31"><a href="#cb73-31"></a>  List_link <span class="op">*</span>extract<span class="op">();</span></span>
<span id="cb73-32"><a href="#cb73-32"></a>  <span class="dt">bool</span> empty<span class="op">()</span> <span class="at">const</span> <span class="op">{</span> <span class="cf">return</span> <span class="op">(</span><span class="kw">this</span> <span class="op">==</span> right<span class="op">);</span> <span class="op">};</span></span>
<span id="cb73-33"><a href="#cb73-33"></a>  <span class="dt">bool</span> not_empty<span class="op">()</span> <span class="at">const</span> <span class="op">{</span> <span class="cf">return</span> <span class="op">!</span>empty<span class="op">();</span> <span class="op">};</span></span>
<span id="cb73-34"><a href="#cb73-34"></a><span class="op">};</span></span>
<span id="cb73-35"><a href="#cb73-35"></a><span class="dt">void</span> List_link<span class="op">::</span>insert<span class="op">(</span>List_link <span class="op">*</span><span class="at">const</span> link<span class="op">)</span> <span class="op">{</span></span>
<span id="cb73-36"><a href="#cb73-36"></a>  link<span class="op">-&gt;</span>left <span class="op">=</span> left<span class="op">;</span></span>
<span id="cb73-37"><a href="#cb73-37"></a>  link<span class="op">-&gt;</span>right <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-list_link-3" class="slide level2">
<h2>Klasa List_link</h2>
<div class="sourceCode" id="cb74" data-startFrom="38"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 37;"><span id="cb74-38"><a href="#cb74-38"></a>  left<span class="op">-&gt;</span>right <span class="op">=</span> link<span class="op">;</span></span>
<span id="cb74-39"><a href="#cb74-39"></a>  left <span class="op">=</span> link<span class="op">;</span></span>
<span id="cb74-40"><a href="#cb74-40"></a><span class="op">}</span></span>
<span id="cb74-41"><a href="#cb74-41"></a>List_link <span class="op">*</span>List_link<span class="op">::</span>extract<span class="op">()</span> <span class="op">{</span></span>
<span id="cb74-42"><a href="#cb74-42"></a>  List_link <span class="op">*</span>p <span class="op">=</span> right<span class="op">;</span></span>
<span id="cb74-43"><a href="#cb74-43"></a>  right<span class="op">-&gt;</span>right<span class="op">-&gt;</span>left <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb74-44"><a href="#cb74-44"></a>  right <span class="op">=</span> right<span class="op">-&gt;</span>right<span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-list_link-4" class="slide level2">
<h2>Klasa List_link</h2>
<div class="sourceCode" id="cb75" data-startFrom="45"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 44;"><span id="cb75-45"><a href="#cb75-45"></a>  <span class="cf">return</span> p<span class="op">;</span></span>
<span id="cb75-46"><a href="#cb75-46"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-list_link-5" class="slide level2">
<h2>Klasa List_link</h2>
<ul>
<li>Klasa List_link omogućuje obrazovanje dvosmerne cirkularne
liste.</li>
<li>Nju predstavlja objekat ove klase, koji tada istovremeno služi kao
njen početak i kraj.</li>
<li>Takođe se podrazumeva da se oni uvezuju na njen kraj i da se
izvezuju sa njenog početka.</li>
<li>Dvosmerna cirkularna lista se obrazuje pomoću polja left i
right.</li>
<li>Operacije klase List_link omogućuju preuzimanje vrednosti ovih
polja: left_get(), right_get()</li>
<li>uvezivanje novog elementa na kraj liste - insert()</li>
<li>izvezivanje elementa sa početka liste - extract()</li>
<li>proveru da li u listi ima uvezanih elemenata - not_empty()</li>
<li>proveru da li je lista prazna - empty()</li>
</ul>
</section>
<section id="klasa-list_link-6" class="slide level2">
<h2>Klasa List_link</h2>
<p><img data-src="./img//image.png" /></p>
</section>
<section id="klasa-permit" class="slide level2">
<h2>Klasa Permit</h2>
<div class="sourceCode" id="cb76" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb76-1"><a href="#cb76-1"></a><span class="kw">class</span> Permit <span class="op">{</span></span>
<span id="cb76-2"><a href="#cb76-2"></a>  <span class="dt">bool</span> free<span class="op">;</span></span>
<span id="cb76-3"><a href="#cb76-3"></a>  Permit <span class="op">*</span>previous<span class="op">;</span></span>
<span id="cb76-4"><a href="#cb76-4"></a>  List_link admission_list<span class="op">;</span></span>
<span id="cb76-5"><a href="#cb76-5"></a>  List_link fulfilled_list<span class="op">;</span></span>
<span id="cb76-6"><a href="#cb76-6"></a></span>
<span id="cb76-7"><a href="#cb76-7"></a><span class="kw">public</span><span class="op">:</span></span></code></pre></div>
</section>
<section id="klasa-permit-1" class="slide level2">
<h2>Klasa Permit</h2>
<div class="sourceCode" id="cb77" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb77-8"><a href="#cb77-8"></a>  Permit<span class="op">()</span> <span class="op">{</span></span>
<span id="cb77-9"><a href="#cb77-9"></a>    free <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb77-10"><a href="#cb77-10"></a>    previous <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb77-11"><a href="#cb77-11"></a>  <span class="op">};</span></span>
<span id="cb77-12"><a href="#cb77-12"></a>  <span class="kw">inline</span> <span class="dt">bool</span> not_free<span class="op">()</span> <span class="at">const</span> <span class="op">{</span> <span class="cf">return</span> <span class="op">(</span>free <span class="op">==</span> <span class="kw">false</span><span class="op">);</span> <span class="op">};</span></span>
<span id="cb77-13"><a href="#cb77-13"></a>  <span class="kw">inline</span> <span class="dt">void</span> take<span class="op">()</span> <span class="op">{</span> free <span class="op">=</span> <span class="kw">false</span><span class="op">;</span> <span class="op">};</span></span>
<span id="cb77-14"><a href="#cb77-14"></a>  <span class="kw">inline</span> <span class="dt">void</span> release<span class="op">()</span> <span class="op">{</span> free <span class="op">=</span> <span class="kw">true</span><span class="op">;</span> <span class="op">};</span></span></code></pre></div>
</section>
<section id="klasa-permit-2" class="slide level2">
<h2>Klasa Permit</h2>
<div class="sourceCode" id="cb78" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb78-15"><a href="#cb78-15"></a>  <span class="kw">inline</span> <span class="dt">void</span> admission_insert<span class="op">(</span>List_link <span class="op">*</span>link<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-16"><a href="#cb78-16"></a>    admission_list<span class="op">.</span>insert<span class="op">(</span>link<span class="op">);</span></span>
<span id="cb78-17"><a href="#cb78-17"></a>  <span class="op">};</span></span>
<span id="cb78-18"><a href="#cb78-18"></a>  <span class="kw">inline</span> <span class="dt">void</span> fulfilled_insert<span class="op">(</span>List_link <span class="op">*</span>link<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-19"><a href="#cb78-19"></a>    fulfilled_list<span class="op">.</span>insert<span class="op">(</span>link<span class="op">);</span></span>
<span id="cb78-20"><a href="#cb78-20"></a>  <span class="op">};</span></span>
<span id="cb78-21"><a href="#cb78-21"></a>  <span class="kw">inline</span> List_link <span class="op">*</span>admission_extract<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> admission_list<span class="op">.</span>extract<span class="op">();</span> <span class="op">};</span></span></code></pre></div>
</section>
<section id="klasa-permit-3" class="slide level2">
<h2>Klasa Permit</h2>
<div class="sourceCode" id="cb79" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb79-22"><a href="#cb79-22"></a>  <span class="kw">inline</span> List_link <span class="op">*</span>fulfilled_extract<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> fulfilled_list<span class="op">.</span>extract<span class="op">();</span> <span class="op">};</span></span>
<span id="cb79-23"><a href="#cb79-23"></a>  <span class="kw">inline</span> <span class="dt">bool</span> admission_not_empty<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> admission_list<span class="op">.</span>not_empty<span class="op">();</span> <span class="op">};</span></span>
<span id="cb79-24"><a href="#cb79-24"></a>  <span class="kw">inline</span> <span class="dt">bool</span> fulfilled_not_empty<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> fulfilled_list<span class="op">.</span>not_empty<span class="op">();</span> <span class="op">};</span></span>
<span id="cb79-25"><a href="#cb79-25"></a>  <span class="kw">friend</span> <span class="kw">class</span> Descriptor<span class="op">;</span></span>
<span id="cb79-26"><a href="#cb79-26"></a><span class="op">};</span></span></code></pre></div>
</section>
<section id="klasa-permit-4" class="slide level2">
<h2>Klasa Permit</h2>
<ul>
<li>Klasa Permit opisuje rukovanje propusnicama. Polje free klase Permit
čuva stanje propusnice.</li>
<li>Lista (polje previous) je vezana za nit koja je dobila pomenute
propusnice. Propusnice se uvezuju u ovu listu u redosledu u kome ih je
nit dobila, a izvezuju iz nje u obrnutom redosledu, jer se u obrnutom
redosledu propusnice vraćaju.</li>
<li>Oko polja admission_list klase Permit se obrazuje lista deskriptora
niti koje čekaju na propusnicu da bi ušle u isključivi region, a oko
njenog polja fulfiled_list se obrazuje lista deskriptora niti koje
čekaju na propusnicu nakon ispunjenja uslova.</li>
</ul>
</section>
<section id="klasa-permit-5" class="slide level2">
<h2>Klasa Permit</h2>
<ul>
<li>Operacije klase Permit:</li>
<li>not_free() - da li je propusnica zauzeta</li>
<li>take() - zauzimanje propusnice</li>
<li>release() - oslobadjanje propusnice</li>
<li>admission_insert(), admission_extract(), admission_not_empty(),
fullfilled_insert(), fulfilled_extract(), fulfilled_not_empty() - za
rukovanje listama deskriptora niti</li>
</ul>
</section>
<section id="klasa-permit-6" class="slide level2">
<h2>Klasa Permit</h2>
<ul>
<li>Pozivi operacija not_free() i take() moraju biti u istom atomskom
regionu , inače se može desiti da više niti jedna za drugom, proverom
ustanovi da je ista propusnica slobodna i da zatim, jedna za drugom,
zauzme istu propusnicu.</li>
<li>Pozivi operacija za rukovanje listama deskriptora moraju biti u
atomskom regionu.</li>
</ul>
</section>
<section id="klasa-descriptor" class="slide level2">
<h2>Klasa Descriptor</h2>
<div class="sourceCode" id="cb80" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb80-1"><a href="#cb80-1"></a><span class="kw">typedef</span> <span class="dt">int</span> Stack_item<span class="op">;</span></span>
<span id="cb80-2"><a href="#cb80-2"></a><span class="kw">class</span> Descriptor <span class="op">:</span> <span class="kw">private</span> List_link <span class="op">{</span> <span class="co">// nasledjuje se klasa List_link</span></span>
<span id="cb80-3"><a href="#cb80-3"></a>  <span class="co">// da bi bilo moguce deskriptore niti uvezivati u liste</span></span>
<span id="cb80-4"><a href="#cb80-4"></a><span class="kw">protected</span><span class="op">:</span></span>
<span id="cb80-5"><a href="#cb80-5"></a>  Stack_item <span class="op">*</span>stack_top<span class="op">;</span> <span class="co">// pokazivac na vrh steka niti</span></span>
<span id="cb80-6"><a href="#cb80-6"></a>  <span class="dt">int</span> priority<span class="op">;</span>          <span class="co">// prioritet niti</span></span>
<span id="cb80-7"><a href="#cb80-7"></a>  Permit <span class="op">*</span>last<span class="op">;</span>          <span class="co">// adresa poslednje dobijene propusnice</span></span></code></pre></div>
</section>
<section id="klasa-descriptor-1" class="slide level2">
<h2>Klasa Descriptor</h2>
<div class="sourceCode" id="cb81" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb81-8"><a href="#cb81-8"></a>  <span class="dt">unsigned</span> tag<span class="op">;</span>          <span class="co">// privezak deskriptora niti</span></span>
<span id="cb81-9"><a href="#cb81-9"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb81-10"><a href="#cb81-10"></a>  Descriptor<span class="op">();</span></span>
<span id="cb81-11"><a href="#cb81-11"></a>  <span class="kw">inline</span> <span class="dt">unsigned</span> tag_get<span class="op">()</span> <span class="at">const</span> <span class="op">{</span> <span class="cf">return</span> tag<span class="op">;</span> <span class="op">};</span></span>
<span id="cb81-12"><a href="#cb81-12"></a>  <span class="kw">inline</span> <span class="dt">void</span> tag_set<span class="op">(</span><span class="dt">unsigned</span> t<span class="op">)</span> <span class="op">{</span> tag <span class="op">=</span> t<span class="op">;</span> <span class="op">};</span></span>
<span id="cb81-13"><a href="#cb81-13"></a>  <span class="kw">inline</span> <span class="dt">void</span> link_permit<span class="op">(</span>Permit <span class="op">*</span><span class="at">const</span> permit<span class="op">);</span> <span class="co">// uvezivanje</span></span>
<span id="cb81-14"><a href="#cb81-14"></a>  <span class="co">// propusnice u listu propusnica prilikom ulaska niti u kriticnu sekciju</span></span></code></pre></div>
</section>
<section id="klasa-descriptor-2" class="slide level2">
<h2>Klasa Descriptor</h2>
<div class="sourceCode" id="cb82" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb82-15"><a href="#cb82-15"></a>  <span class="kw">inline</span> Permit <span class="op">*</span>ulink_permit<span class="op">();</span> <span class="co">// izvezivanje propusnice iz</span></span>
<span id="cb82-16"><a href="#cb82-16"></a>  <span class="co">// liste propusnica niti prilikom njenog izlazka iz kriticne sekcije</span></span>
<span id="cb82-17"><a href="#cb82-17"></a>  <span class="kw">friend</span> <span class="kw">class</span> Ready_list<span class="op">;</span></span>
<span id="cb82-18"><a href="#cb82-18"></a>  <span class="kw">friend</span> <span class="kw">class</span> Kernel<span class="op">;</span></span>
<span id="cb82-19"><a href="#cb82-19"></a>  <span class="kw">friend</span> <span class="kw">class</span> thread<span class="op">;</span></span>
<span id="cb82-20"><a href="#cb82-20"></a><span class="op">};</span></span>
<span id="cb82-21"><a href="#cb82-21"></a>Descriptor<span class="op">::</span>Descriptor<span class="op">()</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="klasa-descriptor-3" class="slide level2">
<h2>Klasa Descriptor</h2>
<div class="sourceCode" id="cb83" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb83-22"><a href="#cb83-22"></a>  stack_top <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb83-23"><a href="#cb83-23"></a>  priority <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb83-24"><a href="#cb83-24"></a>  last <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb83-25"><a href="#cb83-25"></a>  tag <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb83-26"><a href="#cb83-26"></a><span class="op">}</span></span>
<span id="cb83-27"><a href="#cb83-27"></a><span class="dt">void</span> Descriptor<span class="op">::</span>link_permit<span class="op">(</span>Permit <span class="op">*</span><span class="at">const</span> permit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-28"><a href="#cb83-28"></a>  permit<span class="op">-&gt;</span>previous <span class="op">=</span> last<span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-descriptor-4" class="slide level2">
<h2>Klasa Descriptor</h2>
<div class="sourceCode" id="cb84" data-startFrom="29"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 28;"><span id="cb84-29"><a href="#cb84-29"></a>  last <span class="op">=</span> permit<span class="op">;</span></span>
<span id="cb84-30"><a href="#cb84-30"></a><span class="op">}</span></span>
<span id="cb84-31"><a href="#cb84-31"></a>Permit <span class="op">*</span>Descriptor<span class="op">::</span>ulink_permit<span class="op">()</span> <span class="op">{</span></span>
<span id="cb84-32"><a href="#cb84-32"></a>  Permit <span class="op">*</span>permit <span class="op">=</span> last<span class="op">;</span></span>
<span id="cb84-33"><a href="#cb84-33"></a>  last <span class="op">=</span> permit<span class="op">-&gt;</span>previous<span class="op">;</span></span>
<span id="cb84-34"><a href="#cb84-34"></a>  <span class="cf">return</span> permit<span class="op">;</span></span>
<span id="cb84-35"><a href="#cb84-35"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-descriptor-5" class="slide level2">
<h2>Klasa Descriptor</h2>
<ul>
<li>Klasa Descriptor određuje deskriptor niti.</li>
<li>Ona nasleđuje klasu List_link, da bi bilo moguće deskriptore niti
uvezivati u liste.</li>
<li>Polje stack_top klase Descriptor sadrži pokazivač (adresu) vrha
steka niti.</li>
<li>Prioritet niti je sadržan u polju priority ove klase.</li>
<li>Polje last klase Descriptor sadrži adresu poslednje dobijene
propusnice.</li>
<li>Polje tag ove klase je namenjeno za smeštanje priveska deskriptora
niti.</li>
</ul>
</section>
<section id="klasa-descriptor-6" class="slide level2">
<h2>Klasa Descriptor</h2>
<ul>
<li>Klasa Descriptor nudi operacije za pristup nekim od njenih polja:
tag_get(), tag_set(), kao i operacije za uvezivanje propusnice u listu
propusnica niti prilikom njenog ulaska u kritični region: link_permit(),
odnosno za izvezivanje propusnice iz liste propusnica niti prilikom
njenog izlaska iz kritičnog regiona: ulink_permit().</li>
</ul>
</section>
<section id="klasa-ready_list" class="slide level2">
<h2>Klasa Ready_list</h2>
<div class="sourceCode" id="cb85" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb85-1"><a href="#cb85-1"></a><span class="at">const</span> <span class="dt">unsigned</span> PRIORITY_NUMBER <span class="op">=</span> <span class="dv">32</span><span class="op">;</span></span>
<span id="cb85-2"><a href="#cb85-2"></a><span class="kw">enum</span> Priority <span class="op">{</span></span>
<span id="cb85-3"><a href="#cb85-3"></a>  TERMINAL <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span></span>
<span id="cb85-4"><a href="#cb85-4"></a>  ZERO <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb85-5"><a href="#cb85-5"></a>  PR01<span class="op">,</span></span>
<span id="cb85-6"><a href="#cb85-6"></a>  PR02<span class="op">,</span></span>
<span id="cb85-7"><a href="#cb85-7"></a>  PR03<span class="op">,</span></span></code></pre></div>
</section>
<section id="klasa-ready_list-1" class="slide level2">
<h2>Klasa Ready_list</h2>
<div class="sourceCode" id="cb86" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb86-8"><a href="#cb86-8"></a>  PR04<span class="op">,</span></span>
<span id="cb86-9"><a href="#cb86-9"></a>  PR05<span class="op">,</span></span>
<span id="cb86-10"><a href="#cb86-10"></a>  PR06<span class="op">,</span></span>
<span id="cb86-11"><a href="#cb86-11"></a>  PR07<span class="op">,</span></span>
<span id="cb86-12"><a href="#cb86-12"></a>  PR08<span class="op">,</span></span>
<span id="cb86-13"><a href="#cb86-13"></a>  PR09<span class="op">,</span></span>
<span id="cb86-14"><a href="#cb86-14"></a>  PR10<span class="op">,</span></span></code></pre></div>
</section>
<section id="klasa-ready_list-2" class="slide level2">
<h2>Klasa Ready_list</h2>
<div class="sourceCode" id="cb87" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb87-15"><a href="#cb87-15"></a>  PR11<span class="op">,</span></span>
<span id="cb87-16"><a href="#cb87-16"></a>  PR12<span class="op">,</span></span>
<span id="cb87-17"><a href="#cb87-17"></a>  PR13<span class="op">,</span></span>
<span id="cb87-18"><a href="#cb87-18"></a>  PR14<span class="op">,</span></span>
<span id="cb87-19"><a href="#cb87-19"></a>  PR15<span class="op">,</span></span>
<span id="cb87-20"><a href="#cb87-20"></a>  PR16<span class="op">,</span></span>
<span id="cb87-21"><a href="#cb87-21"></a>  PR17<span class="op">,</span></span></code></pre></div>
</section>
<section id="klasa-ready_list-3" class="slide level2">
<h2>Klasa Ready_list</h2>
<div class="sourceCode" id="cb88" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb88-22"><a href="#cb88-22"></a>  PR18<span class="op">,</span></span>
<span id="cb88-23"><a href="#cb88-23"></a>  PR19<span class="op">,</span></span>
<span id="cb88-24"><a href="#cb88-24"></a>  PR20<span class="op">,</span></span>
<span id="cb88-25"><a href="#cb88-25"></a>  PR21<span class="op">,</span></span>
<span id="cb88-26"><a href="#cb88-26"></a>  PR22<span class="op">,</span></span>
<span id="cb88-27"><a href="#cb88-27"></a>  PR23<span class="op">,</span></span>
<span id="cb88-28"><a href="#cb88-28"></a>  PR24<span class="op">,</span></span></code></pre></div>
</section>
<section id="klasa-ready_list-4" class="slide level2">
<h2>Klasa Ready_list</h2>
<div class="sourceCode" id="cb89" data-startFrom="29"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 28;"><span id="cb89-29"><a href="#cb89-29"></a>  PR25<span class="op">,</span></span>
<span id="cb89-30"><a href="#cb89-30"></a>  PR26<span class="op">,</span></span>
<span id="cb89-31"><a href="#cb89-31"></a>  PR27<span class="op">,</span></span>
<span id="cb89-32"><a href="#cb89-32"></a>  PR28<span class="op">,</span></span>
<span id="cb89-33"><a href="#cb89-33"></a>  PR29<span class="op">,</span></span>
<span id="cb89-34"><a href="#cb89-34"></a>  PR30<span class="op">,</span></span>
<span id="cb89-35"><a href="#cb89-35"></a>  SYSTEM <span class="op">=</span> <span class="dv">31</span></span></code></pre></div>
</section>
<section id="klasa-ready_list-5" class="slide level2">
<h2>Klasa Ready_list</h2>
<div class="sourceCode" id="cb90" data-startFrom="36"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 35;"><span id="cb90-36"><a href="#cb90-36"></a><span class="op">};</span></span>
<span id="cb90-37"><a href="#cb90-37"></a><span class="kw">class</span> Ready_list <span class="op">{</span></span>
<span id="cb90-38"><a href="#cb90-38"></a>  <span class="dt">unsigned</span> priority_bits<span class="op">;</span></span>
<span id="cb90-39"><a href="#cb90-39"></a>  List_link ready<span class="op">[</span>PRIORITY_NUMBER<span class="op">];</span></span>
<span id="cb90-40"><a href="#cb90-40"></a>  Ready_list<span class="op">(</span><span class="at">const</span> Ready_list <span class="op">&amp;);</span></span>
<span id="cb90-41"><a href="#cb90-41"></a>  Ready_list <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Ready_list <span class="op">&amp;);</span></span></code></pre></div>
</section>
<section id="klasa-ready_list-6" class="slide level2">
<h2>Klasa Ready_list</h2>
<div class="sourceCode" id="cb91" data-startFrom="43"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 42;"><span id="cb91-43"><a href="#cb91-43"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb91-44"><a href="#cb91-44"></a>  Ready_list<span class="op">()</span> <span class="op">:</span> priority_bits<span class="op">(</span><span class="dv">0</span><span class="op">){};</span></span>
<span id="cb91-45"><a href="#cb91-45"></a>  <span class="dt">int</span> highest<span class="op">()</span> <span class="at">const</span><span class="op">;</span></span>
<span id="cb91-46"><a href="#cb91-46"></a>  <span class="dt">void</span> insert<span class="op">(</span>Descriptor <span class="op">*</span>d<span class="op">);</span></span>
<span id="cb91-47"><a href="#cb91-47"></a>  Descriptor <span class="op">*</span>extract<span class="op">();</span></span>
<span id="cb91-48"><a href="#cb91-48"></a>  <span class="dt">bool</span> higher_than<span class="op">(</span>Descriptor <span class="op">*</span>d<span class="op">)</span> <span class="at">const</span><span class="op">;</span></span>
<span id="cb91-49"><a href="#cb91-49"></a><span class="op">};</span></span></code></pre></div>
</section>
<section id="klasa-ready_list-7" class="slide level2">
<h2>Klasa Ready_list</h2>
<div class="sourceCode" id="cb92" data-startFrom="50"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 49;"><span id="cb92-50"><a href="#cb92-50"></a><span class="dt">int</span> Ready_list<span class="op">::</span>highest<span class="op">()</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb92-51"><a href="#cb92-51"></a>  <span class="dt">int</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb92-52"><a href="#cb92-52"></a>  <span class="cf">if</span> <span class="op">(</span>priority_bits <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb92-53"><a href="#cb92-53"></a>    n <span class="op">=</span> ad__get_index_of_most_significant_set_bit<span class="op">(</span>priority_bits<span class="op">);</span></span>
<span id="cb92-54"><a href="#cb92-54"></a>  <span class="cf">return</span> n<span class="op">;</span></span>
<span id="cb92-55"><a href="#cb92-55"></a><span class="op">}</span></span>
<span id="cb92-56"><a href="#cb92-56"></a><span class="dt">void</span> Ready_list<span class="op">::</span>insert<span class="op">(</span>Descriptor <span class="op">*</span>d<span class="op">)</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="klasa-ready_list-8" class="slide level2">
<h2>Klasa Ready_list</h2>
<div class="sourceCode" id="cb93" data-startFrom="57"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 56;"><span id="cb93-57"><a href="#cb93-57"></a>  <span class="cf">if</span> <span class="op">(</span>d<span class="op">-&gt;</span>priority <span class="op">!=</span> TERMINAL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb93-58"><a href="#cb93-58"></a>    priority_bits <span class="op">=</span> ad__set_bit<span class="op">(</span>priority_bits<span class="op">,</span> d<span class="op">-&gt;</span>priority<span class="op">);</span></span>
<span id="cb93-59"><a href="#cb93-59"></a>    ready<span class="op">[</span>d<span class="op">-&gt;</span>priority<span class="op">].</span>insert<span class="op">(</span>d<span class="op">);</span></span>
<span id="cb93-60"><a href="#cb93-60"></a>  <span class="op">}</span></span>
<span id="cb93-61"><a href="#cb93-61"></a><span class="op">}</span></span>
<span id="cb93-62"><a href="#cb93-62"></a>Descriptor <span class="op">*</span>Ready_list<span class="op">::</span>extract<span class="op">()</span> <span class="op">{</span></span>
<span id="cb93-63"><a href="#cb93-63"></a>  Descriptor <span class="op">*</span>d<span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-ready_list-9" class="slide level2">
<h2>Klasa Ready_list</h2>
<div class="sourceCode" id="cb94" data-startFrom="64"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 63;"><span id="cb94-64"><a href="#cb94-64"></a>  d <span class="op">=</span> <span class="op">(</span>Descriptor <span class="op">*)(</span>ready<span class="op">[</span>highest<span class="op">()].</span>extract<span class="op">());</span></span>
<span id="cb94-65"><a href="#cb94-65"></a>  <span class="cf">if</span> <span class="op">(</span>ready<span class="op">[</span>d<span class="op">-&gt;</span>priority<span class="op">].</span>empty<span class="op">())</span></span>
<span id="cb94-66"><a href="#cb94-66"></a>    priority_bits <span class="op">=</span> ad__clear_bit<span class="op">(</span>priority_bits<span class="op">,</span> d<span class="op">-&gt;</span>priority<span class="op">);</span></span>
<span id="cb94-67"><a href="#cb94-67"></a>  <span class="cf">return</span> d<span class="op">;</span></span>
<span id="cb94-68"><a href="#cb94-68"></a><span class="op">}</span></span>
<span id="cb94-69"><a href="#cb94-69"></a><span class="dt">bool</span> Ready_list<span class="op">::</span>higher_than<span class="op">(</span>Descriptor <span class="op">*</span>d<span class="op">)</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb94-70"><a href="#cb94-70"></a>  <span class="cf">return</span> <span class="op">(</span>highest<span class="op">()</span> <span class="op">&gt;</span> d<span class="op">-&gt;</span>priority<span class="op">);</span></span></code></pre></div>
</section>
<section id="klasa-ready_list-10" class="slide level2">
<h2>Klasa Ready_list</h2>
<div class="sourceCode" id="cb95" data-startFrom="71"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 70;"><span id="cb95-71"><a href="#cb95-71"></a><span class="op">}</span></span>
<span id="cb95-72"><a href="#cb95-72"></a><span class="at">static</span> Ready_list ready<span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-ready_list-11" class="slide level2">
<h2>Klasa Ready_list</h2>
<ul>
<li>Klasa Ready_list omogućuje rukovanje spremnim nitima.</li>
<li>Primer takvog rukovanja je brzo pronalaženje najprioritetnije niti
među spremnim nitima, što je osnov za ispunjenje zahteva da je uvek
aktivna najprioritetnija nit.</li>
<li>Radi toga, svakom od prioriteta niti se dodeljuje posebna lista
spremnih niti i podrazumeva se da se deskriptor spremne niti uvek
uvezuje na kraj liste spremnih niti koja odgovara prioritetu dotične
niti.</li>
<li>Takođe se podrazumeva da se deskriptor spremne niti uvek izvezuje sa
početka odabrane liste spremnih niti.</li>
<li>Na ovaj način spremne niti istog prioriteta se uvek aktiviraju u
redosledu u kome su postajale spremne.</li>
</ul>
</section>
<section id="klasa-ready_list-12" class="slide level2">
<h2>Klasa Ready_list</h2>
<ul>
<li>Sve liste spremnih niti zajedno formiraju multi-listu
(Ready::ready).</li>
<li>Rukovanje ovom multi-listom obuhvata:</li>
<li>Dobijanje prioriteta najprioritetnije neprazne liste spremnih niti:
Ready::highest()</li>
<li>Uvezivanje deskriptora niti na kraj odgovarajuće liste spremnih
niti: Ready::insert()</li>
<li>izvezivanje deskriptora niti sa početka najprioritetnije neprazne
liste spremnih niti: Ready::extract()</li>
<li>poređenje prioriteta najprioritetnije neprazne liste spremnih niti
sa prioritetom zadane niti: Ready::higher_than()</li>
</ul>
</section>
<section id="klasa-ready_list-13" class="slide level2">
<h2>Klasa Ready_list</h2>
<ul>
<li>Pošto je multi-lista niz listi spremnih niti, deskriptor spremne
niti se uvezuje na kraj liste spremnih niti koju direktno indeksira
prioritet ove niti.</li>
<li>Međutim, za operaciju izvezivanja deskriptora iz najprioritetnije
neprazne liste spremnih niti, potrebno je prvo pronaći najprioritetniju
nepraznu listu spremnih niti.</li>
<li>Brzo pronalaženje najprioritetnije neprazne liste spremnih niti se
ostvaruje tako da se svaka lista spremnih niti reprezentuje jednim bitom
koji sadrži 1 ako je lista neprazna, a 0 ako je lista prazna.</li>
</ul>
</section>
<section id="klasa-ready_list-14" class="slide level2">
<h2>Klasa Ready_list</h2>
<ul>
<li>Ove bite sadrži Ready::priority_bits, tako da se na značajnijim
pozicijama nalaze biti prioritetnijih listi spremnih niti.</li>
<li>Na najmanje značajnoj poziciji je bit nulte liste spremnih niti, sa
prioritetom 0.</li>
<li>U njoj se nalazi posebna nulta nit, sa prioritetom 0.</li>
<li>Ona angažuje procesor kada nema drugih spremnih niti.</li>
<li>Kada je nulta nit u stanju “spremna”, tada je njen deskriptor uvezan
u nultu listu spremnih niti. Nulta nit može biti još samo u stanju
“aktivna”.</li>
<li>Ona u to stanje prelazi kada ne postoji neka druga nit koja može da
zaposli procesor.</li>
</ul>
</section>
<section id="klasa-ready_list-15" class="slide level2">
<h2>Klasa Ready_list</h2>
<ul>
<li>Najniži prioritet spremnih niti 0 (ZERO) je rezervisan za nultu nit,
a najviši prioritet spremnih niti 31 (SYSTEM) je rezervisan za sistemske
niti.</li>
<li>Između se nalaze prioriteti korisničkih niti (PR01, PR02, …,
PR30).</li>
<li>Za uništavane niti, koje čekaju da budu uništene i koje više ne mogu
biti spremne (a ni aktivne), uveden je poseban zavšni prioritet -1
(TERMINAL) koji omogućuje njihovo posebno tretiranje u okviru operacije
Ready::insert().</li>
</ul>
</section>
<section id="klasa-atomic_region" class="slide level2">
<h2>Klasa Atomic_region</h2>
<div class="sourceCode" id="cb96" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb96-1"><a href="#cb96-1"></a><span class="kw">class</span> Atomic_region <span class="op">{</span></span>
<span id="cb96-2"><a href="#cb96-2"></a>  <span class="dt">bool</span> flags<span class="op">;</span></span>
<span id="cb96-3"><a href="#cb96-3"></a>  Atomic_region<span class="op">(</span><span class="at">const</span> Atomic_region <span class="op">&amp;);</span></span>
<span id="cb96-4"><a href="#cb96-4"></a>  Atomic_region <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Atomic_region <span class="op">&amp;);</span></span>
<span id="cb96-5"><a href="#cb96-5"></a></span>
<span id="cb96-6"><a href="#cb96-6"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb96-7"><a href="#cb96-7"></a>  Atomic_region<span class="op">();</span></span></code></pre></div>
</section>
<section id="klasa-atomic_region-1" class="slide level2">
<h2>Klasa Atomic_region</h2>
<div class="sourceCode" id="cb97" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb97-8"><a href="#cb97-8"></a>  <span class="op">~</span>Atomic_region<span class="op">();</span></span>
<span id="cb97-9"><a href="#cb97-9"></a><span class="op">};</span></span>
<span id="cb97-10"><a href="#cb97-10"></a>Atomic_region<span class="op">::</span>Atomic_region<span class="op">()</span> <span class="op">{</span> flags <span class="op">=</span> ad__disable_interrupts<span class="op">();</span> <span class="op">}</span></span>
<span id="cb97-11"><a href="#cb97-11"></a>Atomic_region<span class="op">::~</span>Atomic_region<span class="op">()</span> <span class="op">{</span> ad__restore_interrupts<span class="op">(</span>flags<span class="op">);</span> <span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-kernel" class="slide level2">
<h2>Klasa Kernel</h2>
<ul>
<li>Klasa Kernel omogućuje rukovanje procesorom. Rukovanje procesorom se
svodi na preključivanje procesora sa jedne niti na drugu.</li>
<li>Za preključivanje je neophodno imati adresu deskriptora aktivne niti
sa koje se procesor preključuje (active), adresu deskriptora niti na
koju se procesor preključuje (pretender), kao i adresu deskriptora niti
sa koje se procesor preključio (former).</li>
<li>Operaciju preključivanja poziva privatna operacija switch_to(), koja
postavlja pokazivač deskriptora aktivne niti active i pokazivač
deskriptora niti sa koje se procesor preključio former.</li>
</ul>
</section>
<section id="klasa-kernel-1" class="slide level2">
<h2>Klasa Kernel</h2>
<ul>
<li>Preključivanje je nužno vezano za raspoređivanje (scheduling),
odnosno za izbor niti na koju se procesor preključuje.</li>
<li>Ciljevi raspoređivanja kod CppTss izvršioca su da uvek bude aktivna
najprioritetnija spremna nit i da se ravnomerno deli vreme procesora
između spremnih niti istog prioriteta. Do raspoređivanja dolazi:</li>
<li>kada se pojavi spremna nit sa višim prioritetom od aktivne niti
(schedule())</li>
<li>na kraju kvantuma (periodic_schedule())</li>
</ul>
</section>
<section id="klasa-kernel-2" class="slide level2">
<h2>Klasa Kernel</h2>
<ul>
<li>Klasa Kernel nasleđuje klasu Deskriptor da bi jedini objekat klase
Kernel reprezentovao deskriptor main() niti.</li>
<li>Konstruktor ove klase proglašava aktivnom main() nit. Pošto main()
nit koristi stek konkurentnog programa kao svoj stek, za nju nije
potrebno zauzeti stek.</li>
<li>U nadležnosti klase Kernel nije samo preključivanje, nego i podrška
viših slojeva iz hijerarhijske strukture CppTss izvršioca.</li>
</ul>
</section>
<section id="klasa-kernel-3" class="slide level2">
<h2>Klasa Kernel</h2>
<ul>
<li>Funkcije:</li>
<li>make_ready() - omogućava aktivnost niti</li>
<li>expect() - omogućuje očekivanje dešavanja događaja</li>
<li>signal() - omogućuje objavu dešavanja događaja</li>
<li>exclusive_in() - za ulazak u isključivi region</li>
<li>exclusive_out() - za izlazak iz isključivog regiona</li>
<li>wait() - očekivanje ispunjenja uslova</li>
<li>notify_one() - objava ispunjenja uslova</li>
<li>U operacijama deljene promenljive kernel se koriste atomski regioni
radi zaštite njene konzistentnosti, kao i konzistentnosti argumenata iz
poziva ovih operacija.</li>
</ul>
</section>
<section id="klasa-kernel-4" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb98" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb98-1"><a href="#cb98-1"></a><span class="kw">class</span> Kernel <span class="op">:</span> <span class="kw">public</span> Descriptor <span class="op">{</span></span>
<span id="cb98-2"><a href="#cb98-2"></a>  Descriptor <span class="op">*</span>active<span class="op">;</span></span>
<span id="cb98-3"><a href="#cb98-3"></a>  Descriptor <span class="op">*</span>pretender<span class="op">;</span></span>
<span id="cb98-4"><a href="#cb98-4"></a>  Descriptor <span class="op">*</span>former<span class="op">;</span></span>
<span id="cb98-5"><a href="#cb98-5"></a>  Kernel<span class="op">(</span><span class="at">const</span> Kernel <span class="op">&amp;);</span></span>
<span id="cb98-6"><a href="#cb98-6"></a>  Kernel <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Kernel <span class="op">&amp;);</span></span>
<span id="cb98-7"><a href="#cb98-7"></a>  <span class="kw">inline</span> <span class="dt">void</span> switch_to<span class="op">(</span>Descriptor <span class="op">*</span><span class="at">const</span> d<span class="op">);</span></span></code></pre></div>
</section>
<section id="klasa-kernel-5" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb99" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb99-8"><a href="#cb99-8"></a>  <span class="kw">inline</span> <span class="dt">void</span> schedule<span class="op">();</span></span>
<span id="cb99-9"><a href="#cb99-9"></a>  <span class="kw">inline</span> <span class="dt">void</span> periodic_schedule<span class="op">();</span></span>
<span id="cb99-10"><a href="#cb99-10"></a></span>
<span id="cb99-11"><a href="#cb99-11"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb99-12"><a href="#cb99-12"></a>  Kernel<span class="op">()</span> <span class="op">:</span> active<span class="op">(</span><span class="dv">0</span><span class="op">),</span> pretender<span class="op">(</span><span class="dv">0</span><span class="op">),</span> former<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb99-13"><a href="#cb99-13"></a>    priority <span class="op">=</span> PR15<span class="op">;</span></span>
<span id="cb99-14"><a href="#cb99-14"></a>    active <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-kernel-6" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb100" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb100-15"><a href="#cb100-15"></a>  <span class="op">};</span></span>
<span id="cb100-16"><a href="#cb100-16"></a>  <span class="kw">inline</span> <span class="dt">void</span> make_ready<span class="op">(</span>Descriptor <span class="op">*</span><span class="at">const</span> d<span class="op">);</span></span>
<span id="cb100-17"><a href="#cb100-17"></a>  <span class="kw">inline</span> <span class="dt">void</span> expect<span class="op">(</span>List_link <span class="op">*</span><span class="at">const</span> waiting_list<span class="op">);</span></span>
<span id="cb100-18"><a href="#cb100-18"></a>  <span class="kw">inline</span> <span class="dt">void</span> signal<span class="op">(</span>List_link <span class="op">*</span><span class="at">const</span> waiting_list<span class="op">);</span></span>
<span id="cb100-19"><a href="#cb100-19"></a>  <span class="kw">inline</span> <span class="dt">void</span> exclusive_in<span class="op">(</span>Permit <span class="op">*</span><span class="at">const</span> permit<span class="op">);</span></span>
<span id="cb100-20"><a href="#cb100-20"></a>  <span class="kw">inline</span> <span class="dt">void</span> wait<span class="op">(</span><span class="at">const</span> <span class="dt">unsigned</span> t<span class="op">,</span> List_link <span class="op">*</span><span class="at">const</span> waiting_list<span class="op">);</span></span>
<span id="cb100-21"><a href="#cb100-21"></a>  <span class="kw">inline</span> <span class="dt">void</span> notify_one<span class="op">(</span>List_link <span class="op">*</span><span class="at">const</span> waiting_list<span class="op">);</span></span></code></pre></div>
</section>
<section id="klasa-kernel-7" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb101" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb101-22"><a href="#cb101-22"></a>  <span class="kw">inline</span> <span class="dt">void</span> exclusive_out<span class="op">();</span></span>
<span id="cb101-23"><a href="#cb101-23"></a>  <span class="kw">inline</span> Descriptor <span class="op">*</span>active_get<span class="op">()</span> <span class="at">const</span> <span class="op">{</span> <span class="cf">return</span> active<span class="op">;</span> <span class="op">};</span></span>
<span id="cb101-24"><a href="#cb101-24"></a>  <span class="kw">friend</span> <span class="dt">void</span> yield<span class="op">();</span></span>
<span id="cb101-25"><a href="#cb101-25"></a>  <span class="kw">friend</span> <span class="kw">class</span> Timer_driver<span class="op">;</span></span>
<span id="cb101-26"><a href="#cb101-26"></a><span class="op">};</span></span>
<span id="cb101-27"><a href="#cb101-27"></a><span class="dt">void</span> Kernel<span class="op">::</span>switch_to<span class="op">(</span>Descriptor <span class="op">*</span><span class="at">const</span> d<span class="op">)</span> <span class="op">{</span></span>
<span id="cb101-28"><a href="#cb101-28"></a>  former <span class="op">=</span> active<span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-kernel-8" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb102" data-startFrom="29"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 28;"><span id="cb102-29"><a href="#cb102-29"></a>  active <span class="op">=</span> d<span class="op">;</span></span>
<span id="cb102-30"><a href="#cb102-30"></a>  ad__stack_swap<span class="op">(&amp;(</span>former<span class="op">-&gt;</span>stack_top<span class="op">),</span> active<span class="op">-&gt;</span>stack_top<span class="op">);</span></span>
<span id="cb102-31"><a href="#cb102-31"></a><span class="op">}</span></span>
<span id="cb102-32"><a href="#cb102-32"></a><span class="dt">void</span> Kernel<span class="op">::</span>schedule<span class="op">()</span> <span class="op">{</span></span>
<span id="cb102-33"><a href="#cb102-33"></a>  <span class="cf">if</span> <span class="op">(</span>ready<span class="op">.</span>higher_than<span class="op">(</span>active<span class="op">))</span> <span class="op">{</span></span>
<span id="cb102-34"><a href="#cb102-34"></a>    ready<span class="op">.</span>insert<span class="op">(</span>active<span class="op">);</span></span>
<span id="cb102-35"><a href="#cb102-35"></a>    pretender <span class="op">=</span> ready<span class="op">.</span>extract<span class="op">();</span></span></code></pre></div>
</section>
<section id="klasa-kernel-9" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb103" data-startFrom="36"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 35;"><span id="cb103-36"><a href="#cb103-36"></a>    switch_to<span class="op">(</span>pretender<span class="op">);</span></span>
<span id="cb103-37"><a href="#cb103-37"></a>  <span class="op">}</span></span>
<span id="cb103-38"><a href="#cb103-38"></a><span class="op">}</span></span>
<span id="cb103-39"><a href="#cb103-39"></a><span class="dt">void</span> Kernel<span class="op">::</span>periodic_schedule<span class="op">()</span> <span class="op">{</span></span>
<span id="cb103-40"><a href="#cb103-40"></a>  ready<span class="op">.</span>insert<span class="op">(</span>active<span class="op">);</span></span>
<span id="cb103-41"><a href="#cb103-41"></a>  pretender <span class="op">=</span> ready<span class="op">.</span>extract<span class="op">();</span></span>
<span id="cb103-42"><a href="#cb103-42"></a>  <span class="cf">if</span> <span class="op">(</span>active <span class="op">!=</span> pretender<span class="op">)</span></span></code></pre></div>
</section>
<section id="klasa-kernel-10" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb104" data-startFrom="43"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 42;"><span id="cb104-43"><a href="#cb104-43"></a>    switch_to<span class="op">(</span>pretender<span class="op">);</span></span>
<span id="cb104-44"><a href="#cb104-44"></a><span class="op">}</span></span>
<span id="cb104-45"><a href="#cb104-45"></a><span class="dt">void</span> Kernel<span class="op">::</span>make_ready<span class="op">(</span>Descriptor <span class="op">*</span><span class="at">const</span> d<span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-46"><a href="#cb104-46"></a>  Atomic_region ar<span class="op">;</span></span>
<span id="cb104-47"><a href="#cb104-47"></a>  ready<span class="op">.</span>insert<span class="op">(</span>d<span class="op">);</span></span>
<span id="cb104-48"><a href="#cb104-48"></a><span class="op">}</span></span>
<span id="cb104-49"><a href="#cb104-49"></a><span class="dt">void</span> Kernel<span class="op">::</span>expect<span class="op">(</span>List_link <span class="op">*</span><span class="at">const</span> waiting_list<span class="op">)</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="klasa-kernel-11" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb105" data-startFrom="50"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 49;"><span id="cb105-50"><a href="#cb105-50"></a>  waiting_list<span class="op">-&gt;</span>insert<span class="op">(</span>active<span class="op">);</span></span>
<span id="cb105-51"><a href="#cb105-51"></a>  pretender <span class="op">=</span> ready<span class="op">.</span>extract<span class="op">();</span></span>
<span id="cb105-52"><a href="#cb105-52"></a>  switch_to<span class="op">(</span>pretender<span class="op">);</span></span>
<span id="cb105-53"><a href="#cb105-53"></a><span class="op">}</span></span>
<span id="cb105-54"><a href="#cb105-54"></a><span class="dt">void</span> Kernel<span class="op">::</span>signal<span class="op">(</span>List_link <span class="op">*</span><span class="at">const</span> waiting_list<span class="op">)</span> <span class="op">{</span></span>
<span id="cb105-55"><a href="#cb105-55"></a>  <span class="cf">if</span> <span class="op">(</span>waiting_list<span class="op">-&gt;</span>not_empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb105-56"><a href="#cb105-56"></a>    pretender <span class="op">=</span> <span class="op">(</span>Descriptor <span class="op">*)</span>waiting_list<span class="op">-&gt;</span>extract<span class="op">();</span></span></code></pre></div>
</section>
<section id="klasa-kernel-12" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb106" data-startFrom="57"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 56;"><span id="cb106-57"><a href="#cb106-57"></a>    ready<span class="op">.</span>insert<span class="op">(</span>pretender<span class="op">);</span></span>
<span id="cb106-58"><a href="#cb106-58"></a>    schedule<span class="op">();</span></span>
<span id="cb106-59"><a href="#cb106-59"></a>  <span class="op">}</span></span>
<span id="cb106-60"><a href="#cb106-60"></a><span class="op">}</span></span>
<span id="cb106-61"><a href="#cb106-61"></a><span class="dt">void</span> Kernel<span class="op">::</span>exclusive_in<span class="op">(</span>Permit <span class="op">*</span><span class="at">const</span> permit<span class="op">)</span> <span class="op">{</span></span>
<span id="cb106-62"><a href="#cb106-62"></a>  Atomic_region ar<span class="op">;</span></span>
<span id="cb106-63"><a href="#cb106-63"></a>  <span class="cf">if</span> <span class="op">(</span>permit<span class="op">-&gt;</span>not_free<span class="op">())</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="klasa-kernel-13" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb107" data-startFrom="64"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 63;"><span id="cb107-64"><a href="#cb107-64"></a>    permit<span class="op">-&gt;</span>admission_insert<span class="op">(</span>active<span class="op">);</span></span>
<span id="cb107-65"><a href="#cb107-65"></a>    pretender <span class="op">=</span> ready<span class="op">.</span>extract<span class="op">();</span></span>
<span id="cb107-66"><a href="#cb107-66"></a>    switch_to<span class="op">(</span>pretender<span class="op">);</span></span>
<span id="cb107-67"><a href="#cb107-67"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb107-68"><a href="#cb107-68"></a>    permit<span class="op">-&gt;</span>take<span class="op">();</span></span>
<span id="cb107-69"><a href="#cb107-69"></a>    active<span class="op">-&gt;</span>link_permit<span class="op">(</span>permit<span class="op">);</span></span>
<span id="cb107-70"><a href="#cb107-70"></a>  <span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-kernel-14" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb108" data-startFrom="71"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 70;"><span id="cb108-71"><a href="#cb108-71"></a><span class="op">}</span></span>
<span id="cb108-72"><a href="#cb108-72"></a><span class="dt">void</span> Kernel<span class="op">::</span>wait<span class="op">(</span><span class="at">const</span> <span class="dt">unsigned</span> t<span class="op">,</span> List_link <span class="op">*</span><span class="at">const</span> waiting_list<span class="op">)</span> <span class="op">{</span></span>
<span id="cb108-73"><a href="#cb108-73"></a>  Atomic_region ar<span class="op">;</span></span>
<span id="cb108-74"><a href="#cb108-74"></a>  Permit <span class="op">*</span>permit <span class="op">=</span> active<span class="op">-&gt;</span>ulink_permit<span class="op">();</span></span>
<span id="cb108-75"><a href="#cb108-75"></a>  active<span class="op">-&gt;</span>tag <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb108-76"><a href="#cb108-76"></a>  <span class="cf">if</span> <span class="op">(</span>permit<span class="op">-&gt;</span>fulfilled_not_empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb108-77"><a href="#cb108-77"></a>    pretender <span class="op">=</span> <span class="op">(</span>Descriptor <span class="op">*)</span>permit<span class="op">-&gt;</span>fulfilled_extract<span class="op">();</span></span></code></pre></div>
</section>
<section id="klasa-kernel-15" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb109" data-startFrom="78"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 77;"><span id="cb109-78"><a href="#cb109-78"></a>    pretender<span class="op">-&gt;</span>link_permit<span class="op">(</span>permit<span class="op">);</span></span>
<span id="cb109-79"><a href="#cb109-79"></a>    ready<span class="op">.</span>insert<span class="op">(</span>pretender<span class="op">);</span></span>
<span id="cb109-80"><a href="#cb109-80"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>permit<span class="op">-&gt;</span>admission_not_empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb109-81"><a href="#cb109-81"></a>    pretender <span class="op">=</span> <span class="op">(</span>Descriptor <span class="op">*)</span>permit<span class="op">-&gt;</span>admission_extract<span class="op">();</span></span>
<span id="cb109-82"><a href="#cb109-82"></a>    pretender<span class="op">-&gt;</span>link_permit<span class="op">(</span>permit<span class="op">);</span></span>
<span id="cb109-83"><a href="#cb109-83"></a>    ready<span class="op">.</span>insert<span class="op">(</span>pretender<span class="op">);</span></span>
<span id="cb109-84"><a href="#cb109-84"></a>  <span class="op">}</span> <span class="cf">else</span></span></code></pre></div>
</section>
<section id="klasa-kernel-16" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb110" data-startFrom="85"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 84;"><span id="cb110-85"><a href="#cb110-85"></a>    permit<span class="op">-&gt;</span>release<span class="op">();</span></span>
<span id="cb110-86"><a href="#cb110-86"></a>  waiting_list<span class="op">-&gt;</span>insert<span class="op">(</span>active<span class="op">);</span></span>
<span id="cb110-87"><a href="#cb110-87"></a>  pretender <span class="op">=</span> ready<span class="op">.</span>extract<span class="op">();</span></span>
<span id="cb110-88"><a href="#cb110-88"></a>  switch_to<span class="op">(</span>pretender<span class="op">);</span></span>
<span id="cb110-89"><a href="#cb110-89"></a><span class="op">}</span></span>
<span id="cb110-90"><a href="#cb110-90"></a><span class="dt">void</span> Kernel<span class="op">::</span>notify_one<span class="op">(</span>List_link <span class="op">*</span><span class="at">const</span> waiting_list<span class="op">)</span> <span class="op">{</span></span>
<span id="cb110-91"><a href="#cb110-91"></a>  Permit <span class="op">*</span>permit <span class="op">=</span> active<span class="op">-&gt;</span>last<span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-kernel-17" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb111" data-startFrom="92"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 91;"><span id="cb111-92"><a href="#cb111-92"></a>  <span class="cf">if</span> <span class="op">(</span>permit <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb111-93"><a href="#cb111-93"></a>    <span class="cf">throw</span> <span class="op">&amp;</span>failure_notify_outside_exclusive_region<span class="op">;</span></span>
<span id="cb111-94"><a href="#cb111-94"></a>  Atomic_region ar<span class="op">;</span></span>
<span id="cb111-95"><a href="#cb111-95"></a>  <span class="cf">if</span> <span class="op">(</span>waiting_list<span class="op">-&gt;</span>not_empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb111-96"><a href="#cb111-96"></a>    pretender <span class="op">=</span> <span class="op">(</span>Descriptor <span class="op">*)</span>waiting_list<span class="op">-&gt;</span>extract<span class="op">();</span></span>
<span id="cb111-97"><a href="#cb111-97"></a>    permit<span class="op">-&gt;</span>fulfilled_insert<span class="op">(</span>pretender<span class="op">);</span></span>
<span id="cb111-98"><a href="#cb111-98"></a>  <span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-kernel-18" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb112" data-startFrom="99"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 98;"><span id="cb112-99"><a href="#cb112-99"></a><span class="op">}</span></span>
<span id="cb112-100"><a href="#cb112-100"></a><span class="dt">void</span> Kernel<span class="op">::</span>exclusive_out<span class="op">()</span> <span class="op">{</span></span>
<span id="cb112-101"><a href="#cb112-101"></a>  Atomic_region ar<span class="op">;</span></span>
<span id="cb112-102"><a href="#cb112-102"></a>  Permit <span class="op">*</span>permit <span class="op">=</span> active<span class="op">-&gt;</span>ulink_permit<span class="op">();</span></span>
<span id="cb112-103"><a href="#cb112-103"></a>  <span class="cf">if</span> <span class="op">(</span>permit<span class="op">-&gt;</span>fulfilled_not_empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb112-104"><a href="#cb112-104"></a>    pretender <span class="op">=</span> <span class="op">(</span>Descriptor <span class="op">*)</span>permit<span class="op">-&gt;</span>fulfilled_extract<span class="op">();</span></span>
<span id="cb112-105"><a href="#cb112-105"></a>    pretender<span class="op">-&gt;</span>link_permit<span class="op">(</span>permit<span class="op">);</span></span></code></pre></div>
</section>
<section id="klasa-kernel-19" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb113" data-startFrom="106"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 105;"><span id="cb113-106"><a href="#cb113-106"></a>    ready<span class="op">.</span>insert<span class="op">(</span>pretender<span class="op">);</span></span>
<span id="cb113-107"><a href="#cb113-107"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>permit<span class="op">-&gt;</span>admission_not_empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb113-108"><a href="#cb113-108"></a>    pretender <span class="op">=</span> <span class="op">(</span>Descriptor <span class="op">*)</span>permit<span class="op">-&gt;</span>admission_extract<span class="op">();</span></span>
<span id="cb113-109"><a href="#cb113-109"></a>    pretender<span class="op">-&gt;</span>link_permit<span class="op">(</span>permit<span class="op">);</span></span>
<span id="cb113-110"><a href="#cb113-110"></a>    ready<span class="op">.</span>insert<span class="op">(</span>pretender<span class="op">);</span></span>
<span id="cb113-111"><a href="#cb113-111"></a>  <span class="op">}</span> <span class="cf">else</span></span>
<span id="cb113-112"><a href="#cb113-112"></a>    permit<span class="op">-&gt;</span>release<span class="op">();</span></span></code></pre></div>
</section>
<section id="klasa-kernel-20" class="slide level2">
<h2>Klasa Kernel</h2>
<div class="sourceCode" id="cb114" data-startFrom="113"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 112;"><span id="cb114-113"><a href="#cb114-113"></a>  schedule<span class="op">();</span></span>
<span id="cb114-114"><a href="#cb114-114"></a><span class="op">}</span></span>
<span id="cb114-115"><a href="#cb114-115"></a><span class="at">static</span> Kernel kernel<span class="op">;</span></span>
<span id="cb114-116"><a href="#cb114-116"></a><span class="dt">void</span> yield<span class="op">()</span> <span class="op">{</span></span>
<span id="cb114-117"><a href="#cb114-117"></a>  Atomic_region set_up<span class="op">;</span></span>
<span id="cb114-118"><a href="#cb114-118"></a>  kernel<span class="op">.</span>periodic_schedule<span class="op">();</span></span>
<span id="cb114-119"><a href="#cb114-119"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-mutex" class="slide level2">
<h2>Klasa mutex</h2>
<div class="sourceCode" id="cb115" data-startFrom="120"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 119;"><span id="cb115-120"><a href="#cb115-120"></a><span class="kw">class</span> mutex <span class="op">:</span> <span class="kw">private</span> Permit <span class="op">{</span></span>
<span id="cb115-121"><a href="#cb115-121"></a>  mutex<span class="op">(</span><span class="at">const</span> mutex <span class="op">&amp;);</span></span>
<span id="cb115-122"><a href="#cb115-122"></a>  mutex <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> mutex <span class="op">&amp;);</span></span>
<span id="cb115-123"><a href="#cb115-123"></a></span>
<span id="cb115-124"><a href="#cb115-124"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb115-125"><a href="#cb115-125"></a>  mutex<span class="op">(){};</span></span>
<span id="cb115-126"><a href="#cb115-126"></a>  <span class="dt">void</span> lock<span class="op">();</span></span></code></pre></div>
</section>
<section id="klasa-mutex-1" class="slide level2">
<h2>Klasa mutex</h2>
<div class="sourceCode" id="cb116" data-startFrom="127"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 126;"><span id="cb116-127"><a href="#cb116-127"></a>  <span class="dt">void</span> unlock<span class="op">();</span></span>
<span id="cb116-128"><a href="#cb116-128"></a><span class="op">};</span></span>
<span id="cb116-129"><a href="#cb116-129"></a><span class="dt">void</span> mutex<span class="op">::</span>lock<span class="op">()</span> <span class="op">{</span> kernel<span class="op">.</span>exclusive_in<span class="op">(</span><span class="kw">this</span><span class="op">);</span> <span class="op">}</span></span>
<span id="cb116-130"><a href="#cb116-130"></a><span class="dt">void</span> mutex<span class="op">::</span>unlock<span class="op">()</span> <span class="op">{</span> kernel<span class="op">.</span>exclusive_out<span class="op">();</span> <span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-unique_lock" class="slide level2">
<h2>Klasa unique_lock</h2>
<div class="sourceCode" id="cb117" data-startFrom="131"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 130;"><span id="cb117-131"><a href="#cb117-131"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> MUTEX<span class="op">&gt;</span> <span class="kw">class</span> unique_lock <span class="op">{</span></span>
<span id="cb117-132"><a href="#cb117-132"></a>  unique_lock<span class="op">(</span><span class="at">const</span> unique_lock <span class="op">&amp;);</span></span>
<span id="cb117-133"><a href="#cb117-133"></a>  unique_lock <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> unique_lock <span class="op">&amp;);</span></span>
<span id="cb117-134"><a href="#cb117-134"></a></span>
<span id="cb117-135"><a href="#cb117-135"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb117-136"><a href="#cb117-136"></a>  unique_lock<span class="op">(</span>MUTEX <span class="op">&amp;</span>mx<span class="op">);</span></span>
<span id="cb117-137"><a href="#cb117-137"></a>  <span class="op">~</span>unique_lock<span class="op">();</span></span></code></pre></div>
</section>
<section id="klasa-unique_lock-1" class="slide level2">
<h2>Klasa unique_lock</h2>
<div class="sourceCode" id="cb118" data-startFrom="138"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 137;"><span id="cb118-138"><a href="#cb118-138"></a><span class="op">};</span></span>
<span id="cb118-139"><a href="#cb118-139"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> MUTEX<span class="op">&gt;</span> unique_lock<span class="op">&lt;</span>MUTEX<span class="op">&gt;::</span>unique_lock<span class="op">(</span>MUTEX <span class="op">&amp;</span>mx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-140"><a href="#cb118-140"></a>  kernel<span class="op">.</span>exclusive_in<span class="op">((</span>Permit <span class="op">*)&amp;</span>mx<span class="op">);</span></span>
<span id="cb118-141"><a href="#cb118-141"></a><span class="op">}</span></span>
<span id="cb118-142"><a href="#cb118-142"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> MUTEX<span class="op">&gt;</span> unique_lock<span class="op">&lt;</span>MUTEX<span class="op">&gt;::~</span>unique_lock<span class="op">()</span> <span class="op">{</span></span>
<span id="cb118-143"><a href="#cb118-143"></a>  kernel<span class="op">.</span>exclusive_out<span class="op">();</span></span>
<span id="cb118-144"><a href="#cb118-144"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-condition_variable" class="slide level2">
<h2>Klasa condition_variable</h2>
<div class="sourceCode" id="cb119" data-startFrom="145"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 144;"><span id="cb119-145"><a href="#cb119-145"></a><span class="kw">class</span> condition_variable <span class="op">{</span></span>
<span id="cb119-146"><a href="#cb119-146"></a>  List_link list_head<span class="op">;</span></span>
<span id="cb119-147"><a href="#cb119-147"></a>  List_link <span class="op">*</span>position<span class="op">;</span></span>
<span id="cb119-148"><a href="#cb119-148"></a></span>
<span id="cb119-149"><a href="#cb119-149"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb119-150"><a href="#cb119-150"></a>  condition_variable<span class="op">()</span> <span class="op">{</span> position <span class="op">=</span> <span class="op">&amp;</span>list_head<span class="op">;</span> <span class="op">};</span></span>
<span id="cb119-151"><a href="#cb119-151"></a>  <span class="dt">void</span> wait<span class="op">(</span>unique_lock<span class="op">&lt;</span>mutex<span class="op">&gt;</span> <span class="op">&amp;</span>lock<span class="op">,</span> <span class="dt">unsigned</span> t <span class="op">=</span> <span class="dv">0</span><span class="op">);</span></span></code></pre></div>
</section>
<section id="klasa-condition_variable-1" class="slide level2">
<h2>Klasa condition_variable</h2>
<div class="sourceCode" id="cb120" data-startFrom="152"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 151;"><span id="cb120-152"><a href="#cb120-152"></a>  <span class="dt">void</span> notify_one<span class="op">();</span></span>
<span id="cb120-153"><a href="#cb120-153"></a>  <span class="dt">bool</span> first<span class="op">(</span><span class="dt">unsigned</span> <span class="op">*</span>t <span class="op">=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb120-154"><a href="#cb120-154"></a>  <span class="dt">bool</span> last<span class="op">();</span></span>
<span id="cb120-155"><a href="#cb120-155"></a>  <span class="dt">bool</span> next<span class="op">(</span><span class="dt">unsigned</span> <span class="op">*</span>t <span class="op">=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb120-156"><a href="#cb120-156"></a>  <span class="dt">bool</span> attach_tag<span class="op">(</span><span class="dt">unsigned</span> t<span class="op">);</span></span>
<span id="cb120-157"><a href="#cb120-157"></a><span class="op">};</span></span>
<span id="cb120-158"><a href="#cb120-158"></a><span class="dt">void</span> condition_variable<span class="op">::</span>wait<span class="op">(</span>unique_lock<span class="op">&lt;</span>mutex<span class="op">&gt;</span> <span class="op">&amp;</span>lock<span class="op">,</span> <span class="dt">unsigned</span> t<span class="op">)</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="klasa-condition_variable-2" class="slide level2">
<h2>Klasa condition_variable</h2>
<div class="sourceCode" id="cb121" data-startFrom="159"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 158;"><span id="cb121-159"><a href="#cb121-159"></a>  kernel<span class="op">.</span>wait<span class="op">(</span>t<span class="op">,</span> position<span class="op">);</span></span>
<span id="cb121-160"><a href="#cb121-160"></a>  position <span class="op">=</span> <span class="op">&amp;</span>list_head<span class="op">;</span></span>
<span id="cb121-161"><a href="#cb121-161"></a><span class="op">}</span></span>
<span id="cb121-162"><a href="#cb121-162"></a><span class="dt">void</span> condition_variable<span class="op">::</span>notify_one<span class="op">()</span> <span class="op">{</span></span>
<span id="cb121-163"><a href="#cb121-163"></a>  kernel<span class="op">.</span>notify_one<span class="op">(&amp;</span>list_head<span class="op">);</span></span>
<span id="cb121-164"><a href="#cb121-164"></a>  position <span class="op">=</span> <span class="op">&amp;</span>list_head<span class="op">;</span></span>
<span id="cb121-165"><a href="#cb121-165"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-condition_variable-3" class="slide level2">
<h2>Klasa condition_variable</h2>
<div class="sourceCode" id="cb122" data-startFrom="166"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 165;"><span id="cb122-166"><a href="#cb122-166"></a><span class="dt">bool</span> condition_variable<span class="op">::</span>first<span class="op">(</span><span class="dt">unsigned</span> <span class="op">*</span>t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb122-167"><a href="#cb122-167"></a>  <span class="dt">bool</span> r <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb122-168"><a href="#cb122-168"></a>  <span class="cf">if</span> <span class="op">(</span>list_head<span class="op">.</span>not_empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb122-169"><a href="#cb122-169"></a>    position <span class="op">=</span> list_head<span class="op">.</span>right_get<span class="op">();</span></span>
<span id="cb122-170"><a href="#cb122-170"></a>    <span class="cf">if</span> <span class="op">(</span>t <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb122-171"><a href="#cb122-171"></a>      <span class="op">*</span>t <span class="op">=</span> <span class="op">((</span>Descriptor <span class="op">*)</span>position<span class="op">)-&gt;</span>tag_get<span class="op">();</span></span>
<span id="cb122-172"><a href="#cb122-172"></a>    r <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-condition_variable-4" class="slide level2">
<h2>Klasa condition_variable</h2>
<div class="sourceCode" id="cb123" data-startFrom="173"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 172;"><span id="cb123-173"><a href="#cb123-173"></a>  <span class="op">}</span></span>
<span id="cb123-174"><a href="#cb123-174"></a>  <span class="cf">return</span> <span class="op">(</span>r<span class="op">);</span></span>
<span id="cb123-175"><a href="#cb123-175"></a><span class="op">}</span></span>
<span id="cb123-176"><a href="#cb123-176"></a><span class="dt">bool</span> condition_variable<span class="op">::</span>last<span class="op">()</span> <span class="op">{</span></span>
<span id="cb123-177"><a href="#cb123-177"></a>  <span class="dt">bool</span> r <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb123-178"><a href="#cb123-178"></a>  <span class="cf">if</span> <span class="op">(</span>list_head<span class="op">.</span>not_empty<span class="op">())</span> <span class="op">{</span></span>
<span id="cb123-179"><a href="#cb123-179"></a>    position <span class="op">=</span> <span class="op">&amp;</span>list_head<span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-condition_variable-5" class="slide level2">
<h2>Klasa condition_variable</h2>
<div class="sourceCode" id="cb124" data-startFrom="180"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 179;"><span id="cb124-180"><a href="#cb124-180"></a>    r <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb124-181"><a href="#cb124-181"></a>  <span class="op">}</span></span>
<span id="cb124-182"><a href="#cb124-182"></a>  <span class="cf">return</span> <span class="op">(</span>r<span class="op">);</span></span>
<span id="cb124-183"><a href="#cb124-183"></a><span class="op">}</span></span>
<span id="cb124-184"><a href="#cb124-184"></a><span class="dt">bool</span> condition_variable<span class="op">::</span>next<span class="op">(</span><span class="dt">unsigned</span> <span class="op">*</span>t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb124-185"><a href="#cb124-185"></a>  <span class="dt">bool</span> r <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb124-186"><a href="#cb124-186"></a>  <span class="cf">if</span> <span class="op">(</span>position <span class="op">!=</span> <span class="op">&amp;</span>list_head<span class="op">)</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="klasa-condition_variable-6" class="slide level2">
<h2>Klasa condition_variable</h2>
<div class="sourceCode" id="cb125" data-startFrom="187"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 186;"><span id="cb125-187"><a href="#cb125-187"></a>    position <span class="op">=</span> position<span class="op">-&gt;</span>right_get<span class="op">();</span></span>
<span id="cb125-188"><a href="#cb125-188"></a>    <span class="cf">if</span> <span class="op">(</span>position <span class="op">!=</span> <span class="op">&amp;</span>list_head<span class="op">)</span> <span class="op">{</span></span>
<span id="cb125-189"><a href="#cb125-189"></a>      <span class="cf">if</span> <span class="op">(</span>t <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb125-190"><a href="#cb125-190"></a>        <span class="op">*</span>t <span class="op">=</span> <span class="op">((</span>Descriptor <span class="op">*)</span>position<span class="op">)-&gt;</span>tag_get<span class="op">();</span></span>
<span id="cb125-191"><a href="#cb125-191"></a>      r <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb125-192"><a href="#cb125-192"></a>    <span class="op">}</span></span>
<span id="cb125-193"><a href="#cb125-193"></a>  <span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-condition_variable-7" class="slide level2">
<h2>Klasa condition_variable</h2>
<div class="sourceCode" id="cb126" data-startFrom="194"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 193;"><span id="cb126-194"><a href="#cb126-194"></a>  <span class="cf">return</span> <span class="op">(</span>r<span class="op">);</span></span>
<span id="cb126-195"><a href="#cb126-195"></a><span class="op">}</span></span>
<span id="cb126-196"><a href="#cb126-196"></a><span class="dt">bool</span> condition_variable<span class="op">::</span>attach_tag<span class="op">(</span><span class="dt">unsigned</span> t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb126-197"><a href="#cb126-197"></a>  <span class="dt">bool</span> r <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb126-198"><a href="#cb126-198"></a>  <span class="cf">if</span> <span class="op">(</span>position <span class="op">!=</span> <span class="op">&amp;</span>list_head<span class="op">)</span> <span class="op">{</span></span>
<span id="cb126-199"><a href="#cb126-199"></a>    <span class="op">((</span>Descriptor <span class="op">*)</span>position<span class="op">)-&gt;</span>tag_set<span class="op">(</span>t<span class="op">);</span></span>
<span id="cb126-200"><a href="#cb126-200"></a>    r <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-condition_variable-8" class="slide level2">
<h2>Klasa condition_variable</h2>
<div class="sourceCode" id="cb127" data-startFrom="201"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 200;"><span id="cb127-201"><a href="#cb127-201"></a>  <span class="op">}</span></span>
<span id="cb127-202"><a href="#cb127-202"></a>  <span class="cf">return</span> <span class="op">(</span>r<span class="op">);</span></span>
<span id="cb127-203"><a href="#cb127-203"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-driver" class="slide level2">
<h2>Klasa Driver</h2>
<ul>
<li>Klasa Driver omogućuje smeštanje adrese obrađivača prekida u tabelu
prekida: Driver::start_interrupt_handling().</li>
<li>Pored toga, ova klasa uvodi definiciju klase Event koja omogućuje
zaustavljanje aktivnosti niti do dešavanja događaja i objavu dešavanja
događaja.</li>
</ul>
</section>
<section id="klasa-driver-1" class="slide level2">
<h2>Klasa Driver</h2>
<div class="sourceCode" id="cb128" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb128-1"><a href="#cb128-1"></a><span class="kw">class</span> Driver <span class="op">{</span></span>
<span id="cb128-2"><a href="#cb128-2"></a><span class="kw">protected</span><span class="op">:</span></span>
<span id="cb128-3"><a href="#cb128-3"></a>  <span class="dt">void</span> start_interrupt_handling<span class="op">(</span>Vector_numbers vector_number<span class="op">,</span></span>
<span id="cb128-4"><a href="#cb128-4"></a>                                <span class="dt">void</span> <span class="op">(*</span>handler<span class="op">)());</span></span>
<span id="cb128-5"><a href="#cb128-5"></a>  <span class="kw">class</span> Event <span class="op">{</span></span>
<span id="cb128-6"><a href="#cb128-6"></a>    List_link list_head<span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-driver-2" class="slide level2">
<h2>Klasa Driver</h2>
<div class="sourceCode" id="cb129" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb129-8"><a href="#cb129-8"></a>  <span class="kw">public</span><span class="op">:</span></span>
<span id="cb129-9"><a href="#cb129-9"></a>    <span class="dt">void</span> expect<span class="op">();</span></span>
<span id="cb129-10"><a href="#cb129-10"></a>    <span class="dt">void</span> signal<span class="op">();</span></span>
<span id="cb129-11"><a href="#cb129-11"></a>  <span class="op">};</span></span>
<span id="cb129-12"><a href="#cb129-12"></a><span class="op">};</span></span>
<span id="cb129-13"><a href="#cb129-13"></a><span class="dt">void</span> Driver<span class="op">::</span>start_interrupt_handling<span class="op">(</span>Vector_numbers vector_number<span class="op">,</span></span>
<span id="cb129-14"><a href="#cb129-14"></a>                                      <span class="dt">void</span> <span class="op">(*</span>handler<span class="op">)())</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="klasa-driver-3" class="slide level2">
<h2>Klasa Driver</h2>
<div class="sourceCode" id="cb130" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb130-15"><a href="#cb130-15"></a>  Atomic_region ar<span class="op">;</span></span>
<span id="cb130-16"><a href="#cb130-16"></a>  ad__set_vector<span class="op">(</span>vector_number<span class="op">,</span> handler<span class="op">);</span></span>
<span id="cb130-17"><a href="#cb130-17"></a><span class="op">}</span></span>
<span id="cb130-18"><a href="#cb130-18"></a><span class="dt">void</span> Driver<span class="op">::</span>Event<span class="op">::</span>expect<span class="op">()</span> <span class="op">{</span> kernel<span class="op">.</span>expect<span class="op">(&amp;</span>list_head<span class="op">);</span> <span class="op">}</span></span>
<span id="cb130-19"><a href="#cb130-19"></a><span class="kw">class</span> Driver <span class="op">{</span></span>
<span id="cb130-20"><a href="#cb130-20"></a><span class="kw">protected</span><span class="op">:</span></span>
<span id="cb130-21"><a href="#cb130-21"></a>  <span class="dt">void</span> start_interrupt_handling<span class="op">(</span>Vector_numbers vector_number<span class="op">,</span></span></code></pre></div>
</section>
<section id="klasa-driver-4" class="slide level2">
<h2>Klasa Driver</h2>
<div class="sourceCode" id="cb131" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb131-22"><a href="#cb131-22"></a>                                <span class="dt">void</span> <span class="op">(*</span>handler<span class="op">)());</span></span>
<span id="cb131-23"><a href="#cb131-23"></a>  <span class="kw">class</span> Event <span class="op">{</span></span>
<span id="cb131-24"><a href="#cb131-24"></a>    List_link list_head<span class="op">;</span></span>
<span id="cb131-25"><a href="#cb131-25"></a></span>
<span id="cb131-26"><a href="#cb131-26"></a>  <span class="kw">public</span><span class="op">:</span></span>
<span id="cb131-27"><a href="#cb131-27"></a>    <span class="dt">void</span> expect<span class="op">();</span></span>
<span id="cb131-28"><a href="#cb131-28"></a>    <span class="dt">void</span> signal<span class="op">();</span></span></code></pre></div>
</section>
<section id="klasa-driver-5" class="slide level2">
<h2>Klasa Driver</h2>
<div class="sourceCode" id="cb132" data-startFrom="29"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 28;"><span id="cb132-29"><a href="#cb132-29"></a>  <span class="op">};</span></span>
<span id="cb132-30"><a href="#cb132-30"></a><span class="op">};</span></span>
<span id="cb132-31"><a href="#cb132-31"></a><span class="dt">void</span> Driver<span class="op">::</span>start_interrupt_handling<span class="op">(</span>Vector_numbers vector_number<span class="op">,</span></span>
<span id="cb132-32"><a href="#cb132-32"></a>                                      <span class="dt">void</span> <span class="op">(*</span>handler<span class="op">)())</span> <span class="op">{</span></span>
<span id="cb132-33"><a href="#cb132-33"></a>  Atomic_region ar<span class="op">;</span></span>
<span id="cb132-34"><a href="#cb132-34"></a>  ad__set_vector<span class="op">(</span>vector_number<span class="op">,</span> handler<span class="op">);</span></span>
<span id="cb132-35"><a href="#cb132-35"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-driver-6" class="slide level2">
<h2>Klasa Driver</h2>
<div class="sourceCode" id="cb133" data-startFrom="36"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 35;"><span id="cb133-36"><a href="#cb133-36"></a><span class="dt">void</span> Driver<span class="op">::</span>Event<span class="op">::</span>expect<span class="op">()</span> <span class="op">{</span> kernel<span class="op">.</span>expect<span class="op">(&amp;</span>list_head<span class="op">);</span> <span class="op">}</span></span>
<span id="cb133-37"><a href="#cb133-37"></a><span class="dt">void</span> Driver<span class="op">::</span>Event<span class="op">::</span>signal<span class="op">()</span> <span class="op">{</span> kernel<span class="op">.</span>signal<span class="op">(&amp;</span>list_head<span class="op">);</span> <span class="op">}</span></span></code></pre></div>
</section>
<section id="klase-exception_driver-i-timer_driver"
class="slide level2">
<h2>Klase Exception_driver i Timer_driver</h2>
<ul>
<li>Iz klase Driver su izvedene klase Exception_driver i
Timer_driver.</li>
<li>Prva od njih omogućuje reakciju na pojavu hardverskih izuzetaka,
radi izazivanja prevremenog kraja konkurentnog programa.</li>
<li>Druga od ovih klasa omogućuje rukovanje vremenom.</li>
<li>Klasa Exception_driver uvodi operaciju interrupt_handler(). Ova
operacija zaustavlja izvršavanje konkurentnog programa.</li>
</ul>
</section>
<section id="klase-exception_driver-i-timer_driver-1"
class="slide level2">
<h2>Klase Exception_driver i Timer_driver</h2>
<ul>
<li>Rukovanje vremenom obuhvata:</li>
<li>brojanje otkucaja sata, radi praćenja proticanja sistemskog
vremena</li>
<li>odbrojavanje otkucaja sata preostalih do kraja kvantuma aktivne
niti</li>
<li>odbrojavanja otkucaja sata preostalih do buđenja uspavane niti</li>
<li>Kada broj otkucaja, preostalih do isticanja kvantuma aktivne niti,
padne na nulu, potrebno je pokrenuti periodično raspoređivanje.</li>
</ul>
</section>
<section id="klase-exception_driver-i-timer_driver-2"
class="slide level2">
<h2>Klase Exception_driver i Timer_driver</h2>
<ul>
<li>Takođe, kada broj otkucaja, preostalih do buđenja uspavane niti,
padne na nulu, potrebno je probuditi sve niti za koje je nastupio
trenutak buđenja.</li>
<li>Svi prethodno pobrojani poslovi se nalaze u nadležnosti operacije
interrupt_handler() koju uvodi klasa Timer_driver.</li>
<li>Polje current_ticks ove klase sadrži sistemsko vreme, polje
countdown sadrži broj otkucaja do buđenja, a polje rest broj otkucaja do
isticanja kvantuma.</li>
<li>Funkcija now() vraća sadržaj polja current_ticks, odnosno vraća
sistemsko vreme.</li>
</ul>
</section>
<section id="klase-exception_driver-i-timer_driver-3"
class="slide level2">
<h2>Klase Exception_driver i Timer_driver</h2>
<div class="sourceCode" id="cb134" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb134-1"><a href="#cb134-1"></a><span class="at">const</span> <span class="dt">unsigned</span> <span class="dt">long</span> QUANTUM <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb134-2"><a href="#cb134-2"></a><span class="kw">class</span> Exception_driver <span class="op">:</span> <span class="kw">public</span> Driver <span class="op">{</span></span>
<span id="cb134-3"><a href="#cb134-3"></a>  <span class="at">static</span> <span class="dt">void</span> interrupt_handler<span class="op">();</span></span>
<span id="cb134-4"><a href="#cb134-4"></a></span>
<span id="cb134-5"><a href="#cb134-5"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb134-6"><a href="#cb134-6"></a>  Exception_driver<span class="op">()</span> <span class="op">{</span></span>
<span id="cb134-7"><a href="#cb134-7"></a>    start_interrupt_handling<span class="op">(</span>FP_EXCEPTION<span class="op">,</span> interrupt_handler<span class="op">);</span></span></code></pre></div>
</section>
<section id="klase-exception_driver-i-timer_driver-4"
class="slide level2">
<h2>Klase Exception_driver i Timer_driver</h2>
<div class="sourceCode" id="cb135" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb135-8"><a href="#cb135-8"></a>  <span class="op">};</span></span>
<span id="cb135-9"><a href="#cb135-9"></a><span class="op">};</span></span>
<span id="cb135-10"><a href="#cb135-10"></a><span class="dt">void</span> Exception_driver<span class="op">::</span>interrupt_handler<span class="op">()</span> <span class="op">{</span></span>
<span id="cb135-11"><a href="#cb135-11"></a>  ad__report_and_finish<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">HARDWARE EXCEPTION!</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb135-12"><a href="#cb135-12"></a><span class="op">}</span></span>
<span id="cb135-13"><a href="#cb135-13"></a><span class="at">static</span> Exception_driver exception_driver<span class="op">;</span></span>
<span id="cb135-14"><a href="#cb135-14"></a><span class="kw">class</span> Timer_driver <span class="op">:</span> <span class="kw">public</span> Driver <span class="op">{</span></span></code></pre></div>
</section>
<section id="klase-exception_driver-i-timer_driver-5"
class="slide level2">
<h2>Klase Exception_driver i Timer_driver</h2>
<div class="sourceCode" id="cb136" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb136-15"><a href="#cb136-15"></a>  <span class="at">static</span> <span class="dt">unsigned</span> <span class="dt">long</span> current_ticks<span class="op">;</span></span>
<span id="cb136-16"><a href="#cb136-16"></a>  <span class="at">static</span> <span class="dt">unsigned</span> <span class="dt">long</span> countdown<span class="op">;</span></span>
<span id="cb136-17"><a href="#cb136-17"></a>  <span class="at">static</span> <span class="dt">unsigned</span> <span class="dt">long</span> rest<span class="op">;</span></span>
<span id="cb136-18"><a href="#cb136-18"></a>  <span class="at">static</span> <span class="dt">unsigned</span> <span class="dt">long</span> quantum<span class="op">;</span></span>
<span id="cb136-19"><a href="#cb136-19"></a>  <span class="at">static</span> Event alarm<span class="op">;</span></span>
<span id="cb136-20"><a href="#cb136-20"></a>  <span class="at">static</span> <span class="dt">void</span> interrupt_handler<span class="op">();</span></span></code></pre></div>
</section>
<section id="klase-exception_driver-i-timer_driver-6"
class="slide level2">
<h2>Klase Exception_driver i Timer_driver</h2>
<div class="sourceCode" id="cb137" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb137-22"><a href="#cb137-22"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb137-23"><a href="#cb137-23"></a>  Timer_driver<span class="op">()</span> <span class="op">{</span> start_interrupt_handling<span class="op">(</span>TIMER<span class="op">,</span> interrupt_handler<span class="op">);</span> <span class="op">};</span></span>
<span id="cb137-24"><a href="#cb137-24"></a>  <span class="kw">friend</span> <span class="dt">unsigned</span> <span class="dt">long</span> now<span class="op">();</span></span>
<span id="cb137-25"><a href="#cb137-25"></a>  <span class="kw">friend</span> <span class="kw">class</span> Delta<span class="op">;</span></span>
<span id="cb137-26"><a href="#cb137-26"></a><span class="op">};</span></span>
<span id="cb137-27"><a href="#cb137-27"></a><span class="dt">unsigned</span> <span class="dt">long</span> Timer_driver<span class="op">::</span>current_ticks <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb137-28"><a href="#cb137-28"></a><span class="dt">unsigned</span> <span class="dt">long</span> Timer_driver<span class="op">::</span>countdown <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="klase-exception_driver-i-timer_driver-7"
class="slide level2">
<h2>Klase Exception_driver i Timer_driver</h2>
<div class="sourceCode" id="cb138" data-startFrom="29"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 28;"><span id="cb138-29"><a href="#cb138-29"></a><span class="dt">unsigned</span> <span class="dt">long</span> Timer_driver<span class="op">::</span>rest <span class="op">=</span> QUANTUM<span class="op">;</span></span>
<span id="cb138-30"><a href="#cb138-30"></a>Timer_driver<span class="op">::</span>Event Timer_driver<span class="op">::</span>alarm<span class="op">;</span></span>
<span id="cb138-31"><a href="#cb138-31"></a><span class="dt">void</span> Timer_driver<span class="op">::</span>interrupt_handler<span class="op">()</span> <span class="op">{</span></span>
<span id="cb138-32"><a href="#cb138-32"></a>  current_ticks<span class="op">++;</span></span>
<span id="cb138-33"><a href="#cb138-33"></a>  <span class="cf">if</span> <span class="op">((--</span>rest<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb138-34"><a href="#cb138-34"></a>    rest <span class="op">=</span> quantum<span class="op">;</span></span>
<span id="cb138-35"><a href="#cb138-35"></a>  <span class="cf">if</span> <span class="op">((</span>countdown <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">((--</span>countdown<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">))</span></span></code></pre></div>
</section>
<section id="klase-exception_driver-i-timer_driver-8"
class="slide level2">
<h2>Klase Exception_driver i Timer_driver</h2>
<div class="sourceCode" id="cb139" data-startFrom="36"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 35;"><span id="cb139-36"><a href="#cb139-36"></a>    alarm<span class="op">.</span>signal<span class="op">();</span></span>
<span id="cb139-37"><a href="#cb139-37"></a>  <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>rest <span class="op">==</span> quantum<span class="op">)</span></span>
<span id="cb139-38"><a href="#cb139-38"></a>    kernel<span class="op">.</span>periodic_schedule<span class="op">();</span></span>
<span id="cb139-39"><a href="#cb139-39"></a><span class="op">}</span></span>
<span id="cb139-40"><a href="#cb139-40"></a><span class="at">static</span> Timer_driver timer_driver<span class="op">;</span></span>
<span id="cb139-41"><a href="#cb139-41"></a><span class="dt">unsigned</span> <span class="dt">long</span> now<span class="op">()</span> <span class="op">{</span></span>
<span id="cb139-42"><a href="#cb139-42"></a>  Atomic_region ar<span class="op">;</span></span></code></pre></div>
</section>
<section id="klase-exception_driver-i-timer_driver-9"
class="slide level2">
<h2>Klase Exception_driver i Timer_driver</h2>
<div class="sourceCode" id="cb140" data-startFrom="43"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 42;"><span id="cb140-43"><a href="#cb140-43"></a>  <span class="cf">return</span> timer_driver<span class="op">.</span>current_ticks<span class="op">;</span></span>
<span id="cb140-44"><a href="#cb140-44"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<ul>
<li>Klasa Memory_fragment omogućuje rukovanje slobodnom radnom
memorijom. Slobodnu radnu memoriju obrazuje celi broj jedinica
sastavljenih od UNIT bajta.</li>
<li>Rukovanje slobodnom radnom memorijom podrazumeva da se uvek zauzima,
odnosno da se uvek oslobađa celi broj ovih jedinica.</li>
<li>Zauzimanja ovakvih zona slobodne radne memorije, odnosno njihova
oslobađanja uzrokuju iscepkanost slobodne radne memorije u odsečke.</li>
<li>Odsečci se zato uvezuju u jednosmernu listu, uređenu u rastućem
redosledu njihovih početnih adresa.</li>
<li>Radi toga, početak svakog odsečka sadrži svoju veličinu, izraženu u
pomenutim jedinicama od po UNIT bajta, i pokazivač narednog
odsečka.</li>
<li>Veličinu odsečka i pokazivač narednog odsečka sadrže polja size i
next klase Memory_fragment.</li>
</ul>
</section>
<section id="klasa-memory_fragment-1" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<ul>
<li>Konstruktor klase Memory_fragment opisuje obrazovanje liste odsečaka
slobodne radne memorije, sastavljene od stalnog odsečka čija veličina je
0 i od odsečka koji obuhvata raspoloživu slobodnu radnu memoriju.</li>
<li>Stalnom (prvom) odsečku odgovara objekt memory klase
Memory_fragment, koji je jedini objekt ove klase. Dodavanju drugog
odsečka prethodi provera da li je obezbeđeno dovoljno radne memorije za
potrebe konkurentnog programa.</li>
<li>Ako nije, izvršavanje konkurentnog programa se završava uz poruku
INITIAL MEMORY SHORTAGE.</li>
<li>Pošto je UNIT jednak veličini stranice, uvek se zauzima toliko radne
memorije da u nju može da stane traženi broj stranica, a da početak
raspoložive slobodne radne memorije bude postavljen na početak prve
stranice.</li>
</ul>
</section>
<section id="klasa-memory_fragment-2" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<ul>
<li>Zauzimanje slobodne radne memorije omogućuje operacija take() klase
Memory_fragment.</li>
<li>Zauzima se jedna jedinica od UNIT bajta više nego što je
traženo.</li>
<li>Ona prethodi preostalim zauzetim jedinicama memorije i sadrži ukupnu
veličinu zauzete memorije. Ova veličina se koristi prilikom kasnijeg
oslobađanja zauzete memorije.</li>
<li>Zauzimanju prethodi pretraživanje liste odsečaka, radi pronalaženja
prvog dovoljno velikog odsečka.</li>
<li>Pretraživanje uvek počinje od stalnog odsečka. Ako se pronađe
dovoljno velik odsečak, traženi bajti se zauzimaju s njegovog kraja. Ako
pronađeni odsečak obuhvata baš traženi broj bajta, tada se on isključuje
iz liste i zauzimaju se svi njegovi bajti.</li>
</ul>
</section>
<section id="klasa-memory_fragment-3" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<ul>
<li>Oslobađanje prethodno zauzete radne memorije omogućuje operacija
free() klase Memory_fragment.</li>
<li>Za oslobađanje je neophodno u listi odsečaka pronaći odsečak iza
koga će se oslobađani odsečak uvezati u ovu listu.</li>
<li>Pre uvezivanja proverava se da li oslobađani odsečak može da se
spoji u jedan odsečak sa svojim prethodnikom i sa svojim
sledbenikom.</li>
<li>Odsečak se uvezuje u pomenutu listu samo ako ovo spajanje nije
moguće.</li>
</ul>
</section>
<section id="klasa-memory_fragment-4" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<ul>
<li>Prethodno opisane operacije klase Memory_fragment su namenjene za
zauzimanje i oslobađanje radne memorije prilikom stvaranja i uništavanja
objekata pojedinih klasa.</li>
<li>Da bi se njihova namena ostvarila, neophodno je da ove operacije
pozivaju globalni operatori new() i delete().</li>
<li>Ali, tada razne niti mogu da pozivaju operacije klase
Memory_fragment posredstvom prethodna dva operatora i da tako ugroze
konzistentnost liste odsečaka.</li>
<li>Da bi se to sprečilo, ova klasa nasleđuje klasu mutex i tako
omogućuje zaključavanje i otključavanje njenog jedinog objekta memory.
To je obezbeđeno u definicijama funkcija operator new() i operator
delete(), radi ostvarenja međusobne isključivosti različitih pristupanja
listi odsečaka.</li>
</ul>
</section>
<section id="klasa-memory_fragment-5" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb141" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb141-1"><a href="#cb141-1"></a><span class="at">const</span> <span class="dt">size_t</span> UNIT <span class="op">=</span> PAGE_SIZE<span class="op">;</span></span>
<span id="cb141-2"><a href="#cb141-2"></a><span class="kw">class</span> Memory_fragment <span class="op">:</span> <span class="kw">public</span> mutex <span class="op">{</span></span>
<span id="cb141-3"><a href="#cb141-3"></a>  <span class="dt">size_t</span> size<span class="op">;</span></span>
<span id="cb141-4"><a href="#cb141-4"></a>  Memory_fragment <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb141-5"><a href="#cb141-5"></a>  Memory_fragment<span class="op">(</span><span class="at">const</span> Memory_fragment <span class="op">&amp;);</span></span>
<span id="cb141-6"><a href="#cb141-6"></a>  Memory_fragment <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Memory_fragment <span class="op">&amp;);</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment-6" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb142" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb142-8"><a href="#cb142-8"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb142-9"><a href="#cb142-9"></a>  Memory_fragment<span class="op">();</span></span>
<span id="cb142-10"><a href="#cb142-10"></a>  <span class="dt">void</span> <span class="op">*</span>take<span class="op">(</span><span class="dt">size_t</span> size<span class="op">);</span></span>
<span id="cb142-11"><a href="#cb142-11"></a>  <span class="dt">void</span> free<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>address<span class="op">);</span></span>
<span id="cb142-12"><a href="#cb142-12"></a><span class="op">};</span></span>
<span id="cb142-13"><a href="#cb142-13"></a>Memory_fragment<span class="op">::</span>Memory_fragment<span class="op">()</span> <span class="op">:</span> size<span class="op">(</span><span class="dv">0</span><span class="op">),</span> next<span class="op">(</span><span class="kw">this</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb142-14"><a href="#cb142-14"></a>  <span class="dt">size_t</span> free_memory <span class="op">=</span> <span class="dv">2000</span> <span class="op">*</span> UNIT<span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment-7" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb143" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb143-15"><a href="#cb143-15"></a>  <span class="dt">size_t</span> beginning <span class="op">=</span> <span class="op">(</span><span class="dt">size_t</span><span class="op">)</span>malloc<span class="op">(</span>free_memory <span class="op">+</span> UNIT <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb143-16"><a href="#cb143-16"></a>  <span class="cf">if</span> <span class="op">(</span>beginning <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb143-17"><a href="#cb143-17"></a>    ad__report_and_finish<span class="op">(</span><span class="st">&quot;INITIAL MEMORY SHORTAGE&quot;</span><span class="op">);</span></span>
<span id="cb143-18"><a href="#cb143-18"></a>  <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb143-19"><a href="#cb143-19"></a>    beginning <span class="op">=</span> <span class="op">(</span>beginning <span class="op">+</span> UNIT <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">~(</span>UNIT <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb143-20"><a href="#cb143-20"></a>    next <span class="op">=</span> <span class="op">(</span>Memory_fragment <span class="op">*)</span>beginning<span class="op">;</span></span>
<span id="cb143-21"><a href="#cb143-21"></a>    next<span class="op">-&gt;</span>size <span class="op">=</span> free_memory<span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment-8" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb144" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb144-22"><a href="#cb144-22"></a>    next<span class="op">-&gt;</span>next <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb144-23"><a href="#cb144-23"></a>  <span class="op">}</span></span>
<span id="cb144-24"><a href="#cb144-24"></a><span class="op">}</span></span>
<span id="cb144-25"><a href="#cb144-25"></a><span class="dt">void</span> <span class="op">*</span>Memory_fragment<span class="op">::</span>take<span class="op">(</span><span class="dt">size_t</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb144-26"><a href="#cb144-26"></a>  size <span class="op">+=</span> <span class="dv">2</span> <span class="op">*</span> UNIT – <span class="dv">1</span><span class="op">;</span> <span class="co">// 1 UNIT za broj zauzetih i drugi ako</span></span>
<span id="cb144-27"><a href="#cb144-27"></a>  size <span class="op">-=</span> size <span class="op">%</span> UNIT<span class="op">;</span>  <span class="co">// size nije ceo broj unita</span></span>
<span id="cb144-28"><a href="#cb144-28"></a>  Memory_fragment <span class="op">*</span>m <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment-9" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb145" data-startFrom="29"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 28;"><span id="cb145-29"><a href="#cb145-29"></a>  Memory_fragment <span class="op">*</span>p <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb145-30"><a href="#cb145-30"></a>  <span class="cf">while</span> <span class="op">(</span>p<span class="op">-&gt;</span>next <span class="op">!=</span> <span class="kw">this</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb145-31"><a href="#cb145-31"></a>    <span class="cf">if</span> <span class="op">((</span>p<span class="op">-&gt;</span>next<span class="op">-&gt;</span>size<span class="op">)</span> <span class="op">&lt;</span> size<span class="op">)</span></span>
<span id="cb145-32"><a href="#cb145-32"></a>      p <span class="op">=</span> p<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb145-33"><a href="#cb145-33"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>p<span class="op">-&gt;</span>next<span class="op">-&gt;</span>size <span class="op">==</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb145-34"><a href="#cb145-34"></a>      m <span class="op">=</span> p<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb145-35"><a href="#cb145-35"></a>      p<span class="op">-&gt;</span>next <span class="op">=</span> p<span class="op">-&gt;</span>next<span class="op">-&gt;</span>next<span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment-10" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb146" data-startFrom="36"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 35;"><span id="cb146-36"><a href="#cb146-36"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb146-37"><a href="#cb146-37"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb146-38"><a href="#cb146-38"></a>      p<span class="op">-&gt;</span>next<span class="op">-&gt;</span>size <span class="op">-=</span> size<span class="op">;</span></span>
<span id="cb146-39"><a href="#cb146-39"></a>      m <span class="op">=</span> <span class="op">(</span>Memory_fragment <span class="op">*)((</span><span class="dt">size_t</span><span class="op">)(</span>p<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">+</span> <span class="op">(</span>p<span class="op">-&gt;</span>next<span class="op">-&gt;</span>size<span class="op">));</span></span>
<span id="cb146-40"><a href="#cb146-40"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb146-41"><a href="#cb146-41"></a>    <span class="op">}</span></span>
<span id="cb146-42"><a href="#cb146-42"></a>  <span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment-11" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb147" data-startFrom="43"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 42;"><span id="cb147-43"><a href="#cb147-43"></a>  <span class="cf">if</span> <span class="op">(</span>m <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb147-44"><a href="#cb147-44"></a>    <span class="cf">throw</span> <span class="op">&amp;</span>failure_memory_shortage<span class="op">;</span></span>
<span id="cb147-45"><a href="#cb147-45"></a>  m<span class="op">-&gt;</span>size <span class="op">=</span> size<span class="op">;</span></span>
<span id="cb147-46"><a href="#cb147-46"></a>  <span class="cf">return</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*)((</span><span class="dt">size_t</span><span class="op">)</span>m <span class="op">+</span> UNIT<span class="op">);</span></span>
<span id="cb147-47"><a href="#cb147-47"></a><span class="op">}</span></span>
<span id="cb147-48"><a href="#cb147-48"></a><span class="dt">void</span> Memory_fragment<span class="op">::</span>free<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>address<span class="op">)</span> <span class="op">{</span></span>
<span id="cb147-49"><a href="#cb147-49"></a>  <span class="cf">if</span> <span class="op">(</span>address <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment-12" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb148" data-startFrom="50"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 49;"><span id="cb148-50"><a href="#cb148-50"></a>    Memory_fragment <span class="op">*</span>a <span class="op">=</span> <span class="op">(</span>Memory_fragment <span class="op">*)((</span><span class="dt">size_t</span><span class="op">)</span>address <span class="op">-</span> UNIT<span class="op">);</span></span>
<span id="cb148-51"><a href="#cb148-51"></a>    Memory_fragment <span class="op">*</span>p <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb148-52"><a href="#cb148-52"></a>    <span class="cf">while</span> <span class="op">(</span>p<span class="op">-&gt;</span>next <span class="op">!=</span> <span class="kw">this</span><span class="op">)</span></span>
<span id="cb148-53"><a href="#cb148-53"></a>      <span class="cf">if</span> <span class="op">(</span>a <span class="op">&gt;</span> p<span class="op">-&gt;</span>next<span class="op">)</span></span>
<span id="cb148-54"><a href="#cb148-54"></a>        p <span class="op">=</span> p<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb148-55"><a href="#cb148-55"></a>      <span class="cf">else</span></span>
<span id="cb148-56"><a href="#cb148-56"></a>        <span class="cf">break</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment-13" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb149" data-startFrom="57"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 56;"><span id="cb149-57"><a href="#cb149-57"></a>    <span class="cf">if</span> <span class="op">((((</span><span class="dt">size_t</span><span class="op">)</span>p<span class="op">)</span> <span class="op">+</span> <span class="op">(</span>p<span class="op">-&gt;</span>size<span class="op">))</span> <span class="op">==</span> <span class="op">((</span><span class="dt">size_t</span><span class="op">)</span>a<span class="op">))</span> <span class="op">{</span></span>
<span id="cb149-58"><a href="#cb149-58"></a>      p<span class="op">-&gt;</span>size <span class="op">+=</span> a<span class="op">-&gt;</span>size<span class="op">;</span></span>
<span id="cb149-59"><a href="#cb149-59"></a>      <span class="cf">if</span> <span class="op">((((</span><span class="dt">size_t</span><span class="op">)</span>p<span class="op">)</span> <span class="op">+</span> <span class="op">(</span>p<span class="op">-&gt;</span>size<span class="op">))</span> <span class="op">==</span> <span class="op">((</span><span class="dt">size_t</span><span class="op">)(</span>p<span class="op">-&gt;</span>next<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb149-60"><a href="#cb149-60"></a>        p<span class="op">-&gt;</span>size <span class="op">+=</span> p<span class="op">-&gt;</span>next<span class="op">-&gt;</span>size<span class="op">;</span></span>
<span id="cb149-61"><a href="#cb149-61"></a>        p<span class="op">-&gt;</span>next <span class="op">=</span> p<span class="op">-&gt;</span>next<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb149-62"><a href="#cb149-62"></a>      <span class="op">}</span></span>
<span id="cb149-63"><a href="#cb149-63"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">((((</span><span class="dt">size_t</span><span class="op">)</span>a<span class="op">)</span> <span class="op">+</span> <span class="op">(</span>a<span class="op">-&gt;</span>size<span class="op">))</span> <span class="op">==</span> <span class="op">((</span><span class="dt">size_t</span><span class="op">)(</span>p<span class="op">-&gt;</span>next<span class="op">)))</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment-14" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb150" data-startFrom="64"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 63;"><span id="cb150-64"><a href="#cb150-64"></a>      a<span class="op">-&gt;</span>size <span class="op">+=</span> p<span class="op">-&gt;</span>next<span class="op">-&gt;</span>size<span class="op">;</span></span>
<span id="cb150-65"><a href="#cb150-65"></a>      a<span class="op">-&gt;</span>next <span class="op">=</span> p<span class="op">-&gt;</span>next<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb150-66"><a href="#cb150-66"></a>      p<span class="op">-&gt;</span>next <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb150-67"><a href="#cb150-67"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb150-68"><a href="#cb150-68"></a>      a<span class="op">-&gt;</span>next <span class="op">=</span> p<span class="op">-&gt;</span>next<span class="op">;</span></span>
<span id="cb150-69"><a href="#cb150-69"></a>      p<span class="op">-&gt;</span>next <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb150-70"><a href="#cb150-70"></a>    <span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment-15" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb151" data-startFrom="71"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 70;"><span id="cb151-71"><a href="#cb151-71"></a>  <span class="op">}</span></span>
<span id="cb151-72"><a href="#cb151-72"></a><span class="op">}</span></span>
<span id="cb151-73"><a href="#cb151-73"></a><span class="at">static</span> Memory_fragment memory<span class="op">;</span></span>
<span id="cb151-74"><a href="#cb151-74"></a><span class="dt">void</span> <span class="op">*</span><span class="kw">operator</span> <span class="kw">new</span><span class="op">(</span><span class="dt">size_t</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb151-75"><a href="#cb151-75"></a>  <span class="dt">void</span> <span class="op">*</span>memory_block<span class="op">;</span></span>
<span id="cb151-76"><a href="#cb151-76"></a>  memory<span class="op">.</span>lock<span class="op">();</span></span>
<span id="cb151-77"><a href="#cb151-77"></a>  <span class="cf">try</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment-16" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb152" data-startFrom="78"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 77;"><span id="cb152-78"><a href="#cb152-78"></a>    memory_block <span class="op">=</span> memory<span class="op">.</span>take<span class="op">(</span>size<span class="op">);</span></span>
<span id="cb152-79"><a href="#cb152-79"></a>  <span class="op">}</span> <span class="cf">catch</span> <span class="op">(...)</span> <span class="op">{</span></span>
<span id="cb152-80"><a href="#cb152-80"></a>    memory<span class="op">.</span>unlock<span class="op">();</span></span>
<span id="cb152-81"><a href="#cb152-81"></a>    <span class="cf">throw</span><span class="op">;</span></span>
<span id="cb152-82"><a href="#cb152-82"></a>  <span class="op">}</span></span>
<span id="cb152-83"><a href="#cb152-83"></a>  memory<span class="op">.</span>unlock<span class="op">();</span></span>
<span id="cb152-84"><a href="#cb152-84"></a>  <span class="cf">return</span> memory_block<span class="op">;</span></span></code></pre></div>
</section>
<section id="klasa-memory_fragment-17" class="slide level2">
<h2>Klasa Memory_fragment</h2>
<div class="sourceCode" id="cb153" data-startFrom="85"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 84;"><span id="cb153-85"><a href="#cb153-85"></a><span class="op">}</span></span>
<span id="cb153-86"><a href="#cb153-86"></a><span class="dt">void</span> <span class="kw">operator</span> <span class="kw">delete</span><span class="op">(</span><span class="dt">void</span> <span class="op">*</span>address<span class="op">)</span> <span class="op">{</span></span>
<span id="cb153-87"><a href="#cb153-87"></a>  memory<span class="op">.</span>lock<span class="op">();</span></span>
<span id="cb153-88"><a href="#cb153-88"></a>  memory<span class="op">.</span>free<span class="op">(</span>address<span class="op">);</span></span>
<span id="cb153-89"><a href="#cb153-89"></a>  memory<span class="op">.</span>unlock<span class="op">();</span></span>
<span id="cb153-90"><a href="#cb153-90"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="klase-thread_image-i-thread" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<ul>
<li>Rukovanje nitima omogućuju klase Thread_image i thread, kao i
definicije funkcija thread_destroyer_deamon(), destroy() i
undetached_threads().</li>
<li>Klasa Thread_image opisuje sliku niti, sastavljenu od:</li>
<li>deskriptora niti</li>
<li>uslova (ended) koji omogućuje čekanje završetka aktivnosti niti</li>
<li>oznake da regularan kraj aktivnosti niti može da nastupi kao
posledica kraja aktivnosti procesa kome dotična nit pripada
(detached)</li>
<li>steka niti</li>
</ul>
</section>
<section id="klase-thread_image-i-thread-1" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<ul>
<li>Klasa thread omogućuje:</li>
<li>međusobnu isključivost svojih operacija (mx)</li>
<li>brojanje niti za koje koje nije regularno da kraj njihove aktivnosti
nastupi kao posledica kraja aktivnosti procesa kome dotične niti
pripadaju (undetached_threads_number)</li>
<li>uništavanje niti (termination, terminating)</li>
<li>pristup slici niti (ti)</li>
<li>Konstruktor klase thread omogućuje kreiranje niti. U toku kreiranja
niti pripremi se njen stek za preključivanje, da bi automatski započelo
izvršavanje funkcije koja opisuje ponašanje niti nakon prvog
preključivanja na nit.</li>
<li>Završetak aktivnosti niti se otkriva u okviru operacija join() i
detach() na osnovu završnog prioriteta niti (TERMINAL).</li>
</ul>
</section>
<section id="klase-thread_image-i-thread-2" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<ul>
<li>Na završetku aktivnosti niti, u toku izvršavanja funkcije destroy(),
omogućuje se nastavak aktivnosti niti koja čeka dotični završetak i
oslobađanje prostora koga zauzima slika niti, što je u nadležnosti
sistemske niti thread_destroyer_deamon().</li>
<li>Funkcija undetached_threads() omogućuje proveru da li postoje niti
za koje nije regularno da kraj njihove aktivnosti nastupi kao posledica
kraja aktivnosti procesa kome dotične niti pripadaju, da bi se na kraju
aktivnosti procesa ukazalo na prevremeni završetak ovakvih niti.</li>
</ul>
</section>
<section id="klase-thread_image-i-thread-3" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<div class="sourceCode" id="cb154" data-startFrom="1"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb154-1"><a href="#cb154-1"></a><span class="at">const</span> <span class="dt">unsigned</span> DEFAULT_STACK_SIZE <span class="op">=</span> <span class="dv">4096</span><span class="op">;</span></span>
<span id="cb154-2"><a href="#cb154-2"></a><span class="kw">class</span> Thread_image <span class="op">:</span> <span class="kw">public</span> Descriptor <span class="op">{</span></span>
<span id="cb154-3"><a href="#cb154-3"></a>  condition_variable ended<span class="op">;</span></span>
<span id="cb154-4"><a href="#cb154-4"></a>  <span class="dt">bool</span> detached<span class="op">;</span></span>
<span id="cb154-5"><a href="#cb154-5"></a>  Stack_item stack<span class="op">[</span>DEFAULT_STACK_SIZE<span class="op">];</span></span>
<span id="cb154-6"><a href="#cb154-6"></a>  Thread_image<span class="op">(</span><span class="at">const</span> Thread_image <span class="op">&amp;);</span></span>
<span id="cb154-7"><a href="#cb154-7"></a>  Thread_image <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Thread_image <span class="op">&amp;);</span></span></code></pre></div>
</section>
<section id="klase-thread_image-i-thread-4" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<div class="sourceCode" id="cb155" data-startFrom="8"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 7;"><span id="cb155-8"><a href="#cb155-8"></a></span>
<span id="cb155-9"><a href="#cb155-9"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb155-10"><a href="#cb155-10"></a>  Thread_image<span class="op">(</span><span class="dt">void</span> <span class="op">(*</span>thread_function<span class="op">)(),</span> Priority p<span class="op">);</span></span>
<span id="cb155-11"><a href="#cb155-11"></a>  <span class="kw">friend</span> <span class="kw">class</span> thread<span class="op">;</span></span>
<span id="cb155-12"><a href="#cb155-12"></a>  <span class="kw">friend</span> <span class="dt">void</span> destroy<span class="op">();</span></span>
<span id="cb155-13"><a href="#cb155-13"></a><span class="op">};</span></span>
<span id="cb155-14"><a href="#cb155-14"></a>Thread_image<span class="op">::</span>Thread_image<span class="op">(</span><span class="dt">void</span> <span class="op">(*</span>thread_function<span class="op">)(),</span> Priority p<span class="op">)</span></span></code></pre></div>
</section>
<section id="klase-thread_image-i-thread-5" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<div class="sourceCode" id="cb156" data-startFrom="15"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 14;"><span id="cb156-15"><a href="#cb156-15"></a>    <span class="op">:</span> detached<span class="op">(</span><span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-16"><a href="#cb156-16"></a>  stack_top <span class="op">=</span> <span class="op">&amp;(</span>stack<span class="op">[</span>DEFAULT_STACK_SIZE<span class="op">]);</span></span>
<span id="cb156-17"><a href="#cb156-17"></a>  ad__stack_init<span class="op">(&amp;</span>stack_top<span class="op">,</span> <span class="op">(</span><span class="dt">unsigned</span><span class="op">)</span>thread_function<span class="op">);</span></span>
<span id="cb156-18"><a href="#cb156-18"></a>  priority <span class="op">=</span> p<span class="op">;</span></span>
<span id="cb156-19"><a href="#cb156-19"></a><span class="op">}</span></span>
<span id="cb156-20"><a href="#cb156-20"></a><span class="kw">class</span> thread <span class="op">{</span></span>
<span id="cb156-21"><a href="#cb156-21"></a>  <span class="at">static</span> mutex mx<span class="op">;</span></span></code></pre></div>
</section>
<section id="klase-thread_image-i-thread-6" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<div class="sourceCode" id="cb157" data-startFrom="22"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 21;"><span id="cb157-22"><a href="#cb157-22"></a>  <span class="at">static</span> <span class="dt">unsigned</span> undetached_threads_number<span class="op">;</span></span>
<span id="cb157-23"><a href="#cb157-23"></a>  <span class="at">static</span> condition_variable termination<span class="op">;</span></span>
<span id="cb157-24"><a href="#cb157-24"></a>  <span class="at">static</span> Thread_image <span class="op">*</span>terminating<span class="op">;</span></span>
<span id="cb157-25"><a href="#cb157-25"></a>  Thread_image <span class="op">*</span>ti<span class="op">;</span></span>
<span id="cb157-26"><a href="#cb157-26"></a>  thread<span class="op">(</span><span class="at">const</span> thread <span class="op">&amp;);</span></span>
<span id="cb157-27"><a href="#cb157-27"></a>  thread <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> thread <span class="op">&amp;);</span></span></code></pre></div>
</section>
<section id="klase-thread_image-i-thread-7" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<div class="sourceCode" id="cb158" data-startFrom="29"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 28;"><span id="cb158-29"><a href="#cb158-29"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb158-30"><a href="#cb158-30"></a>  thread<span class="op">(</span><span class="dt">void</span> <span class="op">(*</span>thread_function<span class="op">)(),</span> Priority p <span class="op">=</span> PR15<span class="op">);</span></span>
<span id="cb158-31"><a href="#cb158-31"></a>  <span class="dt">void</span> join<span class="op">();</span></span>
<span id="cb158-32"><a href="#cb158-32"></a>  <span class="dt">void</span> detach<span class="op">();</span></span>
<span id="cb158-33"><a href="#cb158-33"></a>  <span class="kw">friend</span> <span class="dt">void</span> thread_destroyer_deamon<span class="op">();</span></span>
<span id="cb158-34"><a href="#cb158-34"></a>  <span class="kw">friend</span> <span class="dt">void</span> destroy<span class="op">();</span></span>
<span id="cb158-35"><a href="#cb158-35"></a>  <span class="kw">friend</span> <span class="dt">bool</span> undetached_threads<span class="op">();</span></span></code></pre></div>
</section>
<section id="klase-thread_image-i-thread-8" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<div class="sourceCode" id="cb159" data-startFrom="36"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 35;"><span id="cb159-36"><a href="#cb159-36"></a><span class="op">};</span></span>
<span id="cb159-37"><a href="#cb159-37"></a>mutex thread<span class="op">::</span>mx<span class="op">;</span></span>
<span id="cb159-38"><a href="#cb159-38"></a><span class="dt">unsigned</span> thread<span class="op">::</span>undetached_threads_number <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb159-39"><a href="#cb159-39"></a>condition_variable thread<span class="op">::</span>termination<span class="op">;</span></span>
<span id="cb159-40"><a href="#cb159-40"></a>Thread_image <span class="op">*</span>thread<span class="op">::</span>terminating<span class="op">;</span></span>
<span id="cb159-41"><a href="#cb159-41"></a>thread<span class="op">::</span>thread<span class="op">(</span><span class="dt">void</span> <span class="op">(*</span>thread_function<span class="op">)(),</span> Priority p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb159-42"><a href="#cb159-42"></a>  ti <span class="op">=</span> <span class="kw">new</span> Thread_image<span class="op">(</span>thread_function<span class="op">,</span> p<span class="op">);</span></span></code></pre></div>
</section>
<section id="klase-thread_image-i-thread-9" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<div class="sourceCode" id="cb160" data-startFrom="43"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 42;"><span id="cb160-43"><a href="#cb160-43"></a>  unique_lock<span class="op">&lt;</span>mutex<span class="op">&gt;</span> lock<span class="op">(</span>mx<span class="op">);</span></span>
<span id="cb160-44"><a href="#cb160-44"></a>  undetached_threads_number<span class="op">++;</span></span>
<span id="cb160-45"><a href="#cb160-45"></a>  kernel<span class="op">.</span>make_ready<span class="op">(</span>ti<span class="op">);</span></span>
<span id="cb160-46"><a href="#cb160-46"></a><span class="op">}</span></span>
<span id="cb160-47"><a href="#cb160-47"></a><span class="dt">void</span> thread<span class="op">::</span>join<span class="op">()</span> <span class="op">{</span></span>
<span id="cb160-48"><a href="#cb160-48"></a>  unique_lock<span class="op">&lt;</span>mutex<span class="op">&gt;</span> lock<span class="op">(</span>mx<span class="op">);</span></span>
<span id="cb160-49"><a href="#cb160-49"></a>  <span class="cf">if</span> <span class="op">(</span>ti<span class="op">-&gt;</span>priority <span class="op">!=</span> TERMINAL<span class="op">)</span></span></code></pre></div>
</section>
<section id="klase-thread_image-i-thread-10" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<div class="sourceCode" id="cb161" data-startFrom="50"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 49;"><span id="cb161-50"><a href="#cb161-50"></a>    ti<span class="op">-&gt;</span>ended<span class="op">.</span>wait<span class="op">(</span>lock<span class="op">);</span></span>
<span id="cb161-51"><a href="#cb161-51"></a><span class="op">}</span></span>
<span id="cb161-52"><a href="#cb161-52"></a><span class="dt">void</span> thread<span class="op">::</span>detach<span class="op">()</span> <span class="op">{</span></span>
<span id="cb161-53"><a href="#cb161-53"></a>  unique_lock<span class="op">&lt;</span>mutex<span class="op">&gt;</span> lock<span class="op">(</span>mx<span class="op">);</span></span>
<span id="cb161-54"><a href="#cb161-54"></a>  <span class="cf">if</span> <span class="op">((</span>ti<span class="op">-&gt;</span>priority <span class="op">!=</span> TERMINAL<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(!</span>ti<span class="op">-&gt;</span>detached<span class="op">))</span> <span class="op">{</span></span>
<span id="cb161-55"><a href="#cb161-55"></a>    ti<span class="op">-&gt;</span>detached <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb161-56"><a href="#cb161-56"></a>    undetached_threads_number<span class="op">--;</span></span></code></pre></div>
</section>
<section id="klase-thread_image-i-thread-11" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<div class="sourceCode" id="cb162" data-startFrom="57"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 56;"><span id="cb162-57"><a href="#cb162-57"></a>  <span class="op">}</span></span>
<span id="cb162-58"><a href="#cb162-58"></a><span class="op">}</span></span>
<span id="cb162-59"><a href="#cb162-59"></a><span class="dt">void</span> thread_destroyer_deamon<span class="op">()</span> <span class="op">{</span></span>
<span id="cb162-60"><a href="#cb162-60"></a>  <span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb162-61"><a href="#cb162-61"></a>    unique_lock<span class="op">&lt;</span>mutex<span class="op">&gt;</span> lock<span class="op">(</span>thread<span class="op">::</span>mx<span class="op">);</span></span>
<span id="cb162-62"><a href="#cb162-62"></a>    thread<span class="op">::</span>termination<span class="op">.</span>wait<span class="op">(</span>lock<span class="op">);</span></span>
<span id="cb162-63"><a href="#cb162-63"></a>    <span class="kw">delete</span> thread<span class="op">::</span>terminating<span class="op">;</span></span></code></pre></div>
</section>
<section id="klase-thread_image-i-thread-12" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<div class="sourceCode" id="cb163" data-startFrom="64"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 63;"><span id="cb163-64"><a href="#cb163-64"></a>  <span class="op">}</span></span>
<span id="cb163-65"><a href="#cb163-65"></a><span class="op">}</span></span>
<span id="cb163-66"><a href="#cb163-66"></a><span class="dt">void</span> destroy<span class="op">()</span> <span class="op">{</span></span>
<span id="cb163-67"><a href="#cb163-67"></a>  unique_lock<span class="op">&lt;</span>mutex<span class="op">&gt;</span> lock<span class="op">(</span>thread<span class="op">::</span>mx<span class="op">);</span></span>
<span id="cb163-68"><a href="#cb163-68"></a>  thread<span class="op">::</span>terminating <span class="op">=</span> <span class="op">(</span>Thread_image <span class="op">*)</span>kernel<span class="op">.</span>active_get<span class="op">();</span></span>
<span id="cb163-69"><a href="#cb163-69"></a>  <span class="cf">while</span> <span class="op">(</span>thread<span class="op">::</span>terminating<span class="op">-&gt;</span>ended<span class="op">.</span>last<span class="op">())</span></span>
<span id="cb163-70"><a href="#cb163-70"></a>    thread<span class="op">::</span>terminating<span class="op">-&gt;</span>ended<span class="op">.</span>notify_one<span class="op">();</span></span></code></pre></div>
</section>
<section id="klase-thread_image-i-thread-13" class="slide level2">
<h2>Klase Thread_image i thread</h2>
<div class="sourceCode" id="cb164" data-startFrom="71"><pre
class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 70;"><span id="cb164-71"><a href="#cb164-71"></a>  <span class="cf">if</span> <span class="op">(!</span>thread<span class="op">::</span>terminating<span class="op">-&gt;</span>detached<span class="op">)</span></span>
<span id="cb164-72"><a href="#cb164-72"></a>    thread<span class="op">::</span>undetached_threads_number<span class="op">--;</span></span>
<span id="cb164-73"><a href="#cb164-73"></a>  thread<span class="op">::</span>terminating<span class="op">-&gt;</span>priority <span class="op">=</span> TERMINAL<span class="op">;</span></span>
<span id="cb164-74"><a href="#cb164-74"></a>  thread<span class="op">::</span>termination<span class="op">.</span>notify_one<span class="op">();</span></span>
<span id="cb164-75"><a href="#cb164-75"></a><span class="op">}</span></span>
<span id="cb164-76"><a href="#cb164-76"></a><span class="dt">bool</span> undetached_threads<span class="op">()</span> <span class="op">{</span> <span class="cf">return</span> <span class="op">(</span>thread<span class="op">::</span>undetached_threads_number <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span> <span class="op">}</span></span></code></pre></div>
</section>
<section id="klasa-delta" class="slide level2">
<h2>Klasa Delta</h2>
<ul>
<li>Klasa Delta i funkcije thread_wake_up_deamon(), sleep_for() i
sleep_until() zajedno omogućuju uspavljivanje i buđenje niti, a funkcija
thread_zero() opisuje aktivnost nulte (sistemske) niti.</li>
<li>sleep_for() omogućuje uspavljivanje aktivne niti dok ne protekne
zadani broj otkucaja sata</li>
<li>sleep_until() omogućuje uspavljivanje aktivne niti dok ne nastupi
zadani trenutak sistemskog vremena.</li>
</ul>
</section>
<section id="klasa-delta-1" class="slide level2">
<h2>Klasa Delta</h2>
<ul>
<li>Oko polja list klase Delta se formira lista deskriptora uspavanih
niti.</li>
<li>Da se za svaku uspavanu nit ne bi proveravalo, nakon svakog
otkucaja, da li je nastupilo vreme njenog buđenja, deskriptori uspavanih
niti se uvezuju u listu u hronološkom redosledu buđenja niti.</li>
<li>Svakom od ovih deskriptora je dodeljen privezak koji pokazuje
relativno vreme buđenja (relativni broj otkucaja do buđenja) u odnosu na
prethodnika u listi.</li>
<li>Ovakva lista se zove delta lista.</li>
<li>Zahvaljujući delta listi, nakon svakog otkucaja potrebno je
proveriti da li je nastupio trenutak buđenja samo za nit koja se
najranije budi, odnosno samo za prvi deskriptor iz delta liste.</li>
<li>Pošto može da bude više niti, čije buđenje je vezano za isti
trenutak, unapred nije poznato koliko niti treba probuditi nakon
otkucaja sata.</li>
</ul>
</section>
<section id="klasa-delta-2" class="slide level2">
<h2>Klasa Delta</h2>
<ul>
<li>Operaciju awake() klase Delta poziva sistemska nit Wake_up_daemon().
Vreme njenog buđenja je uvek jednako najranijem vremenu buđenja
korisničkih niti.</li>
<li>Nakon buđenja, sistemska nit budi sve korisničke niti sa početka
delta liste, za koje je nastupio trenutak buđenja.</li>
<li>Čekanje buđenja omogućuje poziv operacije
Timer_driver::alarm.expect().</li>
</ul>
</section>
<section id="klasa-delta-3" class="slide level2">
<h2>Klasa Delta</h2>
<ul>
<li>Dužinu čekanja određuje vrednost lokalne promenljive tag, kada ima
uspavanih korisničkih niti (na čije prisustvo ukazuje vrednost lokalne
promenljive sleeping).</li>
<li>Dužina čekanja se skraćuje za vrednost lokalne promenljive
passed_ticks, koja registruje vreme proteklo na buđenju korisničkih
niti.</li>
</ul>
</section>
<section id="klasa-delta-4" class="slide level2">
<h2>Klasa Delta</h2>
<ul>
<li>Operaciju sleep() klase Delta poziva, posredstvom funkcije
sleep_for(), korisnička nit, da bi se njen deskriptor uključio u delta
listu, a njena aktivnost privremeno zaustavila.</li>
<li>Konstruktor klase Delta omogućuje kreiranje sistemskih niti
korišćenjem bezimenih (privremenih) objekata klase thread.</li>
<li>Konzistentnost delta liste štite isključivi regioni u telima
operacija awake() i sleep() klase Delta.</li>
</ul>
</section></section>
    </div>
  </div>

  <script src="https://unpkg.com/reveal.js@^4//dist/reveal.js"></script>

  <!-- reveal.js plugins -->
  <script src="https://unpkg.com/reveal.js@^4//plugin/notes/notes.js"></script>
  <script src="https://unpkg.com/reveal.js@^4//plugin/search/search.js"></script>
  <script src="https://unpkg.com/reveal.js@^4//plugin/zoom/zoom.js"></script>
  <script src="https://unpkg.com/reveal.js@^4//plugin/math/math.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
        // Display controls in the bottom right corner
        controls: true,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: true,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'bottom-right',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: false,

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: false,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: true,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'default',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: true,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'slide',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'fade',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [
          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    </body>
</html>

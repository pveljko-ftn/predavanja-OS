<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Veljko Petrović">
  <title>Operativni Sistemi - Simulator operativnog sistema 2</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4//dist/reset.css">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4//dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4//dist/theme/night.css" id="theme">
  <link rel="stylesheet" href="slides.css"/>
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section id="title-slide">
  <h1 class="title">Operativni Sistemi - Simulator operativnog sistema 2</h1>
  <p class="author">Veljko Petrović</p>
  <p class="date">Mart, 2023</p>
</section>

<section>
<section id="virtuelna-mašina-simulatora" class="title-slide slide level1">
<h1>Virtuelna Mašina Simulatora</h1>

</section>
<section id="upozorenje" class="slide level2">
<h2>Upozorenje</h2>
<ul>
<li>Termin ‘virtuelna mašina’ se koristi u više značenja u računarskim naukama</li>
<li>Značenje kako ga koristimo ovde nije nijedno od onih na koje ste vi navikli</li>
<li>Znači, u ovom slučaju, više <em>simulator</em> hardvera.</li>
</ul>
</section>
<section id="vm" class="slide level2">
<h2>VM</h2>
<ul>
<li>Razvojna verzija konkurentne biblioteke CppTss sadrži virtuelnu mašinu koja za potrebe ostatka ove biblioteke:
<ul>
<li>emulira kontrolere tastature, ekrana i diska</li>
<li>emulira mehanizam prekida</li>
<li>podržava okončanje izvršavanja konkurentnog programa</li>
<li>podržava rukovanje pojedinim bitima memorijskih lokacija</li>
<li>podržava rukovanje numeričkim koprocesorom (Numeric Processor Extension – NPX)</li>
<li>podržava rukovanje stekom</li>
</ul></li>
</ul>
</section>
<section id="neophodna-zaglavlja" class="slide level2">
<h2>Neophodna zaglavlja</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&lt;strings.h&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&lt;termios.h&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&lt;signal.h&gt;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&lt;sys/time.h&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span></code></pre></div>
</section>
<section id="emulacija-mehanizma-prekida" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Emulacija mehanizma prekida se zasniva na:
<ul>
<li>uvođenju (emulirane) tabele prekida</li>
<li>uvođenju (emuliranog) bita prekida<br />
</li>
<li>obezbeđenju nezavisnosti (asinhronosti) između prekida i izvršavanja konkurentnog programa</li>
</ul></li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-1" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Potrebe CppTss biblioteke su uzrokovale da (emulirana) tabela prekida sadrži pet elemenata.</li>
<li>Prvi od njih je namenjen za vektor obrađivača hardverskog izuzetka (<code>FLOATING POINT EXCEPTION</code>), a drugi je rezervisan za vektor obrađivača prekida sata.</li>
<li>Preostala tri su predviđena za vektore obrađivača prekida tastature, ekrana i diska.</li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-2" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="at">const</span> <span class="dt">unsigned</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>INTERRUPT_TABLE_VECTOR_COUNT <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> Vector_numbers <span class="op">{</span> FP_EXCEPTION<span class="op">,</span> TIMER<span class="op">,</span> KEYBOARD<span class="op">,</span> DISPLAY<span class="op">,</span> DISK <span class="op">};</span></span></code></pre></div>
</section>
<section id="emulacija-mehanizma-prekida-3" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Svrha (emuliranog) bita prekida je da označi da li je ili nije omogućena obrada prekida. Ovakav bit zaista postoji u <code>FLAGS</code> registru, recimo, x86 procesora i kontroliše se sa <code>sti</code> i <code>cli</code> instrukcijama.</li>
<li>Emulacija bita prekida je ostvarena pomoću promenljive <code>interrupts_enabled</code> i funkcija <code>ad__disable_interrupt()</code> i <code>ad__restore_interrupts()</code>.</li>
<li>Promenljiva <code>interrupts_enabled</code> sadrži (emulirani) bit prekida. Njena vrednost određuje da li su (emulirani) prekidi omogućeni (konstanta true) ili ne.</li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-4" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Prva od njih, izmenom (emuliranog) bita prekida, onemogućuje (emulirane) prekide, a druga poništava efekte prve, vraćajući (emulirani) bit prekida u prethodno stanje.</li>
<li>Kada operacija <code>ad__restore_interrupts()</code> utvrdi da je došlo do odlaganja obrade (emuliranih) prekida (<code>Interrupt::pending</code>), ona pokreće prethodno odloženu emulaciju kontrolera pozivom operacije <code>controller_emulator()</code> klase <code>Interrupt</code>.</li>
<li>Nakon toga se registruje da nema više odloženih obrada (emuliranih) prekida.</li>
</ul>
</section>
<section id="emulacija-prekida" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> interrupts_enabled <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="at">static</span> <span class="dt">bool</span> ad__disable_interrupts<span class="op">(){</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> saved_interrupts_enabled <span class="op">=</span> interrupts_enabled<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    interrupts_enabled <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> saved_interrupts_enabled<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-1" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="dt">void</span> ad__restore_interrupts<span class="op">(</span><span class="dt">bool</span> saved_interrupts_enabled<span class="op">){</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>saved_interrupts_enabled <span class="op">&amp;&amp;</span> interrupt<span class="op">.</span>pending<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        interrupt<span class="op">.</span>controller_emulator<span class="op">();</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        interrupt<span class="op">.</span>pending <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    interrupts_enabled <span class="op">=</span> saved_interrupts_enabled<span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="emulacija-mehanizma-prekida-5" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Nezavisnost (emuliranih) prekida od izvršavanja konkurentnog programa se ostvaruje pomoću mehanizma signala Linux-a.</li>
<li>Ovaj mehanizam omogućuje da se na pojavu signala reaguje izvršavanjem odabrane funkcije (user level exception handling).</li>
<li>Ova funkcija se naziva obrađivač signala.</li>
<li>Signali su unapred definisani, a svaki od njih je pridružen jednoj vrsti događaja, kao što je isticanje zadanog vremenskog intervala (SIGVTALRM) ili pojava hardverskog izuzetka (SIGFPE).</li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-6" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Kada se takav događaj desi mehanizam signala zaustavi izvršavanje programa (u toku koga se desio dotični događaj), radi pokretanja izvršavanja odgovarajućeg obrađivača signala.</li>
<li>Nakon obrade dotičnog signala moguć je nastavak zaustavljenog izvršavanja programa.</li>
<li>Obrađivač signala je funkcija koja opisuje korisničku reakciju na pojavu odabranog signala.</li>
<li>Funkcija postaje obrađivač signala kada se poveže sa odgovarajućim signalom.</li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-7" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Pojava signala SIGVTALRM nije zavisna od izvršavanja konkurentnog programa.</li>
<li>Zadatak obrađivača signala SIGVTALRM je da pozove operaciju kontrolera i tako izazove obradu nekog od (emuliranih) prekida, a zadatak obrađivača signala SIGFPE je da izazove obradu izuzetka.</li>
<li>Za razliku od obrade izuzetaka, koja se uvek obavlja bez odlaganja, obrada (emuliranih) prekida se obavezno odlaže ako su (emulirani) prekidi onemogućeni.</li>
<li>Do obrade prethodno onemogućenog (emuliranog) prekida dolazi tek nakon omogućenja (emuliranih) prekida.</li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-8" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>U slučaju konkurentnog programa, pojava signala podstakne mehanizam signala da zaustavi zatečenu aktivnost niti i pokrene odgovarajućeg obrađivača signala.</li>
<li>Ako u sklopu obrade (emuliranog) prekida, koju izazove ovaj obrađivač signala, dođe do preključivanja na drugu nit, započeta obrada signala će biti završena tek nakon ponovnog preključivanja na prethodno zaustavljenu nit.</li>
<li>Da bi se u međuvremenu mogli obraditi novi signali, neophodno je da se razna izvršavanja obrađivača signala mogu preklapati.</li>
<li>Za takve obrađivače signala se kaže da su višeulazni (reentrant).</li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-9" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Klasa <code>Linux_signals</code> opisuje reakciju na Linux signale.</li>
<li>Njen konstruktor koristi njeno polje sa i sistemski poziv <code>sigaction()</code> da saopšti da njena operacija <code>signal_handler()</code> ima ulogu obrađivača signala <code>SIGVTALRM</code> i <code>SIGFPE</code>.</li>
<li>Ovaj konstruktor koristi konstantu <code>SA_NODEFER</code> (koju upisuje u polje <code>sa.sa_flags</code>) da saopšti da nema odlaganja obrada signala (da je obrađivač signala višeulazni).</li>
<li>Destruktor klase <code>Linux_signals</code> poništava akcije njenog konstruktora.</li>
<li>Obrađivač signala <code>Linux_signals::signal_handler()</code> u slučaju signala SIGVTALRM pozove emulaciju prekida (<code>Interrupt::emulation()</code>), a u slučaju signala SIGFPE pozove obrađivača izuzetka (<code>Interrupt::handler()</code>) koji opslužuje hardverski izuzetak.</li>
</ul>
</section>
<section id="emulacija-prekida-2" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Linux_signals <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> sigaction sa<span class="op">;</span> <span class="co">// struktura za definisanje signala</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> signal_handler<span class="op">(</span><span class="dt">int</span> signal<span class="op">);</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  Linux_signals<span class="op">(</span><span class="at">const</span> Linux_signals <span class="op">&amp;);</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  Linux_signals <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Linux_signals <span class="op">&amp;);</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-3" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  Linux_signals<span class="op">();</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">~</span>Linux_signals<span class="op">();</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Linux_signals<span class="op">::</span>signal_handler<span class="op">(</span><span class="dt">int</span> signal<span class="op">)</span> <span class="co">// override signala</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>signal<span class="op">)</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-4" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> SIGVTALRM<span class="op">:</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    interrupt<span class="op">.</span>emulation<span class="op">();</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> SIGFPE<span class="op">:</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    interrupt<span class="op">.</span>handler<span class="op">(</span>FP_EXCEPTION<span class="op">);</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-5" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>Linux_signals<span class="op">::</span>Linux_signals<span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  sa<span class="op">.</span>sa_handler <span class="op">=</span> signal_handler<span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  sigemptyset<span class="op">(&amp;(</span>sa<span class="op">.</span>sa_mask<span class="op">));</span>   <span class="co">// Ne blokiramo nijedan signal</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  sa<span class="op">.</span>sa_flags <span class="op">=</span> SA_NODEFER<span class="op">;</span>     <span class="co">// obrada bez odlaganja</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  sigaction<span class="op">(</span>SIGVTALRM<span class="op">,</span> <span class="op">&amp;</span>sa<span class="op">,</span> <span class="dv">0</span><span class="op">);</span> <span class="co">// promena signala za</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-6" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>  sigaction<span class="op">(</span>SIGFPE<span class="op">,</span> <span class="op">&amp;</span>sa<span class="op">,</span> <span class="dv">0</span><span class="op">);</span>    <span class="co">// SIGVTALRM i SIGFPE</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>Linux_signals<span class="op">::~</span>Linux_signals<span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  sa<span class="op">.</span>sa_handler <span class="op">=</span> SIG_DFL<span class="op">;</span> <span class="co">// vracanje na default</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  sigaction<span class="op">(</span>SIGVTALRM<span class="op">,</span> <span class="op">&amp;</span>sa<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  sigaction<span class="op">(</span>SIGFPE<span class="op">,</span> <span class="op">&amp;</span>sa<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-7" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>Linux_signals linux_signals<span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> LINUX_TIMER_INTERVAL <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Linux_timer <span class="op">{</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-8" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> itimerval itimer<span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  Linux_timer<span class="op">(</span><span class="at">const</span> Linux_timer <span class="op">&amp;);</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  Linux_timer <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Linux_timer <span class="op">&amp;);</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  Linux_timer<span class="op">();</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">~</span>Linux_timer<span class="op">();</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-9" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>Linux_timer<span class="op">::</span>Linux_timer<span class="op">()</span> <span class="co">// usec vreme se meri u mikrosekundama</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  itimer<span class="op">.</span>it_interval<span class="op">.</span>tv_sec <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// tekuća vrednost</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  itimer<span class="op">.</span>it_interval<span class="op">.</span>tv_usec <span class="op">=</span> LINUX_TIMER_INTERVAL <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  itimer<span class="op">.</span>it_value<span class="op">.</span>tv_sec <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// vrednost kojom se resetuje</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-10" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>  itimer<span class="op">.</span>it_value<span class="op">.</span>tv_usec <span class="op">=</span> LINUX_TIMER_INTERVAL <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  setitimer<span class="op">(</span>ITIMER_VIRTUAL<span class="op">,</span> <span class="op">&amp;</span>itimer<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>Linux_timer<span class="op">::~</span>Linux_timer<span class="op">()</span> <span class="op">{</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  itimer<span class="op">.</span>it_value<span class="op">.</span>tv_sec <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  itimer<span class="op">.</span>it_value<span class="op">.</span>tv_usec <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-11" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>  setitimer<span class="op">(</span>ITIMER_VIRTUAL<span class="op">,</span> <span class="op">&amp;</span>itimer<span class="op">,</span> <span class="dv">0</span><span class="op">);</span> <span class="co">// user mode timer</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> Linux_timer linux_timer<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-mehanizma-prekida-10" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>Klasa <code>Interrupt</code>:
<ul>
<li>uvodi (emuliranu) tabelu prekida (sadržanu u nizu vector)</li>
<li>omogućuje registrovanje odlaganja obrade (emuliranog) prekida (polje pending)</li>
<li>reguliše redosled pozivanja obrađivača pojedinih (emuliranih) prekida (polja controller_turn i timer_turn)</li>
</ul></li>
</ul>
</section>
<section id="emulacija-mehanizma-prekida-11" class="slide level2">
<h2>Emulacija mehanizma prekida</h2>
<ul>
<li>(Emulirana) tabela prekida se inicijalizuje tako da njeni elementi sadrže vektor podrazumevajućeg obrađivača prekida: default_interrupt_handler().</li>
<li>Operacija handler() klase Interrupt posreduje u pozivu obrađivača (emuliranog) prekida.</li>
<li>Operacija emulation() registruje odlaganje obrade prekida ili pokreće emulaciju kontrolera pozivom operacije controller_emulator().</li>
<li>U svakoj parnoj emulaciji kontrolera poziva se obrađivač (emuliranog) prekida sata (sa brojem vektora TIMER).</li>
<li>U svakoj neparnoj emulaciji kontrolera obavlja se, u kružnom redosladu, emulacija samo jednog od kontrolera (display_controller.output(), keyboard_controller.input() ili disk_controller.transfer()).</li>
<li>Operacija ad_set_vector() omogućuje izmenu vektora prekida.</li>
</ul>
</section>
<section id="emulacija-prekida-12" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb15"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Interrupt <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">void</span> <span class="op">(*</span>vector<span class="op">[</span>INTERRUPT_TABLE_VECTOR_COUNT<span class="op">])();</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> pending<span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> controller_turn<span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> timer_turn<span class="op">;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  Interrupt<span class="op">(</span><span class="at">const</span> Interrupt <span class="op">&amp;);</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  Interrupt <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Interrupt <span class="op">&amp;);</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-13" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  Interrupt<span class="op">();</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">inline</span> <span class="dt">void</span> handler<span class="op">(</span><span class="dt">unsigned</span> index<span class="op">);</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">inline</span> <span class="dt">void</span> emulation<span class="op">();</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">inline</span> <span class="dt">void</span> controller_emulator<span class="op">();</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">friend</span> <span class="kw">inline</span> <span class="dt">void</span> ad__restore_interrupts<span class="op">(</span><span class="dt">bool</span> new_interrupt_status<span class="op">);</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-14" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">friend</span> <span class="kw">inline</span> <span class="dt">void</span> ad__set_vector<span class="op">(</span><span class="dt">int</span> index<span class="op">,</span> <span class="dt">void</span> <span class="op">(*</span>handler<span class="op">)());</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> default_interrupt_handler<span class="op">()</span> <span class="op">{}</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">(*</span>Interrupt<span class="op">::</span>vector<span class="op">[</span>INTERRUPT_TABLE_VECTOR_COUNT<span class="op">])()</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    default_interrupt_handler<span class="op">};</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-15" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>Interrupt<span class="op">::</span>Interrupt<span class="op">()</span> <span class="op">:</span> pending<span class="op">(</span><span class="kw">false</span><span class="op">),</span> controller_turn<span class="op">(</span><span class="dv">0</span><span class="op">),</span> timer_turn<span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Interrupt<span class="op">::</span>handler<span class="op">(</span><span class="dt">unsigned</span> index<span class="op">)</span> <span class="op">{</span> <span class="op">(</span>vector<span class="op">[</span>index<span class="op">])();</span> <span class="op">}</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Interrupt<span class="op">::</span>emulation<span class="op">()</span> <span class="op">{</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>interrupts_enabled<span class="op">)</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-16" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>    interrupt<span class="op">.</span>pending <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    interrupts_enabled <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    controller_emulator<span class="op">();</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    interrupts_enabled <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-17" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> Interrupt<span class="op">::</span>controller_emulator<span class="op">()</span> <span class="op">{</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> interrupt_emulated<span class="op">;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> counter <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>timer_turn<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    timer_turn <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    handler<span class="op">(</span>TIMER<span class="op">);</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-18" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb21"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    timer_turn <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">switch</span> <span class="op">(</span>controller_turn<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        interrupt_emulated <span class="op">=</span> display_controller<span class="op">.</span>output<span class="op">();</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        controller_turn <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-19" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb22"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">1</span><span class="op">:</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>        interrupt_emulated <span class="op">=</span> keyboard_controller<span class="op">.</span>input<span class="op">();</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        controller_turn <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">2</span><span class="op">:</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        interrupt_emulated <span class="op">=</span> disk_controller<span class="op">.</span>transfer<span class="op">();</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-20" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb23"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>        controller_turn <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(!</span>interrupt_emulated <span class="op">&amp;&amp;</span> <span class="op">++</span>counter <span class="op">&lt;</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="emulacija-prekida-21" class="slide level2">
<h2>Emulacija prekida</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="dt">void</span> ad__set_vector<span class="op">(</span><span class="dt">int</span> index<span class="op">,</span> <span class="dt">void</span> <span class="op">(*</span>handler<span class="op">)())</span> <span class="op">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  Interrupt<span class="op">::</span>vector<span class="op">[</span>index<span class="op">]</span> <span class="op">=</span> handler<span class="op">;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>Interrupt interrupt<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-tastature" class="slide level2">
<h2>Emulacija kontrolera tastature</h2>
<ul>
<li>Klasa <code>Keyboard_controller</code> opisuje kontroler tastature.</li>
<li>Njeno polje <code>data_reg</code> predstavlja registar podataka kontrolera, a njena operacija <code>input()</code> opisuje ponašanje kontrolera tastature.</li>
<li>Ako postoji znak za preuzimanje, on se preuzima u okviru operacije <code>input()</code> posredstvom odgovarajućeg Linux sistemskog poziva.</li>
<li>Ujedno se poziva obrađivač prekida tastature posredstvom operacije <code>handler()</code>:</li>
<li><code>interrupt.handler(KEYBOARD)</code></li>
<li>klase <code>Interrupt</code> koja emulira tabelu prekida.</li>
<li>Operacija <code>input()</code> se periodično poziva u toku emulacije kontrolera.</li>
</ul>
</section>
<section id="emulacija-kontrolera-tastature-1" class="slide level2">
<h2>Emulacija kontrolera tastature</h2>
<div class="sourceCode" id="cb25"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Keyboard_controller <span class="op">{</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> data_reg<span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> input<span class="op">();</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  Keyboard_controller<span class="op">(</span><span class="at">const</span> Keyboard_controller <span class="op">&amp;);</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  Keyboard_controller <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Keyboard_controller <span class="op">&amp;);</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-tastature-2" class="slide level2">
<h2>Emulacija kontrolera tastature</h2>
<div class="sourceCode" id="cb26"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>  Keyboard_controller<span class="op">(){};</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">friend</span> <span class="kw">class</span> Interrupt<span class="op">;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">friend</span> <span class="kw">class</span> Keyboard_driver<span class="op">;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> Keyboard_controller<span class="op">::</span>input<span class="op">()</span> <span class="op">{</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> interrupt_emulated <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-tastature-3" class="slide level2">
<h2>Emulacija kontrolera tastature</h2>
<div class="sourceCode" id="cb27"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>  <span class="dt">unsigned</span> read_count<span class="op">;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> c<span class="op">;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  read_count <span class="op">=</span> read<span class="op">(</span>STDIN_FILENO<span class="op">,</span> <span class="op">&amp;</span>c<span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="co">// sys call</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>read_count <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    data_reg <span class="op">=</span> c<span class="op">;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    interrupt<span class="op">.</span>handler<span class="op">(</span>KEYBOARD<span class="op">);</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    interrupt_emulated <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-tastature-4" class="slide level2">
<h2>Emulacija kontrolera tastature</h2>
<div class="sourceCode" id="cb28"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> interrupt_emulated<span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>Keyboard_controller keyboard_controller<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-ekrana" class="slide level2">
<h2>Emulacija kontrolera ekrana</h2>
<ul>
<li>Klasa <code>Display_controller</code> opisuje kontroler ekrana.</li>
<li>Njena polja <code>data_reg</code> i <code>status_reg</code> predstavljaju registre podataka i stanja kontrolera, a njena operacija <code>output()</code> opisuje ponašanje kontrolera ekrana.</li>
<li>Ako postoji znak za prikazivanje, on se prikazuje u okviru operacije <code>output()</code> posredstvom odgovarajućeg Linux sistemskog poziva.</li>
<li>Ujedno se poziva obrađivač prekida ekrana posredstvom operacije <code>handler()</code> <code>interrupt.handler(DISPLAY)</code> klase <code>Interrupt</code> koja emulira tabelu prekida.</li>
<li>Operacija <code>output()</code> se periodično poziva u toku emulacije kontrolera.</li>
</ul>
</section>
<section id="emulacija-kontrolera-ekrana-1" class="slide level2">
<h2>Emulacija kontrolera ekrana</h2>
<div class="sourceCode" id="cb29"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> Display_status <span class="op">{</span> DISPLAY_READY<span class="op">,</span> DISPLAY_BUSY <span class="op">};</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Display_controller <span class="op">{</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> data_reg<span class="op">;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  Display_status status_reg<span class="op">;</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> output<span class="op">();</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  Display_controller<span class="op">(</span><span class="at">const</span> Display_controller <span class="op">&amp;);</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-ekrana-2" class="slide level2">
<h2>Emulacija kontrolera ekrana</h2>
<div class="sourceCode" id="cb30"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>  Display_controller <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Display_controller <span class="op">&amp;);</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  Display_controller<span class="op">()</span> <span class="op">:</span> status_reg<span class="op">(</span>DISPLAY_READY<span class="op">){};</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">friend</span> <span class="kw">class</span> Interrupt<span class="op">;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">friend</span> <span class="kw">class</span> Display_driver<span class="op">;</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-ekrana-3" class="slide level2">
<h2>Emulacija kontrolera ekrana</h2>
<div class="sourceCode" id="cb31"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> Display_controller<span class="op">::</span>output<span class="op">()</span> <span class="op">{</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> interrupt_emulated <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>status_reg <span class="op">==</span> DISPLAY_BUSY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> <span class="op">&amp;</span>data_reg<span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="co">// sys call</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    status_reg <span class="op">=</span> DISPLAY_READY<span class="op">;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    interrupt<span class="op">.</span>handler<span class="op">(</span>DISPLAY<span class="op">);</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-ekrana-4" class="slide level2">
<h2>Emulacija kontrolera ekrana</h2>
<div class="sourceCode" id="cb32"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>    interrupt_emulated <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> interrupt_emulated<span class="op">;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>Display_controller display_controller<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-tastature-i-ekrana" class="slide level2">
<h2>Emulacija kontrolera tastature i ekrana</h2>
<ul>
<li>Prethodne dve klase koriste tastaturu i ekran Linux terminala.</li>
<li>Za potrebe emulacije neophodno je isključiti eho (echo) Linux terminala, prevesti Linux terminal u režim rada bez linijskog editiranja (raw mode) i obezbediti da poziv čitanja znaka sa terminala bude neblokirajući.</li>
</ul>
</section>
<section id="emulacija-kontrolera-tastature-i-ekrana-1" class="slide level2">
<h2>Emulacija kontrolera tastature i ekrana</h2>
<ul>
<li>Sve prethodno obezbeđuje klasa <code>Linux_terminal</code> koji koristi polje <code>ots</code> ove klase da sačuva zatečeni režim rada Linux terminala, a <code>ts</code> polje da zada njegov novi režim rada.</li>
<li>Prethodno zatečeni režim rada Linux terminala ponovo uspostavlja destruktor klase <code>Linux_terminal</code>.</li>
<li>Ovaj destruktor se poziva na kraju aktivnosti procesa i radi provere da li postoje niti za koje nije regularno da kraj njihove aktivnosti nastupi kao posledica kraja aktivnosti procesa kome one pripadaju i radi obaveštenja o prevremenom završetku ovakvih niti.</li>
</ul>
</section>
<section id="rukovanje-terminalom" class="slide level2">
<h2>Rukovanje terminalom</h2>
<div class="sourceCode" id="cb33"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Linux_terminal <span class="op">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> termios ts<span class="op">;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> termios ots<span class="op">;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  Linux_terminal<span class="op">(</span><span class="at">const</span> Linux_terminal <span class="op">&amp;);</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  Linux_terminal <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Linux_terminal <span class="op">&amp;);</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span></code></pre></div>
</section>
<section id="rukovanje-terminalom-1" class="slide level2">
<h2>Rukovanje terminalom</h2>
<div class="sourceCode" id="cb34"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>  Linux_terminal<span class="op">();</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">~</span>Linux_terminal<span class="op">();</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>Linux_terminal<span class="op">::</span>Linux_terminal<span class="op">()</span> <span class="op">{</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  tcgetattr<span class="op">(</span>STDIN_FILENO<span class="op">,</span> <span class="op">&amp;</span>ts<span class="op">);</span> <span class="co">// preuzmi parametre terminala</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  ots <span class="op">=</span> ts<span class="op">;</span></span></code></pre></div>
</section>
<section id="rukovanje-terminalom-2" class="slide level2">
<h2>Rukovanje terminalom</h2>
<div class="sourceCode" id="cb35"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>  ts<span class="op">.</span>c_lflag <span class="op">&amp;=</span> <span class="op">~</span>ECHO<span class="op">;</span>   <span class="co">// zabrana eha na ekran</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  ts<span class="op">.</span>c_lflag <span class="op">&amp;=</span> <span class="op">~</span>ICANON<span class="op">;</span> <span class="co">// flag nekanonskog moda</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  ts<span class="op">.</span>c_cc<span class="op">[</span>VTIME<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>    <span class="co">// timeout u decisekunda za nekanonski read</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  ts<span class="op">.</span>c_cc<span class="op">[</span>VMIN<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>     <span class="co">// minimalni broj karaktera za nekanonski read</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  tcsetattr<span class="op">(</span>STDIN_FILENO<span class="op">,</span> TCSANOW<span class="op">,</span> <span class="op">&amp;</span>ts<span class="op">);</span> <span class="co">// postavi parametre term</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="rukovanje-terminalom-3" class="slide level2">
<h2>Rukovanje terminalom</h2>
<div class="sourceCode" id="cb36"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>Linux_terminal<span class="op">::~</span>Linux_terminal<span class="op">()</span> <span class="op">{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>undetached_threads<span class="op">())</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> <span class="op">&amp;</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">ERROR: DESTROYING UNDETACHED</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>               THREADS<span class="op">!</span>\n<span class="st">&quot;, 40);</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>        write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> <span class="op">&amp;</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    tcsetattr<span class="op">(</span>STDIN_FILENO<span class="op">,</span> TCSANOW<span class="op">,</span> <span class="op">&amp;</span>ots<span class="op">);</span> <span class="co">//povrati parametre</span></span></code></pre></div>
</section>
<section id="rukovanje-terminalom-4" class="slide level2">
<h2>Rukovanje terminalom</h2>
<div class="sourceCode" id="cb37"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> Linux_terminal linux_terminal<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-kontrolera-diska" class="slide level2">
<h2>Emulacija kontrolera diska</h2>
<ul>
<li>Klasa <code>Disk_controller</code> opisuje ponašanje kontrolera diska.</li>
<li>Njena polja <code>operation_reg</code>, <code>buffer_reg</code>, <code>block_reg</code> i <code>status_reg</code> odgovaraju registrima smera prenosa, bafera, bloka i stanja kontrolera, a njena operacija <code>transfer()</code> opisuje ponašanje kontrolera diska.</li>
<li>Konstruktor klase <code>Disk_controller</code> koristi sistemski poziv <code>calloc()</code> radi zauzimanja radne memorije, u kojoj se čuvaju blokovi emuliranog diska.</li>
</ul>
</section>
<section id="emulacija-kontrolera-diska-1" class="slide level2">
<h2>Emulacija kontrolera diska</h2>
<ul>
<li>Inercija diska se emulira brojanjem poziva operacije <code>transfer()</code>.</li>
<li>Kada broj poziva ove operacije postane jednak procenjenom broju vremenskih jedinica, potrebnom za prenos bloka, tada se obavi prenos bloka u okviru ove operacije i ujedno se pozove obrađivač prekida diska posredstvom operacije <code>handler()</code> <code>interrupt.handler(DISK)</code> klase Interrupt koja emulira tabelu prekida.</li>
<li>Operacija transfer() se periodično poziva u toku emulacije kontrolera.</li>
</ul>
</section>
<section id="emulacija-diska" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb38"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> Disk_operations <span class="op">{</span> DISK_READ<span class="op">,</span> DISK_WRITE <span class="op">};</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> Disk_status <span class="op">{</span> DISK_STARTED<span class="op">,</span> DISK_ACTIVE<span class="op">,</span> DISK_STOPPED <span class="op">};</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">unsigned</span> BLOCK_SIZE <span class="op">=</span> <span class="dv">512</span><span class="op">;</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">unsigned</span> DISK_BLOCKS <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">char</span> Disk_block<span class="op">[</span>BLOCK_SIZE<span class="op">];</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Disk_controller <span class="op">{</span></span></code></pre></div>
</section>
<section id="emulacija-diska-1" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb39"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>  Disk_block <span class="op">*</span>disk_space<span class="op">;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">unsigned</span> accessed_last<span class="op">;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">unsigned</span> transfer_time<span class="op">;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  Disk_operations operation_reg<span class="op">;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>buffer_reg<span class="op">;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">unsigned</span> block_reg<span class="op">;</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  Disk_status status_reg<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-diska-2" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb40"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> transfer<span class="op">();</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  Disk_controller<span class="op">(</span><span class="at">const</span> Disk_controller <span class="op">&amp;);</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  Disk_controller <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> Disk_controller <span class="op">&amp;);</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  Disk_controller<span class="op">();</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">~</span>Disk_controller<span class="op">();</span></span></code></pre></div>
</section>
<section id="emulacija-diska-3" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb41"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">friend</span> <span class="kw">class</span> Interrupt<span class="op">;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">friend</span> <span class="kw">class</span> Disk_driver<span class="op">;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>Disk_controller<span class="op">::</span>Disk_controller<span class="op">()</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">:</span> accessed_last<span class="op">(</span><span class="dv">0</span><span class="op">),</span> transfer_time<span class="op">(</span><span class="dv">0</span><span class="op">),</span> status_reg<span class="op">(</span>DISK_STOPPED<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  disk_space <span class="op">=</span> <span class="op">(</span>Disk_block <span class="op">*)</span>calloc<span class="op">(</span>DISK_BLOCKS<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Disk_block<span class="op">));</span></span></code></pre></div>
</section>
<section id="emulacija-diska-4" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb42"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>Disk_controller<span class="op">::~</span>Disk_controller<span class="op">()</span> <span class="op">{</span> free<span class="op">(</span>disk_space<span class="op">);</span> <span class="op">}</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> SECTORS_PER_TRACK <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> TRANSFER_TIME_AND_ROTATIONAL_DELAY <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-diska-5" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb43"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> Disk_controller<span class="op">::</span>transfer<span class="op">()</span> <span class="op">{</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> interrupt_emulated <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  Disk_block <span class="op">*</span>block_pointer<span class="op">;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> block_distance<span class="op">;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>status_reg <span class="op">==</span> DISK_STARTED<span class="op">)</span> <span class="op">{</span> <span class="co">// deo simulacije inercije rotacije diska</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    status_reg <span class="op">=</span> DISK_ACTIVE<span class="op">;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    block_distance <span class="op">=</span> accessed_last <span class="op">-</span> block_reg<span class="op">;</span></span></code></pre></div>
</section>
<section id="emulacija-diska-6" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb44"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>block_distance <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>      block_distance <span class="op">=</span> <span class="op">-</span>block_distance<span class="op">;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    transfer_time <span class="op">=</span> TRANSFER_TIME_AND_ROTATIONAL_DELAY<span class="op">;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    transfer_time <span class="op">+=</span> block_distance <span class="op">/</span> SECTORS_PER_TRACK<span class="op">;</span> <span class="co">// vreme rotacije</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    accessed_last <span class="op">=</span> block_reg<span class="op">;</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span>status_reg <span class="op">==</span> DISK_ACTIVE<span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(--</span>transfer_time <span class="op">==</span> <span class="dv">0</span><span class="op">))</span> <span class="op">{</span></span></code></pre></div>
</section>
<section id="emulacija-diska-7" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb45"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>    block_pointer <span class="op">=</span> disk_space <span class="op">+</span> block_reg<span class="op">;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>operation_reg <span class="op">==</span> DISK_WRITE<span class="op">)</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>      bcopy<span class="op">(</span>buffer_reg<span class="op">,</span> block_pointer<span class="op">,</span> BLOCK_SIZE<span class="op">);</span> <span class="co">// kopiraj bajte</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>      bcopy<span class="op">(</span>block_pointer<span class="op">,</span> buffer_reg<span class="op">,</span> BLOCK_SIZE<span class="op">);</span> <span class="co">// kopiraj bajte</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    status_reg <span class="op">=</span> DISK_STOPPED<span class="op">;</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    interrupt<span class="op">.</span>handler<span class="op">(</span>DISK<span class="op">);</span></span></code></pre></div>
</section>
<section id="emulacija-diska-8" class="slide level2">
<h2>Emulacija diska</h2>
<div class="sourceCode" id="cb46"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>    interrupt_emulated <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> interrupt_emulated<span class="op">;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>Disk_controller disk_controller<span class="op">;</span></span></code></pre></div>
</section>
<section id="okončanje-izvršavanja-konkurentnog-programa" class="slide level2">
<h2>Okončanje izvršavanja konkurentnog programa</h2>
<ul>
<li>Izvršavanje konkurentnog programa se okončava sistemskim pozivom <code>exit()</code>. To omogućuje funkcija <code>ad__report_and_finish()</code></li>
</ul>
</section>
<section id="okončanje-izvršavanja-konkurentnog-programa-1" class="slide level2">
<h2>Okončanje izvršavanja konkurentnog programa</h2>
<div class="sourceCode" id="cb47"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="dt">void</span> ad__report_and_finish<span class="op">(</span><span class="at">const</span> <span class="dt">char</span><span class="op">*</span> message_string<span class="op">){</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> length <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(</span>message_string<span class="op">[</span>length<span class="op">]</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>        length<span class="op">++;</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span>STDERR_FILENO<span class="op">,</span> message_string<span class="op">,</span> length<span class="op">);</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span>STDERR_FILENO<span class="op">,</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="asm-direktiva" class="slide level2">
<h2>ASM direktiva</h2>
<ul>
<li>C/C++ standard podrazumeva postojanje ASM direktive koja omogućava da se u C/C++ kod umetne asemblerski kod date platforme.</li>
<li>Standard ne definiše u detalje kako tačno ova funkcija treba da radi.</li>
<li>Mi radimo sa GCC kompajlerom, te stoga koristimo sintaksu koju uvodi GCC.</li>
</ul>
</section>
<section id="vrste-gcc-asm-direktive" class="slide level2">
<h2>Vrste GCC ASM direktive</h2>
<ul>
<li>U okviru GCC-a, postoje dve varijante ASM direktive:
<ul>
<li>Osnovna (basic) i</li>
<li>Proširena (extended)</li>
</ul></li>
<li>Osnovna služi da se samo navedu ASM komande, jedna za drugom, i ništa preko toga.</li>
<li>Proširena, omogućava integraciju između ASM koda i C koda kroz ulazno/izlazne parametre.</li>
</ul>
</section>
<section id="osnovna-asm-direktiva" class="slide level2">
<h2>Osnovna ASM direktiva</h2>
<p><code>asm asm-qualifiers ( AssemblerInstructions )</code></p>
</section>
<section id="osnovna-asm-direktiva-1" class="slide level2">
<h2>Osnovna ASM direktiva</h2>
<ul>
<li>Gde <code>asm-qualifiers</code> može biti:
<ul>
<li><code>volatile</code> — kaže kompajleru da ne optimizuje, podrazumevano za osnovni ASM kod</li>
<li><code>inline</code> — kaže kompajleru da minimizuje procenjenu veličinu ASM koda</li>
</ul></li>
</ul>
</section>
<section id="assemblerinstructions" class="slide level2">
<h2>AssemblerInstructions</h2>
<ul>
<li>Sastoje se od više linija od kojih je svaka u navodima i svaka se završava sa \t</li>
</ul>
<pre><code>asm (&quot;movl %eax, %ebx\n\t&quot;
     &quot;movl $56, %esi\n\t&quot;
     &quot;movl %ecx, $label(%edx,%ebx,$4)\n\t&quot;
     &quot;movb %ah, (%ebx)&quot;);</code></pre>
</section>
<section id="ansi-standardan-c" class="slide level2">
<h2>ANSI standardan C</h2>
<ul>
<li>Ponekad, ako se želi držati strogog ANSI standarda, uzimajući u obzir nešto neobičnih osobina ASM direktive u GCC-u, može se mesto ‘asm’ koristiti ‘<strong>asm</strong>.’ Nama to može trebati ako želimo da koristimo -std opciju zbog C++11 opcija</li>
<li>GCC tretira obe stvari apsolutno identično.</li>
</ul>
</section>
<section id="proširen-asm" class="slide level2">
<h2>Proširen ASM</h2>
<ul>
<li>Osnovni ASM nema jednostavan način da radi sa C kodom. Recimo, ako želite da u njemu modifikujete neku promenljivu iz C koda, to je nemoguće.</li>
<li>Stoga postoji proširen ASM koji to dozvoljava i čija se upotreba preporučuje.</li>
<li>Ograničenje u upotrebi ovakve ASM direktive jeste da se to mora činiti iz nekakve funkcije/metode.</li>
</ul>
</section>
<section id="sintaksa-proširenog-asm-a-bez-naredbe-skoka" class="slide level2">
<h2>Sintaksa proširenog ASM-a bez naredbe skoka</h2>
<pre><code>asm asm-qualifiers (
        AssemblerTemplate
        : OutputOperands
        : InputOperands
        : Clobbers
    )</code></pre>
</section>
<section id="sintaksa-proširenog-asm-a-sa-naredbama-skoka" class="slide level2">
<h2>Sintaksa proširenog ASM-a sa naredbama skoka</h2>
<pre><code>asm asm-qualifiers (
        AssemblerTemplate
        :
        : InputOperands
        : Clobbers
        : GotoLabels
    )</code></pre>
</section>
<section id="asm-qualifiers" class="slide level2">
<h2><code>asm-qualifiers</code></h2>
<ul>
<li><code>volatile</code> — isključuje stanovite optmizacije što je neophodno ako naš kod ima pobočne efekte, tj. ako radi nešto preko manipulacije ulaznih u izlazne vrednosti.</li>
<li><code>inline</code> — kao ranije</li>
<li><code>goto</code> — informišemo kompajler da asm kod može skočiti na neku od labela koje smo specificirali u ‘GotoLabels’ parametru. Ako je to ikako moguće, ovo valja izbeći.</li>
</ul>
</section>
<section id="assemblertemplate" class="slide level2">
<h2>AssemblerTemplate</h2>
<ul>
<li>Ponaša se kao instrukcije kod osnovne ASM direktive uz dve ključne razlike:
<ul>
<li>Kada označavamo registre, umesto da kažemo <code>%eax</code>, recimo, moramo reći <code>%%eax</code>.</li>
<li>Možemo da mesto parametara asemblerskih instrukcija da stavimo <code>%n</code> gde <code>n</code> nekakav broj i asm će umesto te oznake umetnuti vrednost koju pod tim brojem prosleđujemo iz C koda kroz specifikacije koje se nalaze u <code>OutputOperands</code> i <code>InputOperands</code></li>
</ul></li>
</ul>
</section>
<section id="outputoperandsinputoperands" class="slide level2">
<h2>OutputOperands/InputOperands</h2>
<ul>
<li>U oba slučaja su zarezima razdvojene liste koje smeju biti prazne.</li>
<li>U oba slučaja, takođe, elementi liste su oblika <code>"ograničenje" (izraz)</code></li>
<li>Gde je ograničenje string sa raznim simbolima koji definišu kako koristimo dati operand, dok je izraz nekakav C izraz (gotovo uvek promenljiva) koju umećemo u naš ASM kod.</li>
</ul>
</section>
<section id="ograničenja" class="slide level2">
<h2>Ograničenja</h2>
<p><img data-src="img/2023-03-28-05-27-25.png" /></p>
</section>
<section id="ograničenja-1" class="slide level2">
<h2>Ograničenja</h2>
<p><img data-src="img/2023-03-28-05-27-47.png" /></p>
</section>
<section id="clobbers" class="slide level2">
<h2>Clobbers</h2>
<ul>
<li>Ovo je lista stringova u duplim navodnicima razdvojenih zarezima, koja sadrži sve registre koji se menjaju kao pobočni efekat operacija koje izvršavamo.</li>
<li>To govori kompajleru da ne očekuje da te vrednosti ostanu iste što utiče na optimizaciju.</li>
<li>Osim što možemo staviti, npr, “eax” ili “ecx” ovde, može se navesti i “memory” što znači da se modifikuje sadržaj memorije na koji se ne referencira u output sekciji. Kod koji stavlja memory u clobber listu mora biti volatile.</li>
</ul>
</section>
<section id="rukovanje-pojedinim-bitima-memorijskih-lokacija" class="slide level2">
<h2>Rukovanje pojedinim bitima memorijskih lokacija</h2>
<ul>
<li>Emulacija hardvera je namenjena za platforme zasnovane na i386 (i novijim) procesorima koji podržavaju asemblerske naredbe za:
<ul>
<li>dobijanje indeksa najznačajnijeg postavljenog bita u reči <code>bsr</code></li>
<li>postavljanje datog bita reči <code>bts</code></li>
<li>za njegovo čišćenje <code>btr</code></li>
</ul></li>
<li>Funkcije <code>ad__get_index_of_most_signifcant_set_bit()</code>, <code>ad__set_bit()</code> i <code>ad__clear_bit()</code> posreduju u korišćenju ovih asemblerskih naredbi.</li>
</ul>
</section>
<section id="bitwise-asembler" class="slide level2">
<h2>Bitwise asembler</h2>
<div class="sourceCode" id="cb51"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="at">static</span> <span class="dt">int</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>ad__get_index_of_most_significant_set_bit<span class="op">(</span><span class="dt">unsigned</span> priority_bits<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> index<span class="op">;</span>               <span class="co">// poziv asm bit scan reverse</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">asm</span><span class="op">(</span><span class="st">&quot;bsr %1, %0&quot;</span>         <span class="co">//%1 indeks msb, %0 ulazni biti</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="st">&quot;=r&quot;</span><span class="op">(</span>index<span class="op">)</span>        <span class="co">// uvek ide prvo izlazni operand</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="st">&quot;r&quot;</span><span class="op">(</span>priority_bits<span class="op">)</span> <span class="co">// pa ulazni operand</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">);</span></span></code></pre></div>
</section>
<section id="bitwise-asembler-1" class="slide level2">
<h2>Bitwise asembler</h2>
<div class="sourceCode" id="cb52"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> index<span class="op">;</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="at">static</span> <span class="dt">unsigned</span> ad__set_bit<span class="op">(</span><span class="dt">unsigned</span> priority_bits<span class="op">,</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">int</span> index<span class="op">)</span> <span class="op">{</span> <span class="co">// poziva asm bit test and set</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">asm</span><span class="op">(</span><span class="st">&quot;bts %1, %0&quot;</span>                              <span class="co">//%1 indeks bita, %ulazni biti</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="st">&quot;=r&quot;</span><span class="op">(</span>priority_bits<span class="op">)</span>                     <span class="co">// ulazno izlazni operand pb</span></span></code></pre></div>
</section>
<section id="bitwise-asembler-2" class="slide level2">
<h2>Bitwise asembler</h2>
<div class="sourceCode" id="cb53"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="st">&quot;r&quot;</span><span class="op">(</span>index<span class="op">),</span> <span class="st">&quot;0&quot;</span><span class="op">(</span>priority_bits<span class="op">)</span>          <span class="co">// ulazni operand indeks i</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">);</span>                                            <span class="co">// izlazni operand pb</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> priority_bits<span class="op">;</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="at">static</span> <span class="dt">int</span> ad__clear_bit<span class="op">(</span><span class="dt">unsigned</span> priority_bits<span class="op">,</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>                                <span class="dt">int</span> index<span class="op">)</span> <span class="op">{</span> <span class="co">// poziva asm bit test and reset</span></span></code></pre></div>
</section>
<section id="bitwise-asembler-3" class="slide level2">
<h2>Bitwise asembler</h2>
<div class="sourceCode" id="cb54"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">asm</span><span class="op">(</span><span class="st">&quot;btr %1, %0&quot;</span> <span class="op">:</span> <span class="st">&quot;=r&quot;</span><span class="op">(</span>priority_bits<span class="op">)</span> <span class="op">:</span> <span class="st">&quot;r&quot;</span><span class="op">(</span>index<span class="op">),</span> <span class="st">&quot;0&quot;</span><span class="op">(</span>priority_bits<span class="op">));</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> priority_bits<span class="op">;</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="rukovanje-numeričkim-koprocesorom" class="slide level2">
<h2>Rukovanje numeričkim koprocesorom</h2>
<ul>
<li>Preključivanje procesora sa jedne niti na drugu podrazumeva da se sačuva kontekst (sadržaj registara) prve niti i uspostavi kontekst druge niti.</li>
<li>Kontekst se čuva na steku niti i obuhvata i registre numeričkog koprocesora.</li>
<li>Klasa <code>I387_npx</code> omogućuje pripremu i preuzimanje inicijalnog sadržaja registara numeričkog koprocesora.</li>
<li>Konstruktor klase <code>I387_npx</code> inicijalizuje registre numeričkog koprocesora i smešta njihov inicijalni sadržaj u polje <code>initial_context</code> ove klase pomoću asemblerskih naredbi <code>fninit</code> i <code>fnsave</code>.</li>
<li>Operacija <code>initial_context_get()</code> klase <code>I387_npx</code> omogućuje preuzimanje inicijalnog sadržaja registara numeričkog koprocesora.</li>
</ul>
</section>
<section id="rukovanje-fpu-mehanizmom" class="slide level2">
<h2>Rukovanje FPU mehanizmom</h2>
<div class="sourceCode" id="cb55"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">unsigned</span> i387_SAVE_REGION_SIZE <span class="op">=</span> <span class="bn">0x6c</span><span class="op">;</span> <span class="co">// velicina FPU steka</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> I387_npx <span class="op">{</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">char</span> initial_context<span class="op">[</span>i387_SAVE_REGION_SIZE<span class="op">];</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  I387_npx<span class="op">(</span><span class="at">const</span> I387_npx <span class="op">&amp;);</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  I387_npx <span class="op">&amp;</span><span class="kw">operator</span><span class="op">=(</span><span class="at">const</span> I387_npx <span class="op">&amp;);</span></span></code></pre></div>
</section>
<section id="rukovanje-fpu-mehanizmom-1" class="slide level2">
<h2>Rukovanje FPU mehanizmom</h2>
<div class="sourceCode" id="cb56"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  I387_npx<span class="op">();</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">inline</span> <span class="dt">void</span> initial_context_get<span class="op">(</span>Stack_item <span class="op">*</span>stack_top<span class="op">);</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> I387_npx<span class="op">::</span>initial_context<span class="op">[</span>i387_SAVE_REGION_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span></code></pre></div>
</section>
<section id="rukovanje-fpu-mehanizmom-2" class="slide level2">
<h2>Rukovanje FPU mehanizmom</h2>
<div class="sourceCode" id="cb57"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>I387_npx<span class="op">::</span>I387_npx<span class="op">()</span> <span class="op">{</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">asm</span> <span class="at">volatile</span><span class="op">(</span>         <span class="co">// volatile indikacija kompajleru da ne optimizuje</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;fninit </span><span class="sc">\n\t</span><span class="st">&quot;</span>     <span class="co">// inicijalizacija FPU, status, tag, IP, DP</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;fnsavel %0 </span><span class="sc">\n\t</span><span class="st">&quot;</span> <span class="co">// sacuvaj FPU state u initial_context</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">:</span> <span class="st">&quot;m&quot;</span><span class="op">(*</span>initial_context<span class="op">));</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="rukovanje-fpu-mehanizmom-3" class="slide level2">
<h2>Rukovanje FPU mehanizmom</h2>
<div class="sourceCode" id="cb58"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> I387_npx<span class="op">::</span>initial_context_get<span class="op">(</span>Stack_item <span class="op">*</span>stack_top<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> i387_SAVE_REGION_SIZE<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">((</span><span class="dt">char</span> <span class="op">*)</span>stack_top<span class="op">)[</span>i<span class="op">]</span> <span class="op">=</span> initial_context<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> I387_npx i387_npx<span class="op">;</span></span></code></pre></div>
</section>
<section id="rukovanje-stekom" class="slide level2">
<h2>Rukovanje stekom</h2>
<ul>
<li>Za uspeh preključivanja je neophodno da funkcija preključivanja na steku druge niti zatekne ispravan frejm (ako je nit već bila aktivna) ili ako ima spremljen inicijalni kontekst.</li>
<li>To je obezbeđeno kada se procesor preključuje na nit koja je već bila aktivna. Ali, ako se procesor prvi put preključuje na neku nit, on na njenom steku mora zateći frejm sa ranije pripremljenim njenim inicijalnim kontekstom.</li>
</ul>
</section>
<section id="rukovanje-stekom-1" class="slide level2">
<h2>Rukovanje stekom</h2>
<ul>
<li>Podrazumeva se da prvo preključivanje na neku nit dovodi do početka izvršavanja funkcije koja opisuje dotičnu nit.</li>
<li>Da bi izvršavanje ove funkcije bilo moguće, neophodno je na steku niti pripremiti frejm njenog poziva sa odgovarajućom povratnom adresom.</li>
<li>Kao povratna adresa služi adresa funkcije <code>destroy()</code>.</li>
<li>Do izvršavanja funkcije koja opisuje nit dolazi nakon povratka iz funkcije preključivanja, ako se na steku niti pripremi i frejm poziva funkcije preključivanja u kome se kao povratna adresa koristi adresa funkcije koja opisuje nit.</li>
<li>Pomenuta dva frejma (frejm poziva funkcije koja opisuje nit i frejm poziva funkcije preključivanja) na steku stvarane niti pripremi funkcija <code>ad__stack_init</code></li>
</ul>
</section>
<section id="inicijalizacija-steka" class="slide level2">
<h2>Inicijalizacija steka</h2>
<div class="sourceCode" id="cb59"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> INITIAL_FLAGS <span class="op">=</span> <span class="bn">0x0200</span><span class="op">;</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="kw">inline</span> <span class="dt">void</span> ad__stack_init<span class="op">(</span>Stack_item <span class="op">**</span>stack_top<span class="op">,</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="dt">unsigned</span> thread_function<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span>destroy<span class="op">;</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span>thread_function<span class="op">;</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="inicijalizacija-steka-1" class="slide level2">
<h2>Inicijalizacija steka</h2>
<div class="sourceCode" id="cb60"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span>INITIAL_FLAGS<span class="op">;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span></code></pre></div>
</section>
<section id="inicijalizacija-steka-2" class="slide level2">
<h2>Inicijalizacija steka</h2>
<div class="sourceCode" id="cb61"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(--(*</span>stack_top<span class="op">))</span> <span class="op">=</span> <span class="op">(</span>Stack_item<span class="op">)</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>stack_top <span class="op">=</span> <span class="op">(</span>Stack_item <span class="op">*)(((</span><span class="dt">size_t</span><span class="op">)(*</span>stack_top<span class="op">))</span> <span class="op">-</span> i387_SAVE_REGION_SIZE<span class="op">);</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  i387_npx<span class="op">.</span>initial_context_get<span class="op">(*</span>stack_top<span class="op">);</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="inicijalizacija-steka-3" class="slide level2">
<h2>Inicijalizacija steka</h2>
<div class="sourceCode" id="cb62"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> <span class="dt">void</span> ad__stack_swap<span class="op">(</span>Stack_item <span class="op">**</span><span class="at">const</span> old_stack<span class="op">,</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">const</span> Stack_item <span class="op">*</span>new_stack<span class="op">);</span></span></code></pre></div>
</section>
<section id="šematski-prikaz-steka" class="slide level2">
<h2>Šematski prikaz steka</h2>
<p><img data-src="img/2023-03-28-06-11-43.png" /></p>
</section>
<section id="rukovanje-stekom-2" class="slide level2">
<h2>Rukovanje stekom</h2>
<ul>
<li>Funkcija <code>ad__stack_init</code> na stek smesti:
<ul>
<li>Adresu funkcije destroy() kao povratnu adresu funkcije koja opisuje stvaranu nit</li>
<li>Adresu funkcije thread_function() kao povratnu adresu funkcije preključivanja</li>
<li>Kontekst niti na koju se procesor prvi put preključuje:</li>
<li>Pokazivač prethodnog frejma (0) – nema prethodnog frejma</li>
<li>Početno stanje emuliranog bita prekida (true)</li>
<li>Početno stanje status (flag) registra – INITIAL_FLAGS</li>
<li>Početni sadržaj registara procesora (za registre opšte namene 0, za sadržaj koprocesora rezultat poziva operacije initial_context_get() klase i387_npx</li>
</ul></li>
</ul>
</section>
<section id="swap" class="slide level2">
<h2>Swap</h2>
<ul>
<li>Funkcija ad__stack_swap() ima ulogu funkcije preključivanja. Pošto je ona napisana asemblerskim jezikom, radi provere ispravnosti njenih poziva uvedena je njena C deklaracija.</li>
</ul>
</section>
<section id="swap-1" class="slide level2">
<h2>Swap</h2>
<div class="sourceCode" id="cb63"><pre class="sourceCode gnuassembler"><code class="sourceCode gnuassembler"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">.text</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="kw">.align</span> <span class="dv">2</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="kw">.globl</span> ad__stack_swap</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ad__stack_swap:</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    pushl <span class="op">%</span>ebp  <span class="op">//</span>cuvanje zatecenog pokazivaca stek frejma</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    movl <span class="op">%</span>esp<span class="op">,%</span>ebp  <span class="op">//</span>postavljanje novog pokazivaca frejma</span></code></pre></div>
</section>
<section id="swap-2" class="slide level2">
<h2>Swap</h2>
<div class="sourceCode" id="cb64"><pre class="sourceCode gnuassembler"><code class="sourceCode gnuassembler"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>    movl <span class="dv">8</span><span class="op">(%</span>ebp<span class="op">),%</span>edx<span class="op">//</span>adresa vrha steka iz deskriptora niti sa</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>             <span class="op">//</span> koje se procesor prekljucuje</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    mov interrupts_enabled<span class="op">,%</span>eax  <span class="op">//</span>na stek aktivne niti se smesta</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    push <span class="op">%</span>eax       <span class="op">//</span>zateceno stanje bita prekida</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    pushf           <span class="op">//</span>smestanje flags registra na stek</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    pusha           <span class="op">//</span>smestanje svih registara opste namene na stek</span></code></pre></div>
</section>
<section id="swap-3" class="slide level2">
<h2>Swap</h2>
<div class="sourceCode" id="cb65"><pre class="sourceCode gnuassembler"><code class="sourceCode gnuassembler"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>    sub i387_SAVE_REGION_SIZE<span class="op">,%</span>esp</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    fnsavel <span class="op">(%</span>esp<span class="op">)</span>  <span class="op">//</span>smestanje sadrzaja reg koprocesora na stek</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>        mov <span class="op">%</span>esp<span class="op">,(%</span>edx<span class="op">)//</span>adresa vrha steka se smesti u deskriptor</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>            <span class="op">//</span>do tada aktivne niti <span class="op">(</span>lokacija u <span class="op">%</span>edx<span class="op">)</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    mov <span class="dv">12</span><span class="op">(%</span>ebp<span class="op">),%</span>esp<span class="op">//</span>u pokazivac steka se prebaci adresa vrha</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">//</span>steka iz deskriptora novoaktivirane niti</span></code></pre></div>
</section>
<section id="swap-4" class="slide level2">
<h2>Swap</h2>
<div class="sourceCode" id="cb66"><pre class="sourceCode gnuassembler"><code class="sourceCode gnuassembler"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>    frstorl <span class="op">(%</span>esp<span class="op">)</span>  <span class="op">//</span>sa novog steka se preuzmu novi sadrzaji</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>                <span class="op">//</span>registara numerickog koprocesora</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    add i387_SAVE_REGION_SIZE<span class="op">,%</span>esp</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    popa        <span class="op">//</span>sa novog steka se preuzima sadrzaj</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>            <span class="op">//</span>registara opste namene</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    popf        <span class="op">//</span>sa novog steka se preuzima sadrzaj</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">//</span>status registara flags</span></code></pre></div>
</section>
<section id="swap-5" class="slide level2">
<h2>Swap</h2>
<div class="sourceCode" id="cb67"><pre class="sourceCode gnuassembler"><code class="sourceCode gnuassembler"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>    pop <span class="op">%</span>eax</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    mov <span class="op">%</span>eax<span class="op">,</span>interrupts_enabled <span class="op">//</span>sa novog steka se preuzme</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                    <span class="op">//</span>sadrzaj bita prekida i frejm</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>                    <span class="op">//</span>pointera</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    popl <span class="op">%</span>ebp</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    ret</span></code></pre></div>
</section></section>
    </div>
  </div>

  <script src="https://unpkg.com/reveal.js@^4//dist/reveal.js"></script>

  <!-- reveal.js plugins -->
  <script src="https://unpkg.com/reveal.js@^4//plugin/notes/notes.js"></script>
  <script src="https://unpkg.com/reveal.js@^4//plugin/search/search.js"></script>
  <script src="https://unpkg.com/reveal.js@^4//plugin/zoom/zoom.js"></script>
  <script src="https://unpkg.com/reveal.js@^4//plugin/math/math.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
        // Display controls in the bottom right corner
        controls: true,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: true,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'bottom-right',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: false,

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: false,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: false,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: true,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'default',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: true,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'slide',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'fade',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [
          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    </body>
</html>
